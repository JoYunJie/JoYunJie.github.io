<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>TheCherno æ¸¸æˆå¼•æ“ç³»åˆ— 45-Shader Library</title>
      <link href="/2024/08/13/TheCherno-%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E%E7%B3%BB%E5%88%97-45-Shader-Library/"/>
      <url>/2024/08/13/TheCherno-%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E%E7%B3%BB%E5%88%97-45-Shader-Library/</url>
      
        <content type="html"><![CDATA[<hr><h1 id="TheCherno-æ¸¸æˆå¼•æ“ç³»åˆ—-45-Shader-Library"><a href="#TheCherno-æ¸¸æˆå¼•æ“ç³»åˆ—-45-Shader-Library" class="headerlink" title="TheCherno æ¸¸æˆå¼•æ“ç³»åˆ— 45-Shader Library"></a>TheCherno æ¸¸æˆå¼•æ“ç³»åˆ— 45-Shader Library</h1><p>23å¹´åœ¨çµçŠ€æ¸¸æˆå¼•æ“å²—å®ä¹ çš„æ—¶å€™ï¼Œè¿˜æ²¡æœ‰å¯¹æ¸¸æˆå¼•æ“æœ‰ç³»ç»Ÿçš„å­¦ä¹ ï¼Œä¸ºäº†å¼¥è¡¥å®è·µç»éªŒä¸Šçš„ä¸è¶³ï¼Œä»Šå¹´2æœˆè·Ÿç€Chernoæ¸¸æˆå¼•æ“ç³»åˆ—æ–­æ–­ç»­ç»­ç åˆ°ç°åœ¨ï¼Œåˆšå¥½æœ€è¿‘å¼€äº†è‡ªå·±åšå®¢ï¼Œä¹‹åè·Ÿç€åšå¼•æ“çš„ç¬”è®°ä¼šè®°å½•åœ¨è¿™é‡Œï¼ˆ1-44çš„éƒ¨åˆ†æœ‰æ—¶é—´å†è¡¥ä¸€ä¸‹ï¼Œä½†æˆ‘æ„Ÿè§‰é©¬ä¸Šç ”ä¸€åº”è¯¥æ²¡å•¥æ—¶é—´äº†ï¼Œæµæ±—ğŸ˜“ï¼‰</p><hr><h2 id="æè¦"><a href="#æè¦" class="headerlink" title="æè¦"></a>æè¦</h2><p>åˆ›å»ºShader Libraryä¸»è¦æ˜¯ä¸ºäº†å°†å¸¸ç”¨çš„Shaderå­˜å‚¨åœ¨ä¸€ä¸ªæ•°æ®ç»“æ„ä¸­ï¼Œæ–¹ä¾¿è°ƒç”¨ï¼Œä¸ç„¶æ¯æ¬¡åœ¨SandBoxAppä¸­è°ƒç”¨Shaderéƒ½éœ€è¦åˆ›å»ºå¹¶ç»‘å®šæŒºéº»çƒ¦çš„ã€‚</p><h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><p>ä¸ºäº†æ–¹ä¾¿æŸ¥æ‰¾å¯¹åº”Shaderï¼Œæˆ‘ä»¬ä½¿ç”¨unordered_mapæ¥å­˜å‚¨Shaderï¼Œæ ¹æ®Shaderçš„åå­—æ¥æŸ¥æ‰¾å¯¹åº”Shaderã€‚</p><p>è¿™é‡Œæˆ‘ä»¬ç»™Shaderæ–°å¢ä¸€ä¸ªè™šå‡½æ•°GetNameç”¨äºè·å–åç§°ï¼Œå¹¶ä¿®æ”¹æ„é€ å‡½æ•°ï¼Œå¹¶åˆ›å»ºShaderLibraryç±»ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;glm/glm.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> Jie &#123;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Shader</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="type">const</span> std::string&amp; <span class="title">GetName</span><span class="params">()</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="type">static</span> Ref&lt;Shader&gt; <span class="title">Create</span><span class="params">(<span class="type">const</span> std::string&amp; name, <span class="type">const</span> std::string&amp; vertexSrc, <span class="type">const</span> std::string&amp; fragmentSrc)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ShaderLibrary</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Add</span><span class="params">(<span class="type">const</span> std::string&amp; name, <span class="type">const</span> Ref&lt;Shader&gt;&amp; shader)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Add</span><span class="params">(<span class="type">const</span> Ref&lt;Shader&gt;&amp; shader)</span></span>;</span><br><span class="line"><span class="function">Ref&lt;Shader&gt; <span class="title">Load</span><span class="params">(<span class="type">const</span> std::string&amp; filepath)</span></span>;</span><br><span class="line"><span class="function">Ref&lt;Shader&gt; <span class="title">Load</span><span class="params">(<span class="type">const</span> std::string&amp; name, <span class="type">const</span> std::string&amp; filepath)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">Ref&lt;Shader&gt; <span class="title">Get</span><span class="params">(<span class="type">const</span> std::string&amp; name)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Exists</span><span class="params">(<span class="type">const</span> std::string&amp; name)</span> <span class="type">const</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">std::unordered_map&lt;std::string, Ref&lt;Shader&gt;&gt; m_Shaders;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Refæ˜¯è‡ªå®šä¹‰çš„Shared_ptrçš„åˆ«å</span></span><br><span class="line"><span class="comment">//ä»£ç å¾ˆç®€å•å°±ä¸ä¸€ä¸€è§£é‡Šäº†</span></span><br><span class="line"><span class="function">Ref&lt;Shader&gt; <span class="title">Shader::Create</span><span class="params">(<span class="type">const</span> std::string&amp; name, <span class="type">const</span> std::string&amp; vertexSrc, <span class="type">const</span> std::string&amp; fragmentSrc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (Renderer::<span class="built_in">GetAPI</span>())</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> RendererAPI::API::None:    <span class="built_in">JIE_CORE_ASSERT</span>(<span class="literal">false</span>, <span class="string">&quot;RendererAPI::None is currently not supported!&quot;</span>); <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">case</span> RendererAPI::API::OpenGL:  <span class="keyword">return</span> <span class="built_in">CreateRef</span>&lt;OpenGLShader&gt;(name, vertexSrc, fragmentSrc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">JIE_CORE_ASSERT</span>(<span class="literal">false</span>, <span class="string">&quot;Unknown RendererAPI!&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ShaderLibrary::Add</span><span class="params">(<span class="type">const</span> std::string&amp; name, <span class="type">const</span> Ref&lt;Shader&gt;&amp; shader)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">JIE_CORE_ASSERT</span>(!<span class="built_in">Exists</span>(name), <span class="string">&quot;Shader already exists!&quot;</span>);</span><br><span class="line">m_Shaders[name] = shader;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ShaderLibrary::Add</span><span class="params">(<span class="type">const</span> Ref&lt;Shader&gt;&amp; shader)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">auto</span>&amp; name = shader-&gt;<span class="built_in">GetName</span>();</span><br><span class="line"><span class="built_in">Add</span>(name, shader);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Ref&lt;Shader&gt; <span class="title">ShaderLibrary::Load</span><span class="params">(<span class="type">const</span> std::string&amp; filepath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">auto</span> shader = Shader::<span class="built_in">Create</span>(filepath);</span><br><span class="line"><span class="built_in">Add</span>(shader);</span><br><span class="line"><span class="keyword">return</span> shader;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Ref&lt;Shader&gt; <span class="title">ShaderLibrary::Load</span><span class="params">(<span class="type">const</span> std::string&amp; name, <span class="type">const</span> std::string&amp; filepath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">auto</span> shader = Shader::<span class="built_in">Create</span>(filepath);</span><br><span class="line"><span class="built_in">Add</span>(name, shader);</span><br><span class="line"><span class="keyword">return</span> shader;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Ref&lt;Shader&gt; <span class="title">ShaderLibrary::Get</span><span class="params">(<span class="type">const</span> std::string&amp; name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">JIE_CORE_ASSERT</span>(<span class="built_in">Exists</span>(name), <span class="string">&quot;Shader not found!&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> m_Shaders[name];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ShaderLibrary::Exists</span><span class="params">(<span class="type">const</span> std::string&amp; name)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> m_Shaders.<span class="built_in">find</span>(name) != m_Shaders.<span class="built_in">end</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨OpenGLShader.hä¸­override GetNameå‡½æ•°ï¼Œå¹¶æ–°å¢å±æ€§m_Nameï¼Œä¿®æ”¹æ„é€ å‡½æ•°ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> Jie &#123;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OpenGLShader</span>:<span class="keyword">public</span> Shader</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="built_in">OpenGLShader</span>(<span class="type">const</span> std::string&amp; filepath);</span><br><span class="line"><span class="built_in">OpenGLShader</span>(<span class="type">const</span> std::string&amp; name, <span class="type">const</span> std::string&amp; vertexSrc, <span class="type">const</span> std::string&amp; fragmentSrc);</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="type">const</span> std::string&amp; <span class="title">GetName</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> m_Name; &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">...</span><br><span class="line">std::string m_Name;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">OpenGLShader::<span class="built_in">OpenGLShader</span>(<span class="type">const</span> std::string&amp; filepath) : <span class="built_in">m_FilePath</span>(filepath)</span><br><span class="line">&#123;</span><br><span class="line">    std::string source = <span class="built_in">ReadFile</span>(filepath);</span><br><span class="line">    <span class="keyword">auto</span> shaderSources = <span class="built_in">PreProcess</span>(source);</span><br><span class="line">    <span class="built_in">Compile</span>(shaderSources);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Extract name from filepath</span></span><br><span class="line">    <span class="comment">//æ‰¾åˆ°æœ€åä¸€ä¸ª\æˆ–è€…/</span></span><br><span class="line">    <span class="keyword">auto</span> lastSlash = filepath.<span class="built_in">find_last_of</span>(<span class="string">&quot;/\\&quot;</span>);</span><br><span class="line">    <span class="comment">//å¦‚æœæ²¡æœ‰ï¼Œbeginè®¾ç½®ä¸º0ï¼Œåä¹‹ä¸ºæœ€åä¸€ä¸ªæ‰¾åˆ°çš„ä½ç½®</span></span><br><span class="line">    lastSlash = lastSlash == std::string::npos ? <span class="number">0</span> : lastSlash + <span class="number">1</span>;</span><br><span class="line">    <span class="comment">//ä»å³æŸ¥æ‰¾ä¹Ÿå°±æ˜¯æœ€åä¸€ä¸ª.ä½ç½®</span></span><br><span class="line">    <span class="keyword">auto</span> lastDot = filepath.<span class="built_in">rfind</span>(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">    <span class="comment">//å¦‚æœæ²¡æœ‰å°±æ˜¯lastSlashä¹‹åå‰©ä½™å­—ç¬¦ä¸²é•¿åº¦ï¼Œåä¹‹ç›¸å‡å¯å¾—</span></span><br><span class="line">    <span class="keyword">auto</span> count = lastDot == std::string::npos ? filepath.<span class="built_in">size</span>() - lastSlash : lastDot - lastSlash;</span><br><span class="line">    m_Name = filepath.<span class="built_in">substr</span>(lastSlash, count);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">OpenGLShader::<span class="built_in">OpenGLShader</span>(<span class="type">const</span> std::string&amp; name, <span class="type">const</span> std::string&amp; vertexSrc, <span class="type">const</span> std::string&amp; fragmentSrc):<span class="built_in">m_Name</span>(name)</span><br><span class="line">&#123;</span><br><span class="line">    std::unordered_map&lt;GLenum, std::string&gt; sources;</span><br><span class="line">    sources[GL_VERTEX_SHADER] = vertexSrc;</span><br><span class="line">    sources[GL_FRAGMENT_SHADER] = fragmentSrc;</span><br><span class="line">    <span class="built_in">Compile</span>(sources);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ååœ¨SandBoxApp.cppä¸­æˆ‘ä»¬å¯ä»¥åˆ é™¤å­˜å‚¨çš„Shaderå±æ€§ï¼Œæ”¹ç”¨ShaderLibraryæ¥å­˜å‚¨éœ€è¦çš„Shaderï¼Œå¹¶é€šè¿‡åå­—ç´¢å¼•è°ƒç”¨ã€‚</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">m_ShaderLibrary.<span class="built_in">Load</span>(<span class="string">&quot;default&quot;</span>, <span class="string">&quot;assets/shader/default.glsl&quot;</span>);</span><br><span class="line">m_ShaderLibrary.<span class="built_in">Load</span>(<span class="string">&quot;default2&quot;</span>, <span class="string">&quot;assets/shader/default2.glsl&quot;</span>);</span><br><span class="line">m_ShaderLibrary.<span class="built_in">Load</span>(<span class="string">&quot;textureShader&quot;</span>, <span class="string">&quot;assets/shader/textureShader.glsl&quot;</span>);</span><br><span class="line"></span><br><span class="line">m_Texture = Jie::Texture2D::<span class="built_in">Create</span>(<span class="string">&quot;assets/textures/awesomeface.png&quot;</span>);</span><br><span class="line">m_Texture2 = Jie::Texture2D::<span class="built_in">Create</span>(<span class="string">&quot;assets/textures/awesomeface.png&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> tex_Shader = m_ShaderLibrary.<span class="built_in">Get</span>(<span class="string">&quot;textureShader&quot;</span>);</span><br><span class="line">tex_Shader-&gt;<span class="built_in">Bind</span>();</span><br><span class="line">tex_Shader-&gt;<span class="built_in">setInt</span>(<span class="string">&quot;u_Texture&quot;</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>è¿è¡Œæ•ˆæœæ­£å¸¸ã€‚</p><img src="/2024/08/13/TheCherno-%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E%E7%B3%BB%E5%88%97-45-Shader-Library/image-20240813222935400.png" alt="image-20240813222935400" style="zoom:67%;"><h2 id="è¡¥å……"><a href="#è¡¥å……" class="headerlink" title="è¡¥å……"></a>è¡¥å……</h2><p>åœ¨44èŠ‚Shader Asset Filesä¸­ï¼Œç¼–è¯‘Shaderéƒ¨åˆ†ï¼ŒTheChernoæœ¬äººæŒ‡å‡ºä¸€ä¸ªé”™è¯¯ï¼Œä¿®æ”¹å¦‚å›¾æ‰€ç¤º</p><p><img src="/2024/08/13/TheCherno-%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E%E7%B3%BB%E5%88%97-45-Shader-Library/image-20240813223221797.png" alt="image-20240813223221797"></p><p>æŒ‰ç…§44èŠ‚å†™æ³•ï¼Œé¦–å…ˆåˆ›å»ºå›ºå®šé•¿åº¦çš„vectorå†push_backä¼šå¯¼è‡´æ–°æ’å…¥çš„itemä¼šåœ¨æœ«å°¾æ’å…¥ï¼Œè€Œä¸æ˜¯ç¬¬1ä¸€ä¸ªå¼€å§‹ï¼Œå¯¼è‡´åé¢å¯èƒ½ä¼šdeleteæ— æ•ˆçš„shaderId</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> id : glShaderIDs)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">glDeleteShader</span>(id);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>è§£å†³æ–¹å¼æ˜¯ä½¿ç”¨reverseå‡½æ•°ï¼Œæˆ–è€…è¿™é‡Œä¿®æ”¹ä¸ºäº†array</p><p>æµ‹è¯•ä»£ç å¦‚ä¸‹</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vector&lt;<span class="type">int</span>&gt; myvector;</span><br><span class="line">myvector.<span class="built_in">reserve</span>(<span class="number">2</span>);</span><br><span class="line">myvector.<span class="built_in">push_back</span>(<span class="number">3</span>);</span><br><span class="line">cout &lt;&lt; myvector.<span class="built_in">size</span>() &lt;&lt; endl;</span><br><span class="line"><span class="comment">//è¾“å‡º1</span></span><br><span class="line"></span><br><span class="line"><span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">myvector</span><span class="params">(<span class="number">2</span>)</span></span>;</span><br><span class="line">myvector.<span class="built_in">push_back</span>(<span class="number">3</span>);</span><br><span class="line">cout &lt;&lt; myvector.<span class="built_in">size</span>() &lt;&lt; endl;</span><br><span class="line"><span class="comment">//è¾“å‡º3</span></span><br></pre></td></tr></table></figure><hr>]]></content>
      
      
      <categories>
          
          <category> Game Engine </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸¸æˆå¼•æ“ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Unity è§†åŸŸåˆ†ææ•ˆæœ</title>
      <link href="/2024/08/11/Unity-%E8%A7%86%E5%9F%9F%E5%88%86%E6%9E%90%E6%95%88%E6%9E%9C/"/>
      <url>/2024/08/11/Unity-%E8%A7%86%E5%9F%9F%E5%88%86%E6%9E%90%E6%95%88%E6%9E%9C/</url>
      
        <content type="html"><![CDATA[<hr><h1 id="Unity-è§†åŸŸåˆ†ææ•ˆæœ"><a href="#Unity-è§†åŸŸåˆ†ææ•ˆæœ" class="headerlink" title="Unity è§†åŸŸåˆ†ææ•ˆæœ"></a>Unity è§†åŸŸåˆ†ææ•ˆæœ</h1><p>æœ€è¿‘å› ä¸ºåœ¨æè€å¸ˆçš„æ¨ªå‘ä»»åŠ¡ï¼Œå…¶ä¸­éœ€æ±‚ä¹‹ä¸€æ˜¯å¯¹unityæ­å»ºçš„åœºæ™¯å¯¹è¿›è¡Œè§†åŸŸåˆ†æï¼Œå› ä¸ºåœ¨ç½‘ä¸Šæ‰¾ä¸åˆ°ç›¸å…³èµ„æ–™ï¼Œæ‰€ä»¥è‡ªå·±ç®€å•å®ç°äº†ä¸€ä¸‹ï¼Œå¹¶å†™åœ¨è¿™ç¯‡åšå®¢è®°å½•ä¸€ä¸‹å®ç°æ–¹å¼ã€‚</p><h2 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h2><p>åŠŸèƒ½éœ€æ±‚æ˜¯è¦æ±‚ä»åœºæ™¯ä¸­ä»»æ„ä¸€ç‚¹å‡ºå‘ï¼Œå°†è¯¥ç‚¹è§†åŸŸèŒƒå›´å†…çš„åœºæ™¯ï¼ˆç†è§£ä¸ºåœ¨è¯¥ç‚¹ç›¸æœºè£å‰ªç©ºé—´ä¸­çš„åœºæ™¯ï¼‰è¿›è¡Œç€è‰²ï¼Œèƒ½è¢«è¯¥ç‚¹è§‚å¯Ÿåˆ°çš„åœºæ™¯å˜æˆç»¿è‰²ï¼Œä¸èƒ½è¢«è§‚å¯Ÿåˆ°çš„åœºæ™¯å˜æˆçº¢è‰²ï¼Œå…¶ä½™ä¿æŒåŸè‰²ï¼Œæ•ˆæœå›¾å¦‚ä¸‹ï¼š</p><img src="/2024/08/11/Unity-%E8%A7%86%E5%9F%9F%E5%88%86%E6%9E%90%E6%95%88%E6%9E%9C/image-20240811190905199.png" alt="image-20240811190905199" style="zoom:50%;"><h2 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><p>æˆ‘åˆšå¼€å§‹æœ‰ä¸¤ä¸ªæ€è·¯ï¼š</p><ol><li>æ ¹æ®æŠ•å½±çº¹ç†æ˜ å°„ï¼ˆ<a href="https://www.nvidia.com/en-us/drivers/Projective-Texture-Mapping/">Projective Texture Mapping|NVIDIA</a>ï¼‰å®ç°ï¼Œé¦–å…ˆå°†æ¨¡å‹é¡¶ç‚¹ä»æ¨¡å‹ç©ºé—´å˜æ¢åˆ°å±å¹•ç©ºé—´ï¼Œè®¡ç®—å‡ºè¢«æŠ•å½±çš„åŒºåŸŸï¼Œè®¾ç½®ä¸ºç»¿è‰²ï¼Œå…¶ä½™å˜æ¢åˆ°è£å‰ªç©ºé—´ï¼Œåœ¨è£å‰ªç©ºé—´å†…æ²¡è¢«æŠ•å½±çš„åŒºåŸŸï¼Œè®¾ç½®ä¸ºçº¢è‰²</li><li>ç±»ä¼¼Shadow Mapçš„æ€æƒ³ï¼Œä»è§†åŸŸç‚¹çš„ç›¸æœºæ¸²æŸ“ä¸€å¼ æ·±åº¦å›¾Dï¼Œç„¶åè®¡ç®—è§‚å¯Ÿç›¸æœºä¸­æ¯ä¸ªç‚¹Aä¸è§†åŸŸç›¸æœºçš„è·ç¦»dï¼Œå¦‚æœæ·±åº¦å›¾ä¸­ç‚¹Aå¯¹åº”çš„æ·±åº¦depth&lt;dï¼Œè¯´æ˜ç‚¹Aä¸èƒ½è¢«çœ‹åˆ°ï¼Œåº”è¯¥è®¾ç½®ä¸ºçº¢è‰²ï¼›åä¹‹è®¾ç½®ä¸ºç»¿è‰²ã€‚</li></ol><p>æ„Ÿè§‰ä¸¤ä¸ªæ–¹æ¡ˆå·®ä¸å¤šï¼Œè¿™é‡Œæˆ‘é€‰æ‹©ç¬¬äºŒä¸ªæ–¹æ¡ˆæ¥å®ç°ã€‚</p><h2 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h2><p>æˆ‘ä½¿ç”¨çš„æ˜¯Unity 2020.3.48f1c1ç‰ˆæœ¬ã€‚</p><h3 id="æ·±åº¦å›¾"><a href="#æ·±åº¦å›¾" class="headerlink" title="æ·±åº¦å›¾"></a>æ·±åº¦å›¾</h3><p>é¦–å…ˆæˆ‘ä»¬è·å–ç‚¹Aå‡ºå‘çš„æ·±åº¦å›¾ã€‚</p><p>åˆ›å»ºä¸€å¼ RenderTextureï¼Œå‘½åä¸ºDepthTexï¼Œå¹¶è®¾ç½®ä¸ºè§†åŸŸç›¸æœºçš„Target Textureï¼Œç„¶ååˆ›å»ºè„šæœ¬CaptureDepth.cs</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CaptureDepth</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> Camera depthCamera;  <span class="comment">// éœ€è¦åœ¨Inspectorä¸­è®¾ç½®</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//è·å–è‡ªèº«Cameraç»„ä»¶</span></span><br><span class="line">        depthCamera = GetComponent&lt;Camera&gt;();</span><br><span class="line">        <span class="comment">// è®¾ç½®ç›®æ ‡ç›¸æœºçš„depthTextureModeä¸ºDepth</span></span><br><span class="line">        depthCamera.depthTextureMode = DepthTextureMode.Depth;</span><br><span class="line">        depthCamera.targetTexture.format = RenderTextureFormat.Depth;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åˆ›å»ºç®€å•çš„UnLitæè´¨ï¼Œç„¶åå°†DepthTexèµ‹å€¼ç»™æè´¨MainTexï¼Œåˆ›å»ºç®€å•åœºæ™¯å¦‚ä¸‹</p><img src="/2024/08/11/Unity-%E8%A7%86%E5%9F%9F%E5%88%86%E6%9E%90%E6%95%88%E6%9E%9C/image-20240811195151204.png" alt="image-20240811195151204" style="zoom: 80%;"><p>å°†æè´¨æ‹–æ‹½ç»™æ–°å»ºçš„Planeï¼ŒéªŒè¯æˆ‘ä»¬ç¡®å®è·å–åˆ°äº†åœºæ™¯æ·±åº¦å›¾</p><img src="/2024/08/11/Unity-%E8%A7%86%E5%9F%9F%E5%88%86%E6%9E%90%E6%95%88%E6%9E%9C/image-20240811195248206.png" alt="image-20240811195248206" style="zoom: 50%;"><p>ä½†æ˜¯æ·±åº¦å›¾ä¸€èˆ¬æ˜¯å°†åœºæ™¯æ·±åº¦å˜æ¢åˆ°[0,1]ï¼Œä¸”è¶Šè¿‘çš„ç‰©ä½“æ·±åº¦è¶Šå°ï¼Œé¢œè‰²æ›´é»‘ï¼Œè¶Šè¿œçš„ç‰©ä½“æ·±åº¦è¶Šå¤§ï¼Œé¢œè‰²è¶Šç™½ï¼Œè¿™é‡Œè·å–çš„æ·±åº¦å›¾è¿›è¡Œäº†ä¸€ä¸ªé€†æ·±åº¦å˜æ¢ã€‚</p><p>æ­£å¸¸æ·±åº¦å›¾è®¡ç®—æ˜¯æ ¹æ®å¦‚ä¸‹å…¬å¼ï¼Œå°†çº¿æ€§æ·±åº¦è½¬æ¢ä¸º[0,1]çš„éçº¿æ€§ç©ºé—´æ·±åº¦<br>$$<br>F_{depth} &#x3D; \frac{\frac{1}{z}-\frac{1}{near}}{\frac{1}{far}-\frac{1}{near}}<br>$$<br>è¿™é‡Œunityè¿›è¡Œçš„é€†æ·±åº¦å˜æ¢ï¼Œåº”è¯¥æ˜¯è¿™ä¹ˆè®¡ç®—çš„ï¼ˆæˆ‘å¼€å§‹åªæ˜¯çŒœæµ‹ï¼Œåæ¥æµ‹è¯•è¯æ˜ç¡®å®å¦‚æ­¤ï¼‰ï¼Œä¹Ÿå°±æ˜¯ç”¨$\frac{1}{far}$å‡å»$\frac{1}{z}$ä»£æ›¿äº†$\frac{1}{z}$å‡å»$\frac{1}{near}$<br>$$<br>F_{depth} &#x3D; \frac{\frac{1}{far}-\frac{1}{z}}{\frac{1}{far}-\frac{1}{near}}<br>$$<br>å› æ­¤æˆ‘ä»¬åœ¨ç€è‰²å™¨ä¸­å¢åŠ ä¸€ä¸ªå‡½æ•°ï¼Œå°†æ·±åº¦ä»éçº¿æ€§ç©ºé—´è½¬æ¢åˆ°ä¸–ç•Œç©ºé—´ä¸‹çš„çº¿æ€§æ·±åº¦</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span> MyLinearEyeDepth(<span class="type">float</span> depth)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> (_Far * _Near)/(_Near - depth * (_Near - _Far));</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><h3 id="ç©ºé—´å˜æ¢"><a href="#ç©ºé—´å˜æ¢" class="headerlink" title="ç©ºé—´å˜æ¢"></a>ç©ºé—´å˜æ¢</h3><p>æˆ‘ä»¬å¾—åˆ°æ·±åº¦å›¾ï¼Œå¹¶è·å¾—ä¸–ç•Œç©ºé—´ä¸‹çš„çº¿æ€§æ·±åº¦åï¼Œæˆ‘ä»¬è¦å°†åœºæ™¯ç‚¹åˆ°è§†åŸŸç›¸æœºçš„è·ç¦»å’Œæ·±åº¦åšå¯¹æ¯”ï¼Œè¿™éœ€è¦ï¼š1. å°†åœºæ™¯ç‚¹å˜æ¢åˆ°è§†åŸŸç›¸æœºçš„å±å¹•ç©ºé—´ä¸Šè·å–æ·±åº¦å€¼ï¼›2. è®¡ç®—åœºæ™¯ç‚¹ä¸–ç•Œç©ºé—´ä¸‹ä½ç½®ï¼Œæ–¹ä¾¿è®¡ç®—è·ç¦»ï¼Œè¿™éœ€è¦ç”¨åˆ°è‹¥å¹²ç©ºé—´å˜æ¢çŸ©é˜µï¼ŒçŸ©é˜µè®¾ç½®è„šæœ¬å¦‚ä¸‹</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CaptureDepth</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (material != <span class="literal">null</span> &amp;&amp; depthCamera != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//è·å–å˜æ¢çŸ©é˜µ</span></span><br><span class="line">            Matrix4x4 viewMatrix = depthCamera.worldToCameraMatrix;</span><br><span class="line">            Matrix4x4 projectionMatrix = depthCamera.projectionMatrix;</span><br><span class="line">            Matrix4x4 InvprojectionMatrix = projectionMatrix.inverse;</span><br><span class="line">            Matrix4x4 viewportMatrix = Matrix4x4.identity;</span><br><span class="line">            viewportMatrix.m00 = <span class="number">0.5f</span>;</span><br><span class="line">            viewportMatrix.m11 = <span class="number">0.5f</span>;</span><br><span class="line">            viewportMatrix.m03 = <span class="number">0.5f</span>;</span><br><span class="line">            viewportMatrix.m13 = <span class="number">0.5f</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//å°†çŸ©é˜µä¼ é€’ç»™æè´¨</span></span><br><span class="line">            material.SetMatrix(<span class="string">&quot;_ViewMatrix&quot;</span>, viewMatrix);</span><br><span class="line">            material.SetMatrix(<span class="string">&quot;_ProjectionMatrix&quot;</span>, projectionMatrix);</span><br><span class="line">            material.SetMatrix(<span class="string">&quot;_InvProjectionMatrix&quot;</span>, InvprojectionMatrix);</span><br><span class="line">            material.SetMatrix(<span class="string">&quot;_ViewportMatrix&quot;</span>, viewportMatrix);</span><br><span class="line">            material.SetTexture(<span class="string">&quot;_CameraDepthTex&quot;</span>, depthCamera.targetTexture);</span><br><span class="line">            <span class="comment">//è®¾ç½®è¿œè¿‘è£å‰ªå¹³é¢</span></span><br><span class="line">            material.SetFloat(<span class="string">&quot;_Near&quot;</span>, depthCamera.nearClipPlane);</span><br><span class="line">            material.SetFloat(<span class="string">&quot;_Far&quot;</span>, depthCamera.farClipPlane);</span><br><span class="line">            material.SetVector(<span class="string">&quot;_CameraPos&quot;</span>, depthCamera.transform.position);</span><br><span class="line">            material.SetVector(<span class="string">&quot;_CameraForwardVector&quot;</span>, depthCamera.transform.forward.normalized);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ªæ–°shaderå¦‚ä¸‹</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Custom/DepthProjectionShader&quot;</span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        _MainTex (&quot;Texture&quot;, <span class="number">2</span>D) = &quot;white&quot; &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Tags &#123; &quot;RenderType&quot;=&quot;Opaque&quot; &#125;</span><br><span class="line">        LOD <span class="number">200</span></span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">            <span class="meta">#pragma vertex vert</span></span><br><span class="line">            <span class="meta">#pragma fragment frag</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#include &quot;UnityCG.cginc&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="type">sampler2D</span> _MainTex;</span><br><span class="line">            <span class="type">sampler2D</span> _CameraDepthTex;</span><br><span class="line"></span><br><span class="line">            <span class="type">float</span> _Near;</span><br><span class="line">            <span class="type">float</span> _Far;</span><br><span class="line">            float4 _CameraPos;</span><br><span class="line">            float4 _CameraForwardVector;</span><br><span class="line"></span><br><span class="line">            float4x4 _ViewMatrix;</span><br><span class="line">            float4x4 _ProjectionMatrix;</span><br><span class="line">            float4x4 _ViewportMatrix;</span><br><span class="line">            float4x4 _InvprojectionMatrix;</span><br><span class="line"></span><br><span class="line">            struct appdata</span><br><span class="line">            &#123;</span><br><span class="line">                float4 vertex : POSITION;</span><br><span class="line">                float2 uv : TEXCOORD0;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            struct v2f</span><br><span class="line">            &#123;</span><br><span class="line">                float2 uv : TEXCOORD0;</span><br><span class="line">                float4 vertex : SV_POSITION;</span><br><span class="line">                float4 screenPos : TEXCOORD1;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            v2f vert (appdata v)</span><br><span class="line">            &#123;</span><br><span class="line">                v2f o;</span><br><span class="line">                float4 worldPos = mul(unity_ObjectToWorld, v.vertex);</span><br><span class="line">                float4 viewPos = mul(_ViewMatrix, worldPos);</span><br><span class="line">                float4 projPos = mul(_ProjectionMatrix, viewPos);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Perspective divide to get normalized device coordinates (NDC)</span></span><br><span class="line">                projPos /= projPos.w;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Transform NDC to screen space</span></span><br><span class="line">                o.screenPos = mul(_ViewportMatrix, projPos);</span><br><span class="line">                o.vertex = UnityObjectToClipPos(v.vertex);</span><br><span class="line">                o.uv = v.uv;</span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">float</span> MyLinearEyeDepth(<span class="type">float</span> depth)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> (_Far * _Near)/(_Near - depth * (_Near - _Far));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            fixed4 frag (v2f i) : SV_Target</span><br><span class="line">            &#123;</span><br><span class="line">                fixed4 col = tex2D(_MainTex, i.uv) * _Tint;</span><br><span class="line">                <span class="comment">//è·å–åœºæ™¯ä¸­ä¸€ç‚¹å¯¹åº”è§†åŸŸç›¸æœºçš„æ·±åº¦ä¿¡æ¯</span></span><br><span class="line">                <span class="type">float</span> depth = MyLinearEyeDepth(tex2D(_CameraDepthTex, i.screenPos.xy).r);</span><br><span class="line">                <span class="comment">//è·å–è·ç¦»è§†åŸŸç›¸æœºç»å¯¹è·ç¦»</span></span><br><span class="line">                <span class="type">float</span> dis = <span class="built_in">dot</span>(i.worldPos - _CameraPos.xyz,  _CameraForwardVector);</span><br><span class="line"><span class="type">float</span> abs_dis = <span class="built_in">abs</span>(dis);</span><br><span class="line">                <span class="keyword">return</span> float4(depth, depth, depth, <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    FallBack &quot;Diffuse&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è®¡ç®—é¢œè‰²"><a href="#è®¡ç®—é¢œè‰²" class="headerlink" title="è®¡ç®—é¢œè‰²"></a>è®¡ç®—é¢œè‰²</h3><p>è·å–è·ç¦»å’Œæ·±åº¦åï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹è®¡ç®—é¢œè‰²äº†ï¼Œæœ€ç»ˆShaderå¦‚ä¸‹</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Custom/DepthProjectionShader&quot;</span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">        _MainTex (&quot;Texture&quot;, <span class="number">2</span>D) = &quot;white&quot; &#123;&#125;</span><br><span class="line">        _Tint (&quot;BaseColor&quot;, Color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        _Strength (&quot;Strength&quot;, Range(<span class="number">0</span>, <span class="number">100</span>)) = <span class="number">1.0</span></span><br><span class="line">        _VisableColor (&quot;VisableColor&quot;, Color) = (<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">        _UnVisableColor (&quot;UnVisableColor&quot;, Color) = (<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">        _DeltaOffset (&quot;DepthDeltaOffset&quot;, Range(<span class="number">0</span>, <span class="number">100</span>)) = <span class="number">1</span></span><br><span class="line">        <span class="comment">//ç”¨Toggleæ§åˆ¶æ˜¯å¦å°†èƒŒéƒ¨é¢ç‰‡è®¾ç½®ä¸ºä¸å¯è§ï¼ˆåŠ ä¸Šè¿™ä¸ªä¸»è¦æ˜¯é˜²æ­¢æ·±åº¦ä¿®æ­£å€¼ï¼‰</span></span><br><span class="line">        [Toggle(_BACKFACE_UNVIS)] _Backface_UnVisable (&quot;Backface_UnVisable&quot;, Float) = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Tags &#123; &quot;RenderType&quot;=&quot;Opaque&quot; &#125;</span><br><span class="line">        LOD <span class="number">200</span></span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            HLSLPROGRAM</span><br><span class="line">            <span class="meta">#pragma shader_feature _BACKFACE_UNVIS </span></span><br><span class="line">            <span class="meta">#pragma vertex vert</span></span><br><span class="line">            <span class="meta">#pragma fragment frag</span></span><br><span class="line"></span><br><span class="line">            <span class="meta">#include &quot;UnityCG.cginc&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="type">sampler2D</span> _MainTex;</span><br><span class="line">            <span class="type">sampler2D</span> _CameraDepthTex;</span><br><span class="line">            float4 _Tint;</span><br><span class="line">            <span class="type">float</span> _Strength;</span><br><span class="line">            float4 _VisableColor;</span><br><span class="line">            float4 _UnVisableColor;</span><br><span class="line">            <span class="type">float</span> _DeltaOffset;</span><br><span class="line"></span><br><span class="line">            <span class="type">float</span> _Near;</span><br><span class="line">            <span class="type">float</span> _Far;</span><br><span class="line">            float4 _CameraPos;</span><br><span class="line">            float4 _CameraForwardVector;</span><br><span class="line"></span><br><span class="line">            float4x4 _ViewMatrix;</span><br><span class="line">            float4x4 _ProjectionMatrix;</span><br><span class="line">            float4x4 _ViewportMatrix;</span><br><span class="line">            float4x4 _InvprojectionMatrix;</span><br><span class="line"></span><br><span class="line">            struct appdata</span><br><span class="line">            &#123;</span><br><span class="line">                float4 vertex : POSITION;</span><br><span class="line">                float3 normal : NORMAL;</span><br><span class="line">                float2 uv : TEXCOORD0;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            struct v2f</span><br><span class="line">            &#123;</span><br><span class="line">                float2 uv : TEXCOORD0;</span><br><span class="line">                float4 vertex : SV_POSITION;</span><br><span class="line">                float4 screenPos : TEXCOORD1;</span><br><span class="line">                float4 worldPos : TEXCOORD2;</span><br><span class="line">                float3 worldNormal : TEXCOORD3;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            v2f vert (appdata v)</span><br><span class="line">            &#123;</span><br><span class="line">                v2f o;</span><br><span class="line">                float4 worldPos = mul(unity_ObjectToWorld, v.vertex);</span><br><span class="line">                float4 viewPos = mul(_ViewMatrix, worldPos);</span><br><span class="line">                float4 projPos = mul(_ProjectionMatrix, viewPos);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Perspective divide to get normalized device coordinates (NDC)</span></span><br><span class="line">                projPos /= projPos.w;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Transform NDC to screen space</span></span><br><span class="line">                o.screenPos = mul(_ViewportMatrix, projPos);</span><br><span class="line">                o.worldPos = worldPos;</span><br><span class="line">                o.worldNormal = mul(unity_ObjectToWorld, v.normal);</span><br><span class="line">                o.vertex = UnityObjectToClipPos(v.vertex);</span><br><span class="line">                o.uv = v.uv;</span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">float</span> MyLinearEyeDepth(<span class="type">float</span> depth)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> (_Far * _Near)/(_Near - depth * (_Near - _Far));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            fixed4 frag (v2f i) : SV_Target</span><br><span class="line">            &#123;</span><br><span class="line">                fixed4 col = tex2D(_MainTex, i.uv) * _Tint;</span><br><span class="line">                <span class="type">float</span> depth = MyLinearEyeDepth(tex2D(_CameraDepthTex, i.screenPos.xy).r);</span><br><span class="line">                <span class="type">float</span> dis = <span class="built_in">dot</span>(i.worldPos - _CameraPos.xyz,  _CameraForwardVector);</span><br><span class="line">                <span class="type">float</span> abs_dis = <span class="built_in">abs</span>(dis);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//åœ¨å±å¹•ç©ºé—´å¤–å°±æ˜¯æ¨¡å‹æœ¬èº«è´´å›¾é¢œè‰²</span></span><br><span class="line">                <span class="keyword">if</span>(i.screenPos.x &lt; <span class="number">0</span> || i.screenPos.x &gt; <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> col;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(i.screenPos.y &lt; <span class="number">0</span> || i.screenPos.y &gt; <span class="number">1</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> col;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//return float4(depth, depth, depth, 1);</span></span><br><span class="line">                </span><br><span class="line">                <span class="meta">#if defined(_BACKFACE_UNVIS)</span></span><br><span class="line">                <span class="comment">//å¦‚æœé¢ç‰‡æ³•çº¿å’Œæ‘„åƒæœºæ–¹å‘åå‘ï¼Œè¯´æ˜åœ¨æ¨¡å‹èƒŒéƒ¨ä¸èƒ½è¢«çœ‹è§ï¼ˆåŠ ä¸Šè¿™ä¸ªä¸»è¦æ˜¯é˜²æ­¢æ·±åº¦ä¿®æ­£å€¼ï¼‰</span></span><br><span class="line">                    <span class="type">float</span> face = <span class="built_in">dot</span>(i.worldNormal , _CameraForwardVector);</span><br><span class="line">                    <span class="keyword">if</span>(face &gt; <span class="number">0.1</span>)</span><br><span class="line">                    &#123;    </span><br><span class="line">                        <span class="keyword">return</span> _UnVisableColor * col * _Strength;</span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="meta">#endif</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//å› ä¸ºä¸‰è§’å½¢æ’å€¼å¯¼è‡´æ·±åº¦ä¸è·ç¦»æ¯”è¾ƒä¼šå‡ºç°ä¸æ­£ç¡®çš„ç°è±¡ï¼Œæ‰€ä»¥è¿™é‡ŒåŠ ä¸Šä¿®æ­£å€¼</span></span><br><span class="line">                <span class="keyword">if</span>(abs_dis &gt; depth + _DeltaOffset)</span><br><span class="line">                    <span class="keyword">return</span> _UnVisableColor * col * _Strength;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="keyword">return</span> _VisableColor * col * _Strength;</span><br><span class="line">            &#125;</span><br><span class="line">            ENDHLSL</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    FallBack &quot;Diffuse&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>å› ä¸ºä¸‰è§’å½¢æ’å€¼å¯¼è‡´æ·±åº¦ä¸è·ç¦»æ¯”è¾ƒä¼šå‡ºç°ä¸æ­£ç¡®çš„ç°è±¡å¦‚ä¸‹ï¼ˆå…·ä½“åŸå› æœ‰ç©ºå†è¿›ä¸€æ­¥åˆ†æï¼‰</p><img src="/2024/08/11/Unity-%E8%A7%86%E5%9F%9F%E5%88%86%E6%9E%90%E6%95%88%E6%9E%9C/image-20240811204651739.png" alt="image-20240811204651739" style="zoom:67%;"><h3 id="æœ€ç»ˆæ•ˆæœ"><a href="#æœ€ç»ˆæ•ˆæœ" class="headerlink" title="æœ€ç»ˆæ•ˆæœ"></a>æœ€ç»ˆæ•ˆæœ</h3><p>è§†åŸŸç›¸æœºæ­£é¢å›¾</p><img src="/2024/08/11/Unity-%E8%A7%86%E5%9F%9F%E5%88%86%E6%9E%90%E6%95%88%E6%9E%9C/image-20240811204730364.png" alt="image-20240811204730364" style="zoom:67%;"><p>è‡ªç”±è§†è§’è§‚å¯Ÿå›¾</p><img src="/2024/08/11/Unity-%E8%A7%86%E5%9F%9F%E5%88%86%E6%9E%90%E6%95%88%E6%9E%9C/image-20240811204837608.png" alt="image-20240811204837608" style="zoom: 80%;"><p>æˆ‘è½¦çš„è®¡ç®—æœºæ¥¼æ¨¡å‹æµ‹è¯•</p><img src="/2024/08/11/Unity-%E8%A7%86%E5%9F%9F%E5%88%86%E6%9E%90%E6%95%88%E6%9E%9C/image-20240811205516471.png" alt="image-20240811205516471" style="zoom:80%;">]]></content>
      
      
      <categories>
          
          <category> æ¸¸æˆå¼€å‘ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸¸æˆå¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Unityä¸­é€ ä¸€ä¸ªPBRæè´¨</title>
      <link href="/2024/08/07/Unity%E4%B8%AD%E9%80%A0%E4%B8%80%E4%B8%AAPBR%E6%9D%90%E8%B4%A8/"/>
      <url>/2024/08/07/Unity%E4%B8%AD%E9%80%A0%E4%B8%80%E4%B8%AAPBR%E6%9D%90%E8%B4%A8/</url>
      
        <content type="html"><![CDATA[<hr><h1 id="Unityä¸­é€ ä¸€ä¸ªPBRæè´¨"><a href="#Unityä¸­é€ ä¸€ä¸ªPBRæè´¨" class="headerlink" title="Unityä¸­é€ ä¸€ä¸ªPBRæè´¨"></a>Unityä¸­é€ ä¸€ä¸ªPBRæè´¨</h1><p>æœ€è¿‘åœ¨çœ‹NEILFå’ŒRelightable 3DGSï¼Œä»å¤šè§†å›¾å›¾åƒä¸­åˆ†è§£å‡ºæè´¨å’Œå…‰ç…§ï¼Œä»¥å®ç°åœºæ™¯é‡ç…§æ˜ã€‚å…¶ä¸­æè´¨åˆ†è§£éƒ½æ˜¯åŸºäºè¿ªå£«å°¼çš„ç»å…¸BRDFæ¨¡å‹ï¼Œå› æ­¤æƒ³ç€å¤ä¹ ä¸€ä¸‹PBRæè´¨ç›¸å…³çŸ¥è¯†ï¼Œåˆšå¥½åœ¨çŸ¥ä¹çœ‹åˆ°ä¸€ç¯‡ä¸é”™çš„åšå®¢ï¼ˆé“¾æ¥æ”¾æœ€åäº†ï¼‰ï¼Œäºæ˜¯åŠ¨æ‰‹è·Ÿç€å¤ç°ä¸€ä¸‹ã€‚</p><h2 id="æ¸²æŸ“æ–¹ç¨‹"><a href="#æ¸²æŸ“æ–¹ç¨‹" class="headerlink" title="æ¸²æŸ“æ–¹ç¨‹"></a>æ¸²æŸ“æ–¹ç¨‹</h2><p>$$<br>L_o\left(p, w_o\right)&#x3D;\int_{\Omega}\left(k_d \frac{c}{\pi}+k_s \frac{D G F}{4\left(w_o \cdot n\right)\left(w_i \cdot n\right)}\right) L_i\left(p, w_i\right)\left(w_i \cdot n\right) d w_i<br>$$</p><p>å¦‚ä¸Šæ˜¯ä¸€ä¸ªæ¸²æŸ“æ–¹ç¨‹ï¼ˆä¸åŒ…å«è‡ªå‘å…‰ï¼‰ï¼Œå‰åŠéƒ¨åˆ†$k_d\frac{c}{\pi}$è¡¨ç¤ºæ¼«åå°„è´¡çŒ®å€¼ï¼ŒååŠéƒ¨åˆ†æ˜¯é•œé¢åå°„è´¡çŒ®å€¼ï¼Œå…¶ä¸­<strong>Dæ˜¯æ³•çº¿åˆ†å¸ƒé¡¹</strong>ï¼Œç”¨äºè®¡ç®—æœ‰å¤šå°‘æ¯”ä¾‹æ»¡è¶³åå°„ä¹‹åçš„å…‰çº¿ä¸è§†çº¿å¹³è¡Œï¼›<strong>Gæ˜¯é˜´å½±-é®æ©é¡¹</strong>ï¼Œè¡¨ç¤ºæ»¡è¶³Dé¡¹å‰æä¸‹ï¼Œå»é™¤ç”±äºå¾®è¡¨é¢ç›¸äº’é®æŒ¡å¯¼è‡´å…‰çº¿ä¸èƒ½åå°„åˆ°äººçœ¼çš„éƒ¨åˆ†åï¼Œå‰©ä½™èƒ½è¢«çœ‹åˆ°çš„æ¯”ä¾‹ï¼›<strong>Fæ˜¯è²æ¶…å°”åå°„é¡¹</strong>ï¼Œè¡¨ç¤ºäº†åå°„å…‰çº¿å å…¥å°„å…‰çº¿çš„æ¯”ä¾‹ï¼Œå› ä¸ºè¿˜æœ‰éƒ¨åˆ†å…‰çº¿ä¼šæŠ˜å°„è¿›å…¥ç‰©ä½“å†…éƒ¨ã€‚</p><p>è¿™ä¸ªæ–¹ç¨‹è¡¨ç¤ºäº†ç›´æ¥å…‰ç…§å’Œé—´æ¥å…‰ç…§ï¼ˆiblï¼‰ï¼šç›´æ¥å…‰æ¼«åå°„ï¼Œç›´æ¥å…‰é•œé¢åå°„ï¼Œé—´æ¥å…‰æ¼«åå°„ï¼Œé—´æ¥å…‰é•œé¢åå°„ã€‚æ¥ä¸‹æ¥å°†ä¾æ¬¡å®ç°è¿™å››ä¸ªéƒ¨åˆ†ã€‚</p><h2 id="ShaderåŸºæœ¬æ¡†æ¶"><a href="#ShaderåŸºæœ¬æ¡†æ¶" class="headerlink" title="ShaderåŸºæœ¬æ¡†æ¶"></a>ShaderåŸºæœ¬æ¡†æ¶</h2><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Common/MyPBR&quot;</span><br><span class="line">&#123;</span><br><span class="line">Properties</span><br><span class="line">&#123;</span><br><span class="line">_MainTex(&quot;Texture&quot;, <span class="number">2</span>D) = &quot;white&quot; &#123;&#125;</span><br><span class="line">_Tint(&quot;Tint&quot;, Color) = (<span class="number">1</span> ,<span class="number">1</span> ,<span class="number">1</span> ,<span class="number">1</span>)</span><br><span class="line">[Gamma] _Metallic(&quot;Metallic&quot;, Range(<span class="number">0</span>, <span class="number">1</span>)) = <span class="number">0</span> <span class="comment">//é‡‘å±åº¦éœ€è¦ä¼½é©¬æ ¡æ­£</span></span><br><span class="line">_Smoothness(&quot;Smoothness&quot;, Range(<span class="number">0</span>, <span class="number">1</span>)) = <span class="number">0.5</span></span><br><span class="line">_LUT(&quot;LUT&quot;, <span class="number">2</span>D) = &quot;white&quot; &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SubShader</span><br><span class="line">&#123;</span><br><span class="line">Tags &#123; &quot;RenderType&quot; = &quot;Opaque&quot; &#125;</span><br><span class="line">LOD <span class="number">100</span></span><br><span class="line"></span><br><span class="line">Pass</span><br><span class="line">&#123;</span><br><span class="line">Tags &#123;</span><br><span class="line">&quot;LightMode&quot; = &quot;ForwardBase&quot;</span><br><span class="line">&#125;</span><br><span class="line">CGPROGRAM</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma target 3.0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma vertex vert</span></span><br><span class="line"><span class="meta">#pragma fragment frag</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#include &quot;UnityStandardBRDF.cginc&quot; </span></span><br><span class="line"></span><br><span class="line">struct appdata</span><br><span class="line">&#123;</span><br><span class="line">float4 vertex : POSITION;</span><br><span class="line">float3 normal : NORMAL;</span><br><span class="line">float2 uv : TEXCOORD0;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct v2f</span><br><span class="line">&#123;</span><br><span class="line">float4 vertex : SV_POSITION;</span><br><span class="line">float2 uv : TEXCOORD0;</span><br><span class="line">float3 normal : TEXCOORD1;</span><br><span class="line">float3 worldPos : TEXCOORD2;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">float4 _Tint;</span><br><span class="line"><span class="type">float</span> _Metallic;</span><br><span class="line"><span class="type">float</span> _Smoothness;</span><br><span class="line"><span class="type">sampler2D</span> _MainTex;</span><br><span class="line">float4 _MainTex_ST;</span><br><span class="line"><span class="type">sampler2D</span> _LUT;</span><br><span class="line"></span><br><span class="line">v2f vert(appdata v)</span><br><span class="line">&#123;</span><br><span class="line">v2f o;</span><br><span class="line">o.vertex = UnityObjectToClipPos(v.vertex);</span><br><span class="line">o.worldPos = mul(unity_ObjectToWorld, v.vertex);</span><br><span class="line">o.uv = TRANSFORM_TEX(v.uv, _MainTex);</span><br><span class="line">o.normal = UnityObjectToWorldNormal(v.normal);</span><br><span class="line">o.normal = <span class="built_in">normalize</span>(o.normal);</span><br><span class="line"><span class="keyword">return</span> o;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fixed4 frag(v2f i) : SV_Target</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//ç›´æ¥å…‰æ¼«åå°„</span></span><br><span class="line">float3 diffColor = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//ç›´æ¥å…‰é•œé¢åå°„</span></span><br><span class="line">float3 specColor = <span class="number">0</span>;</span><br><span class="line">float3 DirectLightResult = diffColor + specColor;</span><br><span class="line"></span><br><span class="line"><span class="comment">//é—´æ¥å…‰æ¼«åå°„</span></span><br><span class="line">float3 iblDiffuseResult = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//é—´æ¥å…‰é•œé¢åå°„</span></span><br><span class="line">float3 iblSpecularResult = <span class="number">0</span>;</span><br><span class="line">float3 IndirectResult = iblDiffuseResult + iblSpecularResult;</span><br><span class="line"></span><br><span class="line">float4 result = float4(DirectLightResult + IndirectResult, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ENDCG</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„é‡‘å±-ç²—ç³™å·¥ä½œæµï¼Œ_Metallicæ˜¯é‡‘å±åº¦ï¼Œ_Smoothnessæ˜¯å…‰æ»‘åº¦ï¼ˆç²—ç³™åº¦ä¸å…‰æ»‘åº¦ç›¸å¯¹ï¼Œä¸€èˆ¬å–åï¼‰ï¼Œ<u>_LUTæ˜¯ä¸€å¼ ä½œä¸ºæŸ¥æ‰¾è¡¨çš„è´´å›¾</u>ã€‚</p><p>å› ä¸ºé‡‘å±åº¦è¿™ä¸ªå€¼æ˜¯ç”¨äºä¼½é©¬ç©ºé—´çš„ï¼Œåœ¨è¿™é‡ŒåŠ [Gamma]å°±æ˜¯å‘Šè¯‰Unityè¿™ä¸ªå€¼ä¹Ÿè¦å’Œè´´å›¾ä¸€æ ·åœ¨ä½¿ç”¨å‰ä»ä¼½é©¬ç©ºé—´è½¬æ¢åˆ°çº¿æ€§ç©ºé—´ä¸­ã€‚</p><p>å¼•å…¥UnityStandardBRDF.cgincæ˜¯Unity PBRå®ç°çš„æ ¸å¿ƒæ–‡ä»¶ã€‚</p><h2 id="æ­å»ºå¯¹æ¯”åœºæ™¯"><a href="#æ­å»ºå¯¹æ¯”åœºæ™¯" class="headerlink" title="æ­å»ºå¯¹æ¯”åœºæ™¯"></a>æ­å»ºå¯¹æ¯”åœºæ™¯</h2><p>ä¸ºäº†å¯¹æ¯”æ•ˆæœï¼Œæˆ‘ä»¬å‡†å¤‡å¦‚ä¸‹Shaderã€‚</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Common/PBS&quot;</span><br><span class="line">&#123;</span><br><span class="line">    Properties</span><br><span class="line">    &#123;</span><br><span class="line">_Tint (&quot;Tint&quot;, Color) = (<span class="number">1</span> ,<span class="number">1</span> ,<span class="number">1</span> ,<span class="number">1</span>)</span><br><span class="line">_MainTex (&quot;Texture&quot;, <span class="number">2</span>D) = &quot;white&quot; &#123;&#125;</span><br><span class="line">[Gamma] _Metallic(&quot;Metallic&quot;, Range(<span class="number">0</span>, <span class="number">1</span>)) = <span class="number">0</span></span><br><span class="line">_Smoothness(&quot;Smoothness&quot;, Range(<span class="number">0</span>, <span class="number">1</span>)) = <span class="number">0.5</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SubShader</span><br><span class="line">    &#123;</span><br><span class="line">        Tags &#123; &quot;RenderType&quot;=&quot;Opaque&quot; &#125;</span><br><span class="line">        LOD <span class="number">100</span></span><br><span class="line"></span><br><span class="line">        Pass</span><br><span class="line">        &#123;</span><br><span class="line">Tags &#123;</span><br><span class="line">&quot;LightMode&quot; = &quot;ForwardBase&quot;</span><br><span class="line">&#125;</span><br><span class="line">            CGPROGRAM</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma target 3.0</span></span><br><span class="line"><span class="meta">#pragma multi_compile_instancing</span></span><br><span class="line"><span class="meta">#pragma vertex vert</span></span><br><span class="line"><span class="meta">#pragma fragment frag</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#include &quot;UnityPBSLighting.cginc&quot;</span></span><br><span class="line"></span><br><span class="line">            float4 _Tint;</span><br><span class="line"><span class="type">float</span> _Metallic;</span><br><span class="line"><span class="type">float</span> _Smoothness;</span><br><span class="line">            <span class="type">sampler2D</span> _MainTex;</span><br><span class="line">            float4 _MainTex_ST;</span><br><span class="line"></span><br><span class="line">            struct appdata</span><br><span class="line">            &#123;</span><br><span class="line">                float4 vertex : POSITION;</span><br><span class="line">float3 normal : NORMAL;</span><br><span class="line">                float2 uv : TEXCOORD0;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            struct v2f</span><br><span class="line">            &#123;</span><br><span class="line">                float4 vertex : SV_POSITION;</span><br><span class="line">float2 uv : TEXCOORD0;</span><br><span class="line">float3 normal : TEXCOORD1;</span><br><span class="line">float3 worldPos : TEXCOORD2;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            v2f vert (appdata v)</span><br><span class="line">            &#123;</span><br><span class="line">                v2f o;</span><br><span class="line">                o.vertex = UnityObjectToClipPos(v.vertex);</span><br><span class="line">o.worldPos = mul(unity_ObjectToWorld, v.vertex);</span><br><span class="line">                o.uv = TRANSFORM_TEX(v.uv, _MainTex);</span><br><span class="line">o.normal = UnityObjectToWorldNormal(v.normal);</span><br><span class="line">o.normal = <span class="built_in">normalize</span>(o.normal);</span><br><span class="line">                <span class="keyword">return</span> o;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            fixed4 frag (v2f i) : SV_Target</span><br><span class="line">            &#123;</span><br><span class="line">i.normal = <span class="built_in">normalize</span>(i.normal);</span><br><span class="line">float3 lightDir = _WorldSpaceLightPos0.xyz;</span><br><span class="line">float3 viewDir = <span class="built_in">normalize</span>(_WorldSpaceCameraPos - i.worldPos);</span><br><span class="line">float3 lightColor = _LightColor0.rgb;</span><br><span class="line"></span><br><span class="line">float3 specularTint;</span><br><span class="line"><span class="type">float</span> oneMinusReflectivity;</span><br><span class="line">float3 albedo = tex2D(_MainTex, i.uv).rgb * _Tint.rgb;</span><br><span class="line"><span class="comment">// ä»é‡‘å±åº¦ç”Ÿæˆæ¼«åå°„é¢œè‰²ï¼Œé•œé¢åå°„é¢œè‰²ç­‰</span></span><br><span class="line">albedo = DiffuseAndSpecularFromMetallic(albedo, _Metallic, specularTint, oneMinusReflectivity);</span><br><span class="line"></span><br><span class="line">UnityLight light;</span><br><span class="line">light.color = lightColor;</span><br><span class="line">light.dir = lightDir;</span><br><span class="line">light.ndotl = DotClamped(i.normal, lightDir);</span><br><span class="line">UnityIndirect indirectLight;</span><br><span class="line">indirectLight.diffuse = <span class="number">0</span>;</span><br><span class="line">indirectLight.specular = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> UNITY_BRDF_PBS( <span class="comment">//ç”Ÿæˆç›´æ¥å…‰pbrç»“æœ</span></span><br><span class="line">albedo, specularTint,</span><br><span class="line">oneMinusReflectivity, _Smoothness,</span><br><span class="line">i.normal, viewDir,</span><br><span class="line">light, indirectLight</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            ENDCG</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºé¿å…åˆ›é€ å¤šä¸ªæè´¨ï¼Œæˆ‘ä»¬å†™ä¸€ä¸ªé…ç½®æè´¨å±æ€§çš„è„šæœ¬ï¼ŒæŒ‚è½½åˆ°æ¯ä¸ªçƒä½“ä¸Šï¼Œæ–¹ä¾¿æ§åˆ¶å±æ€§</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line">[<span class="meta">DisallowMultipleComponent</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PerObjectMaterialProperties</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">int</span> tintId = Shader.PropertyToID(<span class="string">&quot;_Tint&quot;</span>),</span><br><span class="line">        metallicId = Shader.PropertyToID(<span class="string">&quot;_Metallic&quot;</span>),</span><br><span class="line">        smoothnessId = Shader.PropertyToID(<span class="string">&quot;_Smoothness&quot;</span>);</span><br><span class="line"></span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    Color tintColor = Color.white;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">SerializeField, Range(0f, 1f)</span>]</span><br><span class="line">    <span class="built_in">float</span> metallic = <span class="number">0f</span>, smoothness = <span class="number">0.5f</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> MaterialPropertyBlock block;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        OnValidate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnValidate</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (block == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            block = <span class="keyword">new</span> MaterialPropertyBlock();</span><br><span class="line">        &#125;</span><br><span class="line">        block.SetColor(tintId, tintColor);</span><br><span class="line">        block.SetFloat(metallicId, metallic);</span><br><span class="line">        block.SetFloat(smoothnessId, smoothness);</span><br><span class="line">        GetComponent&lt;Renderer&gt;().SetPropertyBlock(block);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†æ–¹å‘å…‰è®¾ç½®ä¸ºè“è‰²ï¼Œæˆ‘ä»¬å¾—åˆ°å¦‚ä¸‹æ•ˆæœ</p><p><img src="/2024/08/07/Unity%E4%B8%AD%E9%80%A0%E4%B8%80%E4%B8%AAPBR%E6%9D%90%E8%B4%A8/image-20240808141600897.png" alt="image-20240808141600897"></p><h2 id="å‡†å¤‡"><a href="#å‡†å¤‡" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h2><p>ç°åœ¨æŠŠåé¢ä¼šç”¨åˆ°çš„åŸºæœ¬ä¿¡æ¯å†™å¥½</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span> Square (<span class="type">float</span> v) &#123;</span><br><span class="line"><span class="keyword">return</span> v * v;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fixed4 frag(v2f i) : SV_Target</span><br><span class="line">&#123;</span><br><span class="line">i.normal = <span class="built_in">normalize</span>(i.normal);</span><br><span class="line">float3 lightDir = <span class="built_in">normalize</span>(_WorldSpaceLightPos0.xyz);</span><br><span class="line">float3 viewDir = <span class="built_in">normalize</span>(_WorldSpaceCameraPos.xyz - i.worldPos.xyz);</span><br><span class="line">float3 lightColor = _LightColor0.rgb;</span><br><span class="line">float3 halfVector = <span class="built_in">normalize</span>(lightDir + viewDir);  <span class="comment">//åŠè§’å‘é‡</span></span><br><span class="line"></span><br><span class="line"><span class="type">float</span> perceptualRoughness = <span class="number">1</span> - _Smoothness;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> roughness = Square(perceptualRoughness);</span><br><span class="line"><span class="type">float</span> squareRoughness = Square(roughness);</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> nl = <span class="built_in">max</span>(saturate(<span class="built_in">dot</span>(i.normal, lightDir)), <span class="number">0.000001</span>);<span class="comment">//é˜²æ­¢é™¤0</span></span><br><span class="line"><span class="type">float</span> nv = <span class="built_in">max</span>(saturate(<span class="built_in">dot</span>(i.normal, viewDir)), <span class="number">0.000001</span>);</span><br><span class="line"><span class="type">float</span> vh = <span class="built_in">max</span>(saturate(<span class="built_in">dot</span>(viewDir, halfVector)), <span class="number">0.000001</span>);</span><br><span class="line"><span class="type">float</span> lh = <span class="built_in">max</span>(saturate(<span class="built_in">dot</span>(lightDir, halfVector)), <span class="number">0.000001</span>);</span><br><span class="line"><span class="type">float</span> nh = <span class="built_in">max</span>(saturate(<span class="built_in">dot</span>(i.normal, halfVector)), <span class="number">0.000001</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç›´æ¥å…‰æ¼«åå°„</span></span><br><span class="line">float3 diffColor = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//ç›´æ¥å…‰é•œé¢åå°„</span></span><br><span class="line">float3 specColor = <span class="number">0</span>;</span><br><span class="line">float3 DirectLightResult = diffColor + specColor;</span><br><span class="line"></span><br><span class="line"><span class="comment">//é—´æ¥å…‰æ¼«åå°„</span></span><br><span class="line">float3 iblDiffuseResult = <span class="number">0</span>;</span><br><span class="line"><span class="comment">//é—´æ¥å…‰é•œé¢åå°„</span></span><br><span class="line">float3 iblSpecularResult = <span class="number">0</span>;</span><br><span class="line">float3 IndirectResult = iblDiffuseResult + iblSpecularResult;</span><br><span class="line"></span><br><span class="line">float4 result = float4(DirectLightResult + IndirectResult, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å€¼å¾—æ³¨æ„çš„æ˜¯è¿™äº›å‘é‡éƒ½è¦è¢«Clampä¸€ä¸‹é˜²æ­¢é™¤0çš„æƒ…å†µå‡ºç°ã€‚</p><h2 id="ç›´æ¥å…‰æ¼«åå°„"><a href="#ç›´æ¥å…‰æ¼«åå°„" class="headerlink" title="ç›´æ¥å…‰æ¼«åå°„"></a>ç›´æ¥å…‰æ¼«åå°„</h2><p>$Lambert$æ¨¡å‹å°±æ˜¯æœ€ç®€å•ä¹Ÿæ˜¯åº”ç”¨æœ€å¹¿æ³›çš„æ¼«åå°„BRDFï¼Œå‡†ç¡®çš„$Lamvertian BRDF$è¡¨ç¤ºä¸ºï¼š<br>$$<br>f_{Lambert}(l,v)&#x3D;\frac{c_{diff}}{\pi}<br>$$<br>å…¶ä¸­$c_{diff}$è¡¨ç¤ºæ¼«åå°„å…‰çº¿æ‰€å æ¯”ä¾‹ï¼Œé€šå¸¸è¢«æˆä¸ºæ¼«åå°„é¢œè‰²ï¼Œä¸Šé¢å¼å­å…¶å®æ˜¯ä¸€ä¸ªå®šå€¼ã€‚ä¹‹æ‰€ä»¥é™¤ä»¥$\pi$æ˜¯å› ä¸ºæˆ‘ä»¬å‡è®¾æ¼«åå°„åœ¨æ‰€æœ‰æ–¹å‘ä¸Šçš„å¼ºåº¦éƒ½æ˜¯ç›¸åŒçš„ï¼Œè€ŒBRDFè¦æ±‚åœ¨åŠçƒå†…ç§¯åˆ†å€¼æ˜¯1ã€‚</p><p><img src="/2024/08/07/Unity%E4%B8%AD%E9%80%A0%E4%B8%80%E4%B8%AAPBR%E6%9D%90%E8%B4%A8/image-20240808143839387.png" alt="image-20240808143839387"></p><ul><li>å®Œå…¨ä¸å¸æ”¶èƒ½é‡$f&#x3D;\frac{1}{\pi}$</li></ul><p>ç»™å®šå…¥å°„æ–¹å‘å…‰lçš„å…‰æºåœ¨è¡¨é¢æŸç‚¹çš„å‡ºå°„æ¼«åå°„è¾å°„ç‡ä¸ºï¼š<br>$$<br>f_{Lambert}(l,v)&#x3D;\frac{c_{diff}}{\pi}L_i(l)(n\cdot l)<br>$$</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Diffuse term</span></span><br><span class="line">    half diffuseTerm = DisneyDiffuse(nv, nl, lh, perceptualRoughness) * nl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Specular term</span></span><br><span class="line">    <span class="comment">// <span class="doctag">HACK:</span> theoretically we should divide diffuseTerm by Pi and not multiply specularTerm!</span></span><br><span class="line">    <span class="comment">// BUT 1) that will make shader look significantly darker than Legacy ones</span></span><br><span class="line">    <span class="comment">// and 2) on engine side &quot;Non-important&quot; lights have to be divided by Pi too in cases when they are injected into ambient SH</span></span><br></pre></td></tr></table></figure><p>UnityStandardBRDF.cgincä¸­å†™é“è¿™é‡Œè¦æ˜¯é™¤ä»¥Piï¼Œä¼šä½¿ç€è‰²å™¨çœ‹èµ·æ¥æ¯”ä¼ ç»Ÿçš„æš—å¾ˆå¤šï¼Œè€Œä¸”å½“â€œéé‡è¦â€å…‰æºæ³¨å…¥åˆ°ç¯å¢ƒ SH æ—¶ï¼Œå…ˆé™¤ä»¥äº† Piã€‚</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç›´æ¥å…‰æ¼«åå°„</span></span><br><span class="line"><span class="type">float</span> kd = <span class="number">1</span>;</span><br><span class="line">float3 Albedo = _Tint * tex2D(_MainTex, i.uv);</span><br><span class="line">float3 diffColor = kd * Albedo * lightColor * nl;</span><br></pre></td></tr></table></figure><p><img src="/2024/08/07/Unity%E4%B8%AD%E9%80%A0%E4%B8%80%E4%B8%AAPBR%E6%9D%90%E8%B4%A8/image-20240808152057366.png" alt="image-20240808152057366"></p><h2 id="ç›´æ¥å…‰é•œé¢åå°„"><a href="#ç›´æ¥å…‰é•œé¢åå°„" class="headerlink" title="ç›´æ¥å…‰é•œé¢åå°„"></a>ç›´æ¥å…‰é•œé¢åå°„</h2><p>é•œé¢åå°„çš„BRDFå…¬å¼å¦‚ä¸‹ï¼š<br>$$<br>f_{spec}(l,v)&#x3D;\frac{F(l,h)G(l,v,h)D(h)}{4(n\cdot l)(n\cdot v)}<br>$$<br>å…¶ä¸­$4(n\cdot l)(n\cdot v)$æ˜¯ç”¨äºæ ¡æ­£ä»å¾®é¢å…ƒå±€éƒ¨ç©ºé—´åˆ°æ•´ä½“å®è§‚è¡¨é¢æ•°é‡å·®å¼‚çš„çŸ«æ­£å› å­ã€‚</p><p><strong>æˆ‘ä»¬å…ˆæ¥çœ‹Dé¡¹ã€‚</strong></p><p>Dé¡¹ä½¿ç”¨çš„$Trowbridge-Reitz GGX$æ¨¡å‹ï¼Œå…¶ä¸­$\alpha$æ˜¯è¡¨é¢ç²—ç³™åº¦ã€‚è¿™é‡Œé™åˆ¶ç²—ç³™åº¦æœ€å°å€¼ä¸º0.002ï¼Œä¿è¯å®Œå…¨å¹³æ»‘ä¹Ÿä¼šæœ‰é«˜å…‰ï¼Œä¸ä¼šå°†é«˜å…‰åå°„ç‚¹å˜å¾—æå°è€Œè§‚å¯Ÿä¸åˆ°</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span> lerpSquareRoughness = <span class="built_in">pow</span>(lerp(<span class="number">0.002</span>, <span class="number">1</span>, roughness), <span class="number">2</span>);<span class="comment">//é™åˆ¶ç²—ç³™åº¦æœ€å°å€¼ä¸º0.002ï¼Œä¿è¯å®Œå…¨å¹³æ»‘ä¹Ÿä¼šæœ‰é«˜å…‰ï¼Œä¸ä¼šå°†é«˜å…‰åå°„ç‚¹å˜å¾—æå°è€Œè§‚å¯Ÿä¸åˆ°</span></span><br><span class="line"><span class="type">float</span> D = lerpSquareRoughness / (<span class="built_in">pow</span>((<span class="built_in">pow</span>(nh, <span class="number">2</span>) * (lerpSquareRoughness - <span class="number">1</span>) + <span class="number">1</span>), <span class="number">2</span>) * UNITY_PI);</span><br></pre></td></tr></table></figure><p><strong>ç„¶åæ˜¯Gé¡¹ã€‚</strong></p><p><img src="/2024/08/07/Unity%E4%B8%AD%E9%80%A0%E4%B8%80%E4%B8%AAPBR%E6%9D%90%E8%B4%A8/image-20240808154946542.png" alt="image-20240808154946542"></p><p>Gé¡¹åœ¨ã€ŠUnity Shaderå…¥é—¨ç²¾è¦ã€‹è¿™æœ¬ä¹¦ä¸Šé‡‡ç”¨çš„å…¬å¼æ˜¯GGXè¡ç”Ÿå‡ºçš„$Smith-Schlick$æ¨¡å‹ï¼š<br>$$<br>G(l,v,h)&#x3D;\frac{1}{((n\cdot l)(1-k)+k)((n\cdot v)(1-k)+k)}<br>$$<br>å…¶ä¸­$k&#x3D;\frac{roughness^2}{2}$ï¼Œ</p><p>ä½†æ˜¯å‚è€ƒåšå®¢é‡‡ç”¨çš„å…¬å¼å’ŒNEILFä½¿ç”¨çš„å…¬å¼è€ƒè™‘äº†å…‰çº¿åœ¨å…¥å°„æ—¶ä¼šè¿›è¡Œä¸€æ¬¡ä»¥å…‰çº¿æ–¹å‘lä¸ºå‚æ•°çš„é®è”½ï¼Œå‡ºå°„æ—¶ä¼šè¿›è¡Œä¸€æ¬¡ä»¥è§†çº¿æ–¹å‘vä¸ºå‚æ•°çš„é®è”½ï¼Œå…¬å¼å¦‚ä¸‹ï¼š<br>$$<br>G(l,v,h) &#x3D; \frac{n\cdot l}{lerp(n\cdot l,1,k)} \times \frac{n\cdot v}{lerp(n\cdot v,1,k)}<br>$$<br>å…¬å¼åˆ†æ¯å±•å¼€è·Ÿ$Smith-Schlick$æ¨¡å‹ä¸‹åŠéƒ¨åˆ†ä¸€æ ·ï¼Œåªæ˜¯åˆ†å­éƒ¨åˆ†è€ƒè™‘äº†å…¥å°„å‡ºå°„åˆ†æƒ…å†µè®¨è®ºï¼Œå…¶ä¸­ç›´æ¥å…‰ç…§æ—¶$k&#x3D;\frac{(\alpha + 1)^2}{8}$ï¼Œé—´æ¥å…‰ç…§æ—¶$k&#x3D;\frac{\alpha ^2}{2}$</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span> kDL = <span class="built_in">pow</span>(squareRoughness + <span class="number">1</span>, <span class="number">2</span>) / <span class="number">8</span>;</span><br><span class="line"><span class="type">float</span> kIBL = <span class="built_in">pow</span>(squareRoughness, <span class="number">2</span>) / <span class="number">2</span>;</span><br><span class="line"><span class="type">float</span> GLeft = nl / lerp(nl, <span class="number">1</span>, kDL);</span><br><span class="line"><span class="type">float</span> GRight = nv / lerp(nv, <span class="number">1</span>, kDL);</span><br><span class="line"><span class="type">float</span> G = GLeft * GRight;</span><br></pre></td></tr></table></figure><p><strong>æœ€åæ˜¯Fé¡¹</strong>ã€‚</p><p>è²æ¶…å°”æ–¹ç¨‹æè¿°çš„æ˜¯è¢«åå°„çš„å…‰çº¿å¯¹æ¯”å…‰çº¿è¢«æŠ˜å°„çš„éƒ¨åˆ†æ‰€å çš„æ¯”ç‡ã€‚</p><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨å›¾å½¢å­¦å¸¸ç”¨çš„$Schlick Fresnel$è¿‘ä¼¼ç­‰å¼ï¼š<br>$$<br>F(l,h) &#x3D; F_0+(1-F_0)(1-l\cdot h)^5<br>$$<br>å‚è€ƒæ–‡ç« ä½¿ç”¨çš„æ˜¯è™šå¹»å¼•æ“ç”¨çš„æ‹Ÿåˆç‰ˆæœ¬ï¼Œå› ä¸ºé‡‡ç”¨exp2å‡½æ•°ï¼Œæ‰€ä»¥è®¡ç®—æ•ˆç‡ä¼šå¿«ä¸€äº›ï¼Œè¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨å¸¸ç”¨çš„å…¬å¼ã€‚</p><p>å…¶æ¬¡ï¼Œæ–¹ç¨‹ä¸­çš„F0ç†è®ºä¸Šæ˜¯å¹³é¢çš„åŸºç¡€åå°„ç‡ï¼Œç”±äºè²æ¶…å°”æ–¹ç¨‹åªå¯¹éé‡‘å±æœ‰æ•ˆï¼Œåœ¨è¡¨é¢ä¸ºé‡‘å±æ—¶éœ€è¦ç”¨åˆ°è·Ÿé‡‘å±è¡¨é¢é¢œè‰²ç›¸å…³çš„å¦ä¸€ä¸ªæ–¹ç¨‹ï¼Œå› æ­¤è¿™é‡Œå¼•å…¥é‡‘å±åº¦å‚æ•°è¿›è¡Œè®¡ç®—</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">float3 F0 = lerp(unity_ColorSpaceDielectricSpec.rgb, Albedo, _Metallic);</span><br></pre></td></tr></table></figure><p>ã€å‚è€ƒåšå®¢åŸè¯ï¼šè¿™é‡Œæœ€å¤§çš„å‘åœ¨äºå¦‚æœä½ è¾“å‡ºç”±ä½¿ç”¨nvçš„è²æ¶…å°”æ–¹ç¨‹å¾—åˆ°çš„ç»“æœï¼Œä½ ä¼šå‘ç°å®ƒå®åœ¨æ˜¯å¤ªç¬¦åˆè²æ¶…å°”æ•ˆåº”çš„ç‰©ç†ç‰¹æ€§ï¼Œè€Œä½¿ç”¨vhçš„æ•ˆæœå¾ˆä¸æ˜æ˜¾ã€‚ä½†å®é™…ä¸Šä½¿ç”¨nvå¾—åˆ°çš„æ•ˆæœå’ŒçœŸå®è²æ¶…å°”æ•ˆåº”å®Œå…¨ç›¸åï¼Œè¾¹ç¼˜ä¼šåè€Œæ¯”ä¸­é—´æš—ã€‚æ‰€ä»¥åœ¨è¿™é‡Œå¤§èƒ†ä½¿ç”¨vhå°±å¥½ã€‚Unityåœ¨è¿™é‡Œç”¨çš„æ˜¯lhï¼Œè¿™æ˜¯ä¸€ç§å¯¹GGX shaderæ¸²æŸ“æ•ˆæœçš„ä¼˜åŒ–æ–¹æ³•ï¼Œå‚è€ƒé“¾æ¥ï¼š<a href="http://filmicworlds.com/blog/optimizing-ggx-shaders-with-dotlh/">Optimizing GGX Shaders with dot(L,H) â€“ Filmic Worlds</a>ã€‘</p><p>å› ä¸ºä¹‹å‰æ²¡äº†è§£è¿‡ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘è¿˜æ˜¯æƒ³ç”¨nvåšä¸€ä¸‹ã€‚</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">float3 F0 = lerp(unity_ColorSpaceDielectricSpec.rgb, Albedo, _Metallic);</span><br><span class="line">float3 F = F0 + (<span class="number">1</span> - F0) * <span class="built_in">pow</span>(<span class="number">1</span> - nv, <span class="number">5</span>);</span><br></pre></td></tr></table></figure><p><strong>æœ€ç»ˆè®¡ç®—</strong></p><p>å¾—åˆ°DGFä¸‰ä¸ªå‚æ•°åï¼Œæˆ‘ä»¬é™¤ä»¥æ ¡æ­£å› å­ã€‚</p><p>ä»¥åŠæˆ‘ä»¬éœ€è¦æ³¨æ„å› ä¸ºåœ¨æ¼«åå°„å°‘é™¤äº†ä¸€ä¸ª$\pi$ï¼Œè¿™é‡Œé•œé¢åå°„é¡¹éœ€è¦å¤šä¹˜ä»¥ä¸€ä¸ª$\pi$ï¼Œä»¥ä¿è¯æ¼«åå°„å’Œé•œé¢åå°„çš„æ¯”ä¾‹ã€‚</p><p>ç„¶åä¸ºä¿è¯èƒ½é‡å®ˆæ’ï¼Œè¿™é‡Œæˆ‘ä»¬å°†kdä¹˜ä¸Šä¸€ä¸ªï¼ˆ1-Fï¼‰è¡¨ç¤ºé™¤å»åå°„å æ¯”çš„å…‰çº¿å‰©ä½™å…‰çº¿ï¼Œå†ä¹˜ä»¥ï¼ˆ1-_Metallicï¼‰æ˜¯å› ä¸ºé‡‘å±ç›¸å¯¹éé‡‘å±ä¼šæ›´å¤šå¸æ”¶æŠ˜å°„å…‰çº¿å¯¼è‡´æ¼«åå°„æ¶ˆå¤±ã€‚</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç›´æ¥å…‰é•œé¢åå°„</span></span><br><span class="line"><span class="comment">//D</span></span><br><span class="line"><span class="type">float</span> lerpSquareRoughness = <span class="built_in">pow</span>(lerp(<span class="number">0.002</span>, <span class="number">1</span>, roughness), <span class="number">2</span>);<span class="comment">//é™åˆ¶ç²—ç³™åº¦æœ€å°å€¼ä¸º0.002</span></span><br><span class="line"><span class="type">float</span> D = lerpSquareRoughness / (<span class="built_in">pow</span>((<span class="built_in">pow</span>(nh, <span class="number">2</span>) * (lerpSquareRoughness - <span class="number">1</span>) + <span class="number">1</span>), <span class="number">2</span>) * UNITY_PI);</span><br><span class="line"><span class="comment">//G</span></span><br><span class="line"><span class="type">float</span> kDL = <span class="built_in">pow</span>(squareRoughness + <span class="number">1</span>, <span class="number">2</span>) / <span class="number">8</span>;</span><br><span class="line"><span class="type">float</span> kIBL = <span class="built_in">pow</span>(squareRoughness, <span class="number">2</span>) / <span class="number">2</span>;</span><br><span class="line"><span class="type">float</span> GLeft = nl / lerp(nl, <span class="number">1</span>, kDL);</span><br><span class="line"><span class="type">float</span> GRight = nv / lerp(nv, <span class="number">1</span>, kDL);</span><br><span class="line"><span class="type">float</span> G = GLeft * GRight;</span><br><span class="line"><span class="comment">//F</span></span><br><span class="line">float3 F0 = lerp(unity_ColorSpaceDielectricSpec.rgb, Albedo, _Metallic);</span><br><span class="line">float3 F = F0 + (<span class="number">1</span> - F0) * <span class="built_in">pow</span>(<span class="number">1</span> - lh, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">float3 SpecularResult = (D * G * F * <span class="number">0.25</span>) / (nv * nl);</span><br><span class="line">float3 specColor = SpecularResult * lightColor * nl * UNITY_PI;</span><br><span class="line"><span class="comment">//ç›´æ¥å…‰æ¼«åå°„</span></span><br><span class="line"><span class="type">float</span> kd = (<span class="number">1</span> - F) * (<span class="number">1</span> - _Metallic);</span><br><span class="line">float3 diffColor = kd * Albedo * lightColor * nl;</span><br><span class="line"></span><br><span class="line">float3 DirectLightResult = diffColor + specColor;</span><br></pre></td></tr></table></figure><p><img src="/2024/08/07/Unity%E4%B8%AD%E9%80%A0%E4%B8%80%E4%B8%AAPBR%E6%9D%90%E8%B4%A8/image-20240808182208888.png" alt="image-20240808182208888"></p><h2 id="é—´æ¥å…‰æ¼«åå°„"><a href="#é—´æ¥å…‰æ¼«åå°„" class="headerlink" title="é—´æ¥å…‰æ¼«åå°„"></a>é—´æ¥å…‰æ¼«åå°„</h2><p>é—´æ¥å…‰æ¼«åå°„å…¬å¼å¦‚ä¸‹ï¼š<br>$$<br>L_o(p,w_o)&#x3D;k_d\frac{c}{\pi}\int_{\Omega}{L_i(p,\omega_i)n\cdot \omega_id\omega_i}<br>$$<br>å°±æ˜¯å°†åŠçƒé¢èŒƒå›´å†…çš„é—´æ¥å…‰æŒ‰ç…§æ¼«åå°„å…¬å¼è®¡ç®—å¹¶ç§¯åˆ†ï¼Œä½†æ˜¯å®é™…ä¸Šè®¡ç®—çš„æ—¶å€™æˆ‘ä»¬ä¸å¯èƒ½å¯¹æ¯ä¸ªç‚¹è¿›è¡Œç§¯åˆ†ï¼Œè¿™æ ·è®¡ç®—å¼€é”€å¤ªå¤§äº†ã€‚</p><p>æ™®éåšæ³•æ˜¯å°†é‡‡æ ·åˆ°çš„cubemapé¢„å¤„ç†æˆä¸€å¼ è´´å›¾ã€‚è€ŒUnityå·²ç»åšå¥½äº†è¿™ä»¶äº‹ï¼Œå…ˆå°†ç¯å¢ƒè´´å›¾cubemapç§¯åˆ†æˆæ¨¡ç³Šçš„å…¨å±€å…‰ç…§è´´å›¾ï¼Œå†å°†å…¨å±€å…‰ç…§è´´å›¾æŠ•å½±åˆ°çƒè°å…‰ç…§çš„åŸºå‡½æ•°ä¸Šå­˜å‚¨ã€‚</p><p>åœ¨UnityShaderVariables.cgincä¸­å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„ä¸ƒä¸ªå‚æ•°å³ä¸ºå­˜å‚¨çš„åŸºå‡½æ•°çš„ç³»æ•°ã€‚</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SH lighting environment</span></span><br><span class="line">half4 unity_SHAr;</span><br><span class="line">half4 unity_SHAg;</span><br><span class="line">half4 unity_SHAb;</span><br><span class="line">half4 unity_SHBr;</span><br><span class="line">half4 unity_SHBg;</span><br><span class="line">half4 unity_SHBb;</span><br><span class="line">half4 unity_SHC;</span><br></pre></td></tr></table></figure><p>å‚è€ƒæ–‡ç« å†™é“Unityä½¿ç”¨çš„åŸºå‡½æ•°æ˜¯ä¸‰é˜¶çš„ä¼´éšå‹’è®©å¾·å¤šé¡¹å¼ï¼Œå¼å­å‚æ•°å¦‚ä¸‹æ‰€ç¤ºï¼ˆæ¬è¿åŸå›¾ï¼‰</p><p><img src="/2024/08/07/Unity%E4%B8%AD%E9%80%A0%E4%B8%80%E4%B8%AAPBR%E6%9D%90%E8%B4%A8/image-20240808190805093.png" alt="image-20240808190805093"></p><p>æ€»ä¹‹ä¸ç®¡ç”¨ä»€ä¹ˆåŸºå‡½æ•°ï¼Œæ¯ä¸€é¡¹éƒ½æ˜¯çƒé¢ä¸Šå…‰ç…§ä¸€éƒ¨åˆ†ï¼Œè¿™é‡Œç›´æ¥è°ƒç”¨ShadeSH9å‡½æ•°ï¼Œä¼ å…¥å½’ä¸€åŒ–æ³•çº¿ï¼Œè¿”å›é‡å»ºçš„ç§¯åˆ†åçš„ç¯å¢ƒå…‰ç…§ä¿¡æ¯ã€‚</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//é—´æ¥å…‰æ¼«åå°„</span></span><br><span class="line">half3 ambient_ib = ShadeSH9(float4(i.normal, <span class="number">1</span>));</span><br><span class="line">float3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz;</span><br><span class="line">float3 iblDiffuse = ambient + ambient_ib;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> kdLast = <span class="number">1</span>;</span><br><span class="line">float3 iblDiffuseResult = iblDiffuse * kdLast * Albedo;</span><br></pre></td></tr></table></figure><p><img src="/2024/08/07/Unity%E4%B8%AD%E9%80%A0%E4%B8%80%E4%B8%AAPBR%E6%9D%90%E8%B4%A8/image-20240808191819890.png" alt="image-20240808191819890"></p><h2 id="é—´æ¥å…‰é•œé¢åå°„"><a href="#é—´æ¥å…‰é•œé¢åå°„" class="headerlink" title="é—´æ¥å…‰é•œé¢åå°„"></a>é—´æ¥å…‰é•œé¢åå°„</h2><p>é—´æ¥å…‰é•œé¢åå°„è®¡ç®—å…¬å¼ï¼š<br>$$<br>L_o\left(p, \omega_o\right)&#x3D;\int_{\Omega}k_s \frac{D F G}{4\left(\omega_o \cdot n\right)\left(\omega_i \cdot n\right)} L_i\left(p, \omega_i\right) n \cdot \omega_i d \omega_i&#x3D;\int_{\Omega} f_r\left(p, \omega_i, \omega_o\right) L_i\left(p, \omega_i\right) n \cdot \omega_i d \omega_i.<br>$$<br>è™šå¹»å¼•æ“åšæ³•æ˜¯å°†å…¬å¼è¿‘ä¼¼ï¼Œå°†å…‰ç…§å’ŒBRDFé¡¹åˆ†å¼€ï¼ˆæˆ‘æ€ä¹ˆè®°å¾—åœ¨Games101è¿˜æ˜¯Games202çœ‹åˆ°è¿‡ï¼Œä¹‹åå»å¤ä¹ ä¸€ä¸‹å†è¡¥ä¸Šï¼‰<br>$$<br>\frac{1}{N} \sum_{k&#x3D;1}^N \frac{L_i\left(\mathbf{l}_k\right) f\left(\mathbf{l}<em>k, \mathbf{v}\right) \cos \theta</em>{\mathbf{l}_k}}{p\left(\mathbf{l}<em>k, \mathbf{v}\right)} \approx\left(\frac{1}{N} \sum</em>{k&#x3D;1}^N L_i\left(\mathbf{l}<em>k\right)\right)\left(\frac{1}{N} \sum</em>{k&#x3D;1}^N \frac{f\left(\mathbf{l}<em>k, \mathbf{v}\right) \cos \theta</em>{\mathbf{l}_k}}{p\left(\mathbf{l}_k, \mathbf{v}\right)}\right)<br>$$<br><strong>å·¦éƒ¨åˆ†</strong>è¡¨ç¤ºå…¥å°„å…‰ç…§çš„ç´¯ç§¯æ±‚å’Œï¼Œä¸å…‰ç…§å¼ºåº¦å’Œæ–¹å‘æœ‰å…³ï¼Œä½†ä¸ä¼šç›´æ¥å—åˆ°ç²—ç³™åº¦çš„å½±å“ã€‚ç„¶è€Œï¼Œè¿™éƒ¨åˆ†å…‰ç…§æ˜¯é€šè¿‡ç¯å¢ƒè´´å›¾æ¥è·å–çš„ï¼Œè€Œç¯å¢ƒè´´å›¾çš„é¢„è¿‡æ»¤è¿‡ç¨‹ä¼šè€ƒè™‘ç²—ç³™åº¦ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç²—ç³™åº¦è¶Šå¤§ï¼Œç¯å¢ƒè´´å›¾è¶Šæ¨¡ç³Šï¼Œåæ˜ åœ¨å…‰ç…§ç´¯ç§¯ä¸Šï¼Œå…‰ç…§çš„ç»†èŠ‚ä¼šå‡å°‘ï¼Œåå°„å˜å¾—æ›´åŠ æ¨¡ç³Šå’Œå¹³æ»‘ã€‚</p><p>ç”±äºè·Ÿç²—ç³™åº¦ç›¸å…³æˆ‘ä»¬ä¸èƒ½å’Œæ¼«åå°„ä¸€æ ·ç”¨ä¸€å¼ è´´å›¾è§£å†³ï¼Œè¿™é‡Œéœ€è¦ä½¿ç”¨LODç»†èŠ‚å±‚æ¬¡ã€‚</p><p>Unityå°†åœºæ™¯å’Œå¤©ç©ºç›’çš„åå°„æ¢é’ˆæ•°æ®å­˜å‚¨åœ¨unity_SpecCube0ä¸­ï¼Œè¿˜æœ‰ä¸€ä¸ªå˜é‡unity_SpecCube1å­˜å‚¨çš„æ˜¯ç¦»ç‰©ä½“æœ€è¿‘çš„åå°„æ¢é’ˆçš„æ•°æ®ã€‚</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å°†ç²—ç³™åº¦è½¬æ¢ä¸ºLODå¯¹åº”mipå±‚çº§</span></span><br><span class="line"><span class="type">float</span> mip_roughness = perceptualRoughness * (<span class="number">1.7</span> - <span class="number">0.7</span> * perceptualRoughness);</span><br><span class="line">half mip = mip_roughness * UNITY_SPECCUBE_LOD_STEPS;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¯¹ç¯å¢ƒCubeMapè¿›è¡ŒLODé‡‡æ ·</span></span><br><span class="line">float3 reflectVec = <span class="built_in">reflect</span>(-viewDir, i.normal);</span><br><span class="line">half4 rgbm = </span><br><span class="line"><span class="comment">//æ ¹æ®ç²—ç³™åº¦ä¸‰çº¿æ€§æ’å€¼æ’å€¼å‡ºmipå±‚çº§</span></span><br><span class="line">UNITY_SAMPLE_TEXCUBE_LOD(unity_SpecCube0, reflectVec, mip); </span><br><span class="line"></span><br><span class="line"><span class="comment">//å°†é¢œè‰²ä»HDRç¼–ç ä¸‹è§£ç ï¼Œè¿˜åŸåˆ°æ ‡å‡†sRGBç©ºé—´</span></span><br><span class="line">float3 iblSpecular = DecodeHDR(rgbm, unity_SpecCube0_HDR);</span><br></pre></td></tr></table></figure><p><strong>å³éƒ¨åˆ†</strong>æ˜¯å®šå€¼ï¼Œè¿™é‡Œå°†å€¼æ”¾åœ¨ä¸€å¼ æŸ¥æ‰¾å›¾ä¸­ï¼Œæ ¹æ®nvå’Œç²—ç³™åº¦é‡‡æ ·ï¼Œè¿™å¼ LUTï¼ˆLook Up Textureï¼‰å¦‚ä¸‹ï¼š</p><p><img src="https://learnopengl-cn.github.io/img/07/03/02/ibl_brdf_lut.png" alt="img"></p><p>å¯¼å…¥è¿™å¼ å›¾ç‰‡éœ€è¦æ³¨æ„å›¾ç‰‡è®¾ç½®ï¼Œå°†Unityçš„é¢œè‰²ç©ºé—´è®¾ç½®ä¸ºçº¿æ€§ï¼Œè¿™æ ·å¯¼å…¥è´´å›¾å°±ä¼šè‡ªåŠ¨å°†è´´å›¾ä»sRGBæ ¼å¼ä»ä¼½é©¬ç©ºé—´è½¬æ¢åˆ°çº¿æ€§ç©ºé—´ï¼Œåœ¨è¾“å‡ºé¢œè‰²çš„æ—¶å€™å†è‡ªåŠ¨åšä¼½é©¬æ˜ å°„å°†è®¡ç®—çš„å€¼ä»çº¿æ€§ç©ºé—´æ˜ å°„åˆ°ä¼½é©¬ç©ºé—´æ˜¾ç¤ºåˆ°å±å¹•ä¸Šã€‚LUTå¹¶ä¸ç”¨äºè¾“å‡ºé¢œè‰²ï¼Œåªæ˜¯ä¸ªç”¨äºæŸ¥æ‰¾æ•°æ®çš„å›¾å¹¶æ²¡æœ‰è¢«æ ¡æ­£è¿‡ï¼Œæ‰€ä»¥è®¾ç½®ä¸­éœ€è¦æŠŠsRGBå–æ¶ˆæ‰ã€‚</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">float2 envBDRF = tex2D(_LUT, float2(lerp(<span class="number">0</span>, <span class="number">0.99</span>, nv), lerp(<span class="number">0</span>, <span class="number">0.99</span>, roughness))).rg; <span class="comment">// LUTé‡‡æ ·</span></span><br><span class="line"><span class="comment">//æ³¨æ„è¿™é‡ŒæŠŠnvå’Œroughnesséƒ½clampåˆ°0åˆ°0.99ä¹‹é—´ï¼Œè¿™æ˜¯å› ä¸ºå½“è¿™ä¸¤ä¸ªå€¼éƒ½ä¸º1çš„æ—¶å€™LUTçš„é¢œè‰²ä¼šå‘ç”Ÿçªå˜ï¼Œå¯¼è‡´è¢«æ¸²æŸ“çš„ç‰©ä½“ä¸Šäº§ç”Ÿäº®æ–‘ã€‚</span></span><br></pre></td></tr></table></figure><p>ã€æ³¨æ„è¿™é‡Œä½¿ç”¨çš„æ˜¯LearnOpenGLçš„æ–¹æ³•ï¼Œè·ŸUnityä¸ä¸€æ ·ï¼ŒUnityä¹Ÿæ˜¯ç”¨è¿‘ä¼¼æ¥åšçš„ï¼Œè¯¦æƒ…è§å‚è€ƒæ–‡ç« ã€‘</p><p>ç„¶åè®¡ç®—é—´æ¥å…‰çš„è²æ¶…å°”ç³»æ•°ï¼Œå¾—åˆ°é—´æ¥å…‰æ¼«åå°„å’Œé—´æ¥å…‰é•œé¢åå°„å æ¯”ã€‚è¿™é‡Œè²æ¶…å°”è®¡ç®—ä½¿ç”¨çš„ç²—ç³™åº¦å¹¶ä¸æ˜¯é‡‘å±åº¦ï¼Œæ˜¯ä¸€ç§ç»éªŒåšæ³•ï¼Œå‚è€ƒ<a href="https://seblagarde.wordpress.com/2011/08/17/hello-world/">Adopting a physically based shading model | SÃ©bastien Lagarde (wordpress.com)</a></p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">float3 fresnelSchlickRoughness(<span class="type">float</span> cosTheta, float3 F0, <span class="type">float</span> roughness)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//å¼•å…¥ç²—ç³™åº¦ï¼Œæ˜¯ä¸€ç§ç»éªŒåšæ³•</span></span><br><span class="line"><span class="keyword">return</span> F0 + (<span class="built_in">max</span>(float3(<span class="number">1.0</span> - roughness, <span class="number">1.0</span> - roughness, <span class="number">1.0</span> - roughness), F0) - F0) * <span class="built_in">pow</span>(<span class="number">1.0</span> - cosTheta, <span class="number">5.0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿™é‡Œæ²¡æœ‰Då‡½æ•°è®¡ç®—æ­£ç¡®åå°„çš„æ¯”ä¾‹ï¼Œå› ä¸ºç¯å¢ƒå…‰æ¥è‡ªåŠçƒæ‰€æœ‰æ–¹å‘ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨çš„nvï¼Œä¸æ˜¯vh</span></span><br><span class="line">float3 Flast = fresnelSchlickRoughness(<span class="built_in">max</span>(nv, <span class="number">0.0</span>), F0, roughness);</span><br><span class="line"><span class="comment">//åŒç†ç›´æ¥å…‰çš„å æ¯”è®¡ç®—</span></span><br><span class="line"><span class="type">float</span> kdLast = (<span class="number">1</span> - Flast) * (<span class="number">1</span> - _Metallic);</span><br><span class="line"></span><br><span class="line">float3 iblDiffuseResult = iblDiffuse * kdLast * Albedo;</span><br><span class="line">float3 iblSpecularResult = iblSpecular * (Flast * envBDRF.r + envBDRF.g);</span><br><span class="line">float3 IndirectResult = iblDiffuseResult + iblSpecularResult;</span><br><span class="line"></span><br><span class="line">float4 result = float4(DirectLightResult + IndirectResult, <span class="number">1</span>);</span><br></pre></td></tr></table></figure><p><img src="/2024/08/07/Unity%E4%B8%AD%E9%80%A0%E4%B8%80%E4%B8%AAPBR%E6%9D%90%E8%B4%A8/image-20240808213904076.png" alt="image-20240808213904076"></p><h2 id="å®Œæ•´ä»£ç "><a href="#å®Œæ•´ä»£ç " class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h2><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Common/MyPBR&quot;</span><br><span class="line">&#123;</span><br><span class="line">Properties</span><br><span class="line">&#123;</span><br><span class="line">_MainTex(&quot;Texture&quot;, <span class="number">2</span>D) = &quot;white&quot; &#123;&#125;</span><br><span class="line">_Tint(&quot;Tint&quot;, Color) = (<span class="number">1</span> ,<span class="number">1</span> ,<span class="number">1</span> ,<span class="number">1</span>)</span><br><span class="line">[Gamma] _Metallic(&quot;Metallic&quot;, Range(<span class="number">0</span>, <span class="number">1</span>)) = <span class="number">0</span> <span class="comment">//é‡‘å±åº¦éœ€è¦ä¼½é©¬æ ¡æ­£</span></span><br><span class="line">_Smoothness(&quot;Smoothness&quot;, Range(<span class="number">0</span>, <span class="number">1</span>)) = <span class="number">0.5</span></span><br><span class="line">_LUT(&quot;LUT&quot;, <span class="number">2</span>D) = &quot;white&quot; &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SubShader</span><br><span class="line">&#123;</span><br><span class="line">Tags &#123; &quot;RenderType&quot; = &quot;Opaque&quot; &#125;</span><br><span class="line">LOD <span class="number">100</span></span><br><span class="line"></span><br><span class="line">Pass</span><br><span class="line">&#123;</span><br><span class="line">Tags &#123;</span><br><span class="line">&quot;LightMode&quot; = &quot;ForwardBase&quot;</span><br><span class="line">&#125;</span><br><span class="line">CGPROGRAM</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma target 3.0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma vertex vert</span></span><br><span class="line"><span class="meta">#pragma fragment frag</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#include &quot;UnityStandardBRDF.cginc&quot; </span></span><br><span class="line"></span><br><span class="line">struct appdata</span><br><span class="line">&#123;</span><br><span class="line">float4 vertex : POSITION;</span><br><span class="line">float3 normal : NORMAL;</span><br><span class="line">float2 uv : TEXCOORD0;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct v2f</span><br><span class="line">&#123;</span><br><span class="line">float4 vertex : SV_POSITION;</span><br><span class="line">float2 uv : TEXCOORD0;</span><br><span class="line">float3 normal : TEXCOORD1;</span><br><span class="line">float3 worldPos : TEXCOORD2;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">float4 _Tint;</span><br><span class="line"><span class="type">float</span> _Metallic;</span><br><span class="line"><span class="type">float</span> _Smoothness;</span><br><span class="line"><span class="type">sampler2D</span> _MainTex;</span><br><span class="line">float4 _MainTex_ST;</span><br><span class="line"><span class="type">sampler2D</span> _LUT;</span><br><span class="line"></span><br><span class="line"><span class="meta">#define PI 3.1415926</span></span><br><span class="line"></span><br><span class="line"><span class="type">float</span> Square (<span class="type">float</span> v) &#123;</span><br><span class="line"><span class="keyword">return</span> v * v;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">float3 fresnelSchlickRoughness(<span class="type">float</span> cosTheta, float3 F0, <span class="type">float</span> roughness)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> F0 + (<span class="built_in">max</span>(float3(<span class="number">1.0</span> - roughness, <span class="number">1.0</span> - roughness, <span class="number">1.0</span> - roughness), F0) - F0) * <span class="built_in">pow</span>(<span class="number">1.0</span> - cosTheta, <span class="number">5.0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">v2f vert(appdata v)</span><br><span class="line">&#123;</span><br><span class="line">v2f o;</span><br><span class="line">o.vertex = UnityObjectToClipPos(v.vertex);</span><br><span class="line">o.worldPos = mul(unity_ObjectToWorld, v.vertex);</span><br><span class="line">o.uv = TRANSFORM_TEX(v.uv, _MainTex);</span><br><span class="line">o.normal = UnityObjectToWorldNormal(v.normal);</span><br><span class="line">o.normal = <span class="built_in">normalize</span>(o.normal);</span><br><span class="line"><span class="keyword">return</span> o;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fixed4 frag(v2f i) : SV_Target</span><br><span class="line">&#123;</span><br><span class="line">i.normal = <span class="built_in">normalize</span>(i.normal);</span><br><span class="line">float3 lightDir = <span class="built_in">normalize</span>(_WorldSpaceLightPos0.xyz);</span><br><span class="line">float3 viewDir = <span class="built_in">normalize</span>(_WorldSpaceCameraPos.xyz - i.worldPos.xyz);</span><br><span class="line">float3 lightColor = _LightColor0.rgb;</span><br><span class="line">float3 halfVector = <span class="built_in">normalize</span>(lightDir + viewDir);  <span class="comment">//åŠè§’å‘é‡</span></span><br><span class="line"></span><br><span class="line"><span class="type">float</span> perceptualRoughness = <span class="number">1</span> - _Smoothness;</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> roughness = Square(perceptualRoughness);</span><br><span class="line"><span class="type">float</span> squareRoughness = Square(roughness);</span><br><span class="line"></span><br><span class="line"><span class="type">float</span> nl = <span class="built_in">max</span>(saturate(<span class="built_in">dot</span>(i.normal, lightDir)), <span class="number">0.000001</span>);<span class="comment">//é˜²æ­¢é™¤0</span></span><br><span class="line"><span class="type">float</span> nv = <span class="built_in">max</span>(saturate(<span class="built_in">dot</span>(i.normal, viewDir)), <span class="number">0.000001</span>);</span><br><span class="line"><span class="type">float</span> vh = <span class="built_in">max</span>(saturate(<span class="built_in">dot</span>(viewDir, halfVector)), <span class="number">0.000001</span>);</span><br><span class="line"><span class="type">float</span> lh = <span class="built_in">max</span>(saturate(<span class="built_in">dot</span>(lightDir, halfVector)), <span class="number">0.000001</span>);</span><br><span class="line"><span class="type">float</span> nh = <span class="built_in">max</span>(saturate(<span class="built_in">dot</span>(i.normal, halfVector)), <span class="number">0.000001</span>);</span><br><span class="line"></span><br><span class="line">float3 Albedo = _Tint * tex2D(_MainTex, i.uv);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç›´æ¥å…‰é•œé¢åå°„</span></span><br><span class="line"><span class="comment">//D</span></span><br><span class="line"><span class="type">float</span> lerpSquareRoughness = <span class="built_in">pow</span>(lerp(<span class="number">0.002</span>, <span class="number">1</span>, roughness), <span class="number">2</span>);<span class="comment">//é™åˆ¶ç²—ç³™åº¦æœ€å°å€¼ä¸º0.002</span></span><br><span class="line"><span class="type">float</span> D = lerpSquareRoughness / (<span class="built_in">pow</span>((<span class="built_in">pow</span>(nh, <span class="number">2</span>) * (lerpSquareRoughness - <span class="number">1</span>) + <span class="number">1</span>), <span class="number">2</span>) * UNITY_PI);</span><br><span class="line"><span class="comment">//G</span></span><br><span class="line"><span class="type">float</span> kDL = <span class="built_in">pow</span>(squareRoughness + <span class="number">1</span>, <span class="number">2</span>) / <span class="number">8</span>;</span><br><span class="line"><span class="type">float</span> kIBL = <span class="built_in">pow</span>(squareRoughness, <span class="number">2</span>) / <span class="number">2</span>;</span><br><span class="line"><span class="type">float</span> GLeft = nl / lerp(nl, <span class="number">1</span>, kDL);</span><br><span class="line"><span class="type">float</span> GRight = nv / lerp(nv, <span class="number">1</span>, kDL);</span><br><span class="line"><span class="type">float</span> G = GLeft * GRight;</span><br><span class="line"><span class="comment">//F</span></span><br><span class="line">float3 F0 = lerp(unity_ColorSpaceDielectricSpec.rgb, Albedo, _Metallic);</span><br><span class="line">float3 F = F0 + (<span class="number">1</span> - F0) * <span class="built_in">pow</span>(<span class="number">1</span> - nv, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">float3 SpecularResult = (D * G * F * <span class="number">0.25</span>) / (nv * nl);</span><br><span class="line">float3 specColor = SpecularResult * lightColor * nl * UNITY_PI;</span><br><span class="line"><span class="comment">//ç›´æ¥å…‰æ¼«åå°„</span></span><br><span class="line"><span class="type">float</span> kd = (<span class="number">1</span> - F) * (<span class="number">1</span> - _Metallic);</span><br><span class="line">float3 diffColor = kd * Albedo * lightColor * nl;</span><br><span class="line"></span><br><span class="line">float3 DirectLightResult = diffColor + specColor;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//é—´æ¥å…‰æ¼«åå°„</span></span><br><span class="line">half3 ambient_ib = ShadeSH9(float4(i.normal, <span class="number">1</span>));</span><br><span class="line">float3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz;</span><br><span class="line">float3 iblDiffuse = ambient + ambient_ib;</span><br><span class="line"></span><br><span class="line"><span class="comment">//é—´æ¥å…‰é•œé¢åå°„</span></span><br><span class="line"><span class="type">float</span> mip_roughness = perceptualRoughness * (<span class="number">1.7</span> - <span class="number">0.7</span> * perceptualRoughness);</span><br><span class="line">float3 reflectVec = <span class="built_in">reflect</span>(-viewDir, i.normal);</span><br><span class="line"></span><br><span class="line">half mip = mip_roughness * UNITY_SPECCUBE_LOD_STEPS;</span><br><span class="line">half4 rgbm = UNITY_SAMPLE_TEXCUBE_LOD(unity_SpecCube0, reflectVec, mip); </span><br><span class="line"></span><br><span class="line">float3 iblSpecular = DecodeHDR(rgbm, unity_SpecCube0_HDR);</span><br><span class="line">float2 envBDRF = tex2D(_LUT, float2(lerp(<span class="number">0</span>, <span class="number">0.99</span>, nv), lerp(<span class="number">0</span>, <span class="number">0.99</span>, roughness))).rg; <span class="comment">// LUTé‡‡æ ·</span></span><br><span class="line"></span><br><span class="line">float3 Flast = fresnelSchlickRoughness(<span class="built_in">max</span>(nv, <span class="number">0.0</span>), F0, roughness);</span><br><span class="line"><span class="type">float</span> kdLast = (<span class="number">1</span> - Flast) * (<span class="number">1</span> - _Metallic);</span><br><span class="line"></span><br><span class="line">float3 iblDiffuseResult = iblDiffuse * kdLast * Albedo;</span><br><span class="line">float3 iblSpecularResult = iblSpecular * (Flast * envBDRF.r + envBDRF.g);</span><br><span class="line">float3 IndirectResult = iblDiffuseResult + iblSpecularResult;</span><br><span class="line"></span><br><span class="line">float4 result = float4(DirectLightResult + IndirectResult, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ENDCG</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è¡¥å……"><a href="#è¡¥å……" class="headerlink" title="è¡¥å……"></a>è¡¥å……</h2><p>åœ¨ç›´æ¥å…‰é•œé¢åå°„è®¡ç®—æ—¶ï¼Œæˆ‘ä»¬ä»ç„¶ä½¿ç”¨çš„nvè€Œä¸æ˜¯lhä»£æ›¿ï¼Œç»“æœæ˜¾ç¤ºä¸¤è€…å‡ ä¹æ²¡å·®åˆ«ã€‚</p><p>ä½†æ˜¯å¯¹æ¯”Standardæè´¨æ³•çº¿ï¼Œå½“M&#x3D;0ï¼ŒS&#x3D;1æ—¶ï¼Œæ ‡å‡†æè´¨çƒè¾¹ç¼˜ä¼šæœ‰å¾®äº®ï¼Œä½†æ˜¯æˆ‘ä»¬æ‰‹æ“çš„æ²¡æœ‰ï¼Œåº”è¯¥è·ŸFresnelé¡¹è®¡ç®—æœ‰å…³ï¼Œè¿™ä¸ªä¹‹åä»”ç»†ç ”ç©¶ä¸€ä¸‹ï¼Œå†æ›´æ–°åˆ°è¿™é‡Œã€‚</p><img src="/2024/08/07/Unity%E4%B8%AD%E9%80%A0%E4%B8%80%E4%B8%AAPBR%E6%9D%90%E8%B4%A8/image-20240808215111567.png" alt="image-20240808215111567" style="zoom:50%;"><h2 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h2><p>å› ä¸ºé—´æ¥å…‰è®¡ç®—éƒ¨åˆ†ä¹‹å‰æ²¡å¤ªäº†è§£è¿‡ï¼Œå› æ­¤å¤§å¤šç…§æ¬äº†å‚è€ƒæ–‡ç« çš„è§£é‡Šï¼Œä¹‹åæœ‰ç©ºå†å®Œå–„è¡¥å……ã€‚</p><p>æ€»çš„æ¥è¯´ï¼Œè·Ÿç€æ‰‹æ“ä¸€éPBRæè´¨ç¡®å®æ”¶è·å¾ˆå¤šã€‚</p><hr><p><strong>å‚è€ƒæ–‡ç« </strong></p><p><a href="https://zhuanlan.zhihu.com/p/68025039">å¦‚ä½•åœ¨Unityä¸­é€ ä¸€ä¸ªPBR Shaderè½®å­ - çŸ¥ä¹ (zhihu.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> Unity Shader </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸¸æˆæ¸²æŸ“ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Unity SRP 03-åŸºç¡€å…‰ç…§</title>
      <link href="/2024/08/05/Unity-SRP-03-%E5%9F%BA%E7%A1%80%E5%85%89%E7%85%A7/"/>
      <url>/2024/08/05/Unity-SRP-03-%E5%9F%BA%E7%A1%80%E5%85%89%E7%85%A7/</url>
      
        <content type="html"><![CDATA[<hr><h1 id="Unity-SRP-03-åŸºç¡€å…‰ç…§"><a href="#Unity-SRP-03-åŸºç¡€å…‰ç…§" class="headerlink" title="Unity SRP 03-åŸºç¡€å…‰ç…§"></a>Unity SRP 03-åŸºç¡€å…‰ç…§</h1><table><tr><td bgcolor="MintCream">æœ¬æ–‡é‡ç‚¹ï¼š<br>    <ul>        <li>ä½¿ç”¨æ³•å‘é‡è®¡ç®—å…‰ç…§</li>        <li>æ”¯æŒå¤šä¸ªæ–¹å‘å…‰</li>        <li>åº”ç”¨BRDF</li>        <li>å¯å‘å…‰çš„é€æ˜æè´¨</li>        <li>ä½¿ç”¨é¢„è®¾åˆ›å»ºè‡ªå®šä¹‰ç€è‰²å™¨GUI</li>    </ul> </td></tr></table><h2 id="ç…§æ˜"><a href="#ç…§æ˜" class="headerlink" title="ç…§æ˜"></a>ç…§æ˜</h2><h3 id="Lit-Shader"><a href="#Lit-Shader" class="headerlink" title="Lit Shader"></a>Lit Shader</h3><p>å°†åœ¨Unlit ShaderåŸºç¡€ä¸Šä¿®æ”¹ï¼Œå¹¶å¢åŠ Tagsæ ‡è®°LightModeä¸ºCustomLitï¼Œæ¥æŒ‡ç¤ºæˆ‘ä»¬è‡ªå®šä¹‰ç…§æ˜æ¨¡å¼ã€‚</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Pass &#123;</span><br><span class="line">Tags &#123;</span><br><span class="line">&quot;LightMode&quot; = &quot;CustomLit&quot;</span><br><span class="line">&#125;</span><br><span class="line">â€¦</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨CameraRendererä¸­æ·»åŠ æ–°çš„æ”¯æŒçš„ç€è‰²å™¨æ ‡ç­¾æ ‡è¯†ç¬¦</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> ShaderTagId unlitShaderTagId = <span class="keyword">new</span> ShaderTagId(<span class="string">&quot;SRPDefaultUnlit&quot;</span>),</span><br><span class="line">litShaderTagId = <span class="keyword">new</span> ShaderTagId(<span class="string">&quot;CustomLit&quot;</span>);</span><br><span class="line">...</span><br><span class="line">drawingSettings.SetShaderPassName(<span class="number">1</span>, litShaderTagId);</span><br></pre></td></tr></table></figure><h3 id="æ³•å‘é‡"><a href="#æ³•å‘é‡" class="headerlink" title="æ³•å‘é‡"></a>æ³•å‘é‡</h3><p>éœ€è¦æ³¨æ„çš„æ˜¯æ’å€¼ä¸‰è§’é¢ç‰‡çš„æ³•å‘é‡ï¼Œä¼šå¼•èµ·å‘é‡é•¿åº¦å˜åŒ–ã€‚</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">base.rgb = <span class="built_in">abs</span>(<span class="built_in">length</span>(input.normalWS) - <span class="number">1.0</span>) * <span class="number">10.0</span>;</span><br></pre></td></tr></table></figure><p><img src="/2024/08/05/Unity-SRP-03-%E5%9F%BA%E7%A1%80%E5%85%89%E7%85%A7/image-20240806180359012.png" alt="image-20240806180359012"></p><p>å½’ä¸€åŒ–å</p><p><img src="/2024/08/05/Unity-SRP-03-%E5%9F%BA%E7%A1%80%E5%85%89%E7%85%A7/image-20240806180422373.png" alt="image-20240806180422373"></p><h3 id="è¡¨é¢"><a href="#è¡¨é¢" class="headerlink" title="è¡¨é¢"></a>è¡¨é¢</h3><p>ç€è‰²å™¨ä¸­çš„å…‰ç…§æ˜¯å…³äºæ¨¡æ‹Ÿç…§å°„åˆ°è¡¨é¢çš„å…‰çº¿ä¹‹é—´çš„äº¤äº’ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¿…é¡»è·Ÿè¸ªè¡¨é¢çš„å±æ€§ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªSurface.hlslæ–‡ä»¶ã€‚</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#ifndef CUSTOM_SURFACE_INCLUDED</span></span><br><span class="line"><span class="meta">#define CUSTOM_SURFACE_INCLUDED</span></span><br><span class="line"></span><br><span class="line">struct Surface &#123;</span><br><span class="line">float3 normal;</span><br><span class="line">float3 color;</span><br><span class="line"><span class="type">float</span> alpha;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#endif</span></span><br></pre></td></tr></table></figure><h3 id="è®¡ç®—å…‰ç…§"><a href="#è®¡ç®—å…‰ç…§" class="headerlink" title="è®¡ç®—å…‰ç…§"></a>è®¡ç®—å…‰ç…§</h3><p>ä¸ºäº†è®¡ç®—å®é™…çš„ç…§æ˜ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªå‡½æ•°GetLightingã€‚æœ€åˆï¼Œè®©å®ƒè¿”å›è¡¨é¢æ³•çº¿çš„ Y åˆ†é‡ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªLighting.hlsl</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#ifndef CUSTOM_LIGHTING_INCLUDED</span></span><br><span class="line"><span class="meta">#define CUSTOM_LIGHTING_INCLUDED</span></span><br><span class="line"></span><br><span class="line">float3 GetLighting (Surface surface) &#123;</span><br><span class="line"><span class="keyword">return</span> surface.normal.y * surface.color;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#endif</span></span><br></pre></td></tr></table></figure><p>åœ¨LitPass.hlslä¸­åŒ…å«ï¼ˆä¹‹ååˆ›å»ºæ–°æ–‡ä»¶åŒç†ï¼Œä¸å†é‡å¤ï¼‰</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#include &quot;../ShaderLibrary/Surface.hlsl&quot;</span></span><br><span class="line"><span class="meta">#include &quot;../ShaderLibrary/Lighting.hlsl&quot;</span></span><br></pre></td></tr></table></figure><p><img src="/2024/08/05/Unity-SRP-03-%E5%9F%BA%E7%A1%80%E5%85%89%E7%85%A7/image-20240806205101195.png" alt="image-20240806205101195"></p><h2 id="Lights"><a href="#Lights" class="headerlink" title="Lights"></a>Lights</h2><h3 id="Light-Structure"><a href="#Light-Structure" class="headerlink" title="Light Structure"></a>Light Structure</h3><p>ä½¿ç”¨ä¸€ä¸ªç»“æ„ä½“æ¥å­˜å‚¨å…‰ç…§æ•°æ®ï¼Œéœ€è¦åŒ…å«å…‰é¢œè‰²å’Œæ–¹å‘ï¼Œæ”¾åœ¨Light.hlslä¸­</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#ifndef CUSTOM_LIGHT_INCLUDED</span></span><br><span class="line"><span class="meta">#define CUSTOM_LIGHT_INCLUDED</span></span><br><span class="line"></span><br><span class="line">struct Light &#123;</span><br><span class="line">float3 color;</span><br><span class="line">float3 direction;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Light GetDirectionalLight () &#123;</span><br><span class="line">Light light;</span><br><span class="line">light.color = <span class="number">1.0</span>;</span><br><span class="line">light.direction = float3(<span class="number">0.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>);</span><br><span class="line"><span class="keyword">return</span> light;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#endif</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹Lighting.hlslï¼ŒåŠ ä¸ŠLightçš„å…‰ç…§å¼ºåº¦</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è®¡ç®—å…‰ç…§å¼ºåº¦</span></span><br><span class="line">float3 IncomingLight (Surface surface, Light light) &#123;</span><br><span class="line"><span class="keyword">return</span> saturate(<span class="built_in">dot</span>(surface.normal, light.direction))* light.color;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¡ç®—å…‰ç…§é¢œè‰²</span></span><br><span class="line">float3 GetLighting (Surface surface, Light light) &#123;</span><br><span class="line"><span class="keyword">return</span> IncomingLight(surface, light) * surface.color;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">float3 GetLighting (Surface surface) &#123;</span><br><span class="line"><span class="keyword">return</span> GetLighting(surface, GetDirectionalLight());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å‘GPUå‘é€å…‰æ•°æ®"><a href="#å‘GPUå‘é€å…‰æ•°æ®" class="headerlink" title="å‘GPUå‘é€å…‰æ•°æ®"></a>å‘GPUå‘é€å…‰æ•°æ®</h3><p>ä¸ºäº†ä½¿å…‰æºçš„æ•°æ®åœ¨ç€è‰²å™¨ä¸­å¯è®¿é—®ï¼Œæˆ‘ä»¬å¿…é¡»ä¸ºå…¶åˆ›å»ºç»Ÿä¸€çš„å€¼ï¼Œå°±åƒç€è‰²å™¨å±æ€§ä¸€æ ·ï¼Œè¿™é‡Œæˆ‘ä»¬æ”¾åœ¨ç¼“å†²åŒºCBUFFERä¸­ã€‚</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CBUFFER_START(_CustomLight)</span><br><span class="line">float3 _DirectionalLightColor;</span><br><span class="line">float3 _DirectionalLightDirection;</span><br><span class="line">CBUFFER_END</span><br><span class="line">    ...</span><br><span class="line">Light GetDirectionalLight () &#123;</span><br><span class="line">Light light;</span><br><span class="line">light.color = _DirectionalLightColor;</span><br><span class="line">light.direction = _DirectionalLightDirection;</span><br><span class="line"><span class="keyword">return</span> light;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨ï¼Œæˆ‘ä»¬çš„ RP å¿…é¡»å°†å…‰æ•°æ®å‘é€åˆ° GPUã€‚æˆ‘ä»¬å°†ä¸ºæ­¤åˆ›å»ºä¸€ä¸ªæ–°ç±»Lightingã€‚å®ƒçš„å·¥ä½œåŸç†å°±åƒç¯ä¸€æ ·ã€‚ç»™å®ƒä¸€ä¸ªå¸¦æœ‰ä¸Šä¸‹æ–‡å‚æ•°çš„å…¬å…±æ–¹æ³•ã€‚</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.Rendering;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Lighting</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">string</span> bufferName = <span class="string">&quot;Lighting&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">int</span></span><br><span class="line">dirLightColorId = Shader.PropertyToID(<span class="string">&quot;_DirectionalLightColor&quot;</span>),</span><br><span class="line">dirLightDirectionId = Shader.PropertyToID(<span class="string">&quot;_DirectionalLightDirection&quot;</span>);</span><br><span class="line"></span><br><span class="line">CommandBuffer buffer = <span class="keyword">new</span> CommandBuffer &#123;</span><br><span class="line">name = bufferName</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Setup</span> (<span class="params">ScriptableRenderContext context</span>)</span> &#123;</span><br><span class="line">buffer.BeginSample(bufferName);</span><br><span class="line">SetupDirectionalLight();</span><br><span class="line">buffer.EndSample(bufferName);</span><br><span class="line">context.ExecuteCommandBuffer(buffer);</span><br><span class="line">buffer.Clear();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetupDirectionalLight</span> ()</span> &#123;</span><br><span class="line">        <span class="comment">//è·å–åœºæ™¯ä¸­å…‰æºä¿¡æ¯</span></span><br><span class="line">        Light light = RenderSettings.sun;</span><br><span class="line">        <span class="comment">//è®¾ç½®ç»™ç¼“å†²åŒº</span></span><br><span class="line">buffer.SetGlobalVector(dirLightColorId, light.color.linear * light.intensity);</span><br><span class="line">buffer.SetGlobalVector(dirLightDirectionId, -light.transform.forward);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨CameraRendererä¸­åŠ å…¥Lightingçš„Setupï¼Œå°†ä¸Šä¸‹æ–‡ä¼ é€’ç»™Lighting</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Lighting lighting = <span class="keyword">new</span> Lighting();</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Render</span> (<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">ScriptableRenderContext context, Camera camera,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="built_in">bool</span> useDynamicBatching, <span class="built_in">bool</span> useGPUInstancing</span></span></span><br><span class="line"><span class="params"><span class="function"></span>)</span> &#123;</span><br><span class="line">â€¦</span><br><span class="line"></span><br><span class="line">Setup();</span><br><span class="line">lighting.Setup(context);</span><br><span class="line">DrawVisibleGeometry(useDynamicBatching, useGPUInstancing);</span><br><span class="line">DrawUnsupportedShaders();</span><br><span class="line">DrawGizmos();</span><br><span class="line">Submit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†åœºæ™¯æ–¹å‘å…‰è®¾ç½®ä¸ºçº¢è‰²ï¼Œå¯ä»¥å¾—åˆ°ä¸‹é¢ç»“æœ</p><p><img src="/2024/08/05/Unity-SRP-03-%E5%9F%BA%E7%A1%80%E5%85%89%E7%85%A7/image-20240806211801014.png" alt="image-20240806211801014"></p><h3 id="å¯è§å…‰"><a href="#å¯è§å…‰" class="headerlink" title="å¯è§å…‰"></a>å¯è§å…‰</h3><p>å‰”é™¤æ—¶ï¼ŒUnityä¼šæ‰¾å‡ºå“ªäº›ç¯å…‰ä¼šå½±å“æ‘„åƒæœºå¯è§ç©ºé—´ï¼Œæˆ‘ä»¬å¯ä»¥ä¾èµ–è¿™äº›ä¿¡æ¯æ¥è·å–åœºæ™¯çš„å…‰æºä¿¡æ¯ã€‚</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">CullingResults cullingResults;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Setup</span> (<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">ScriptableRenderContext context, CullingResults cullingResults</span></span></span><br><span class="line"><span class="params"><span class="function"></span>)</span> &#123;</span><br><span class="line"><span class="keyword">this</span>.cullingResults = cullingResults;</span><br><span class="line">buffer.BeginSample(bufferName);</span><br><span class="line"><span class="comment">//SetupDirectionalLight();</span></span><br><span class="line">SetupLights();</span><br><span class="line">â€¦</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetupLights</span> ()</span> &#123;</span><br><span class="line">       <span class="comment">//é€šè¿‡å‰”é™¤ç»“æœæ£€ç´¢æ‰€éœ€çš„ç¯å…‰</span></span><br><span class="line">       NativeArray&lt;VisibleLight&gt; visibleLights = cullingResults.visibleLights;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="å¤šæ–¹å‘å…‰æº"><a href="#å¤šæ–¹å‘å…‰æº" class="headerlink" title="å¤šæ–¹å‘å…‰æº"></a>å¤šæ–¹å‘å…‰æº</h3><p>æ”¯æŒå¤šä¸ªå®šå‘å…‰æºï¼Œä½†æˆ‘ä»¬å¿…é¡»å°†æ‰€æœ‰è¿™äº›å…‰æºçš„æ•°æ®å‘é€åˆ°GPUï¼Œè¿™é‡Œä½¿ç”¨æ•°ç»„å­˜å‚¨å¤šä¸ªå…‰æºä¿¡æ¯ï¼Œå¹¶å°†å…‰æºæ•°é‡æœ€å¤§å€¼è®¾ç½®ä¸º4ã€‚</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="built_in">int</span> maxDirLightCount = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">int</span> dirLightCountId = Shader.PropertyToID(<span class="string">&quot;_DirectionalLightCount&quot;</span>),</span><br><span class="line">    dirLightColorsId = Shader.PropertyToID(<span class="string">&quot;_DirectionalLightColors&quot;</span>),</span><br><span class="line">    dirLightDirectionsId = Shader.PropertyToID(<span class="string">&quot;_DirectionalLightDirections&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> Vector4[]</span><br><span class="line">    dirLightColors = <span class="keyword">new</span> Vector4[maxDirLightCount],</span><br><span class="line">    dirLightDirections = <span class="keyword">new</span> Vector4[maxDirLightCount];</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ ¹æ®ç´¢å¼•å¡«å……ä¸€ä¸ªç‰¹å®šå…‰æºä¿¡æ¯</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetupDirectionalLight</span> (<span class="params"><span class="built_in">int</span> index, VisibleLight visibleLight</span>)</span> &#123;</span><br><span class="line">dirLightColors[index] = visibleLight.finalColor;</span><br><span class="line">dirLightDirections[index] = -visibleLight.localToWorldMatrix.GetColumn(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éå†æ‰€æœ‰å¯è§å…‰å¹¶è°ƒç”¨æ¯ä¸ªå…ƒç´ ï¼Œç„¶ååœ¨ç¼“å†²åŒºä¸Šå°†æ•°æ®å‘é€åˆ°GPUã€‚</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//éå†æ‰€æœ‰å…‰æºå¹¶å¡«å……å…‰æºæ•°ç»„</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetupLights</span>()</span> &#123;</span><br><span class="line">    NativeArray&lt;VisibleLight&gt; visibleLights = cullingResults.visibleLights;</span><br><span class="line">    <span class="built_in">int</span> dirLightCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; visibleLights.Length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        VisibleLight visibleLight = visibleLights[i];</span><br><span class="line">        <span class="comment">//åªæ”¯æŒæ–¹å‘å…‰</span></span><br><span class="line">        <span class="keyword">if</span> (visibleLight.lightType == LightType.Directional)</span><br><span class="line">        &#123;</span><br><span class="line">            SetupDirectionalLight(dirLightCount++, <span class="keyword">ref</span> visibleLight);</span><br><span class="line">            <span class="keyword">if</span> (dirLightCount &gt;= maxDirLightCount)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    buffer.SetGlobalInt(dirLightCountId, visibleLights.Length);</span><br><span class="line">    buffer.SetGlobalVectorArray(dirLightColorsId, dirLightColors);</span><br><span class="line">    buffer.SetGlobalVectorArray(dirLightDirectionsId, dirLightDirections);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç€è‰²å™¨å¾ªç¯"><a href="#ç€è‰²å™¨å¾ªç¯" class="headerlink" title="ç€è‰²å™¨å¾ªç¯"></a>ç€è‰²å™¨å¾ªç¯</h3><p>è°ƒæ•´ç¼“å†²åŒºï¼Œä½¿å…¶ä¸æ–°çš„æ•°æ®æ ¼å¼åŒ¹é…ã€‚æ•°ç»„åœ¨ç€è‰²å™¨ä¸­å…·æœ‰å›ºå®šå¤§å°ï¼Œæ— æ³•è°ƒæ•´å¤§å°ã€‚</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#define MAX_DIRECTIONAL_LIGHT_COUNT 4</span></span><br><span class="line"></span><br><span class="line">CBUFFER_START(_CustomLight)</span><br><span class="line"><span class="comment">//float4 _DirectionalLightColor;</span></span><br><span class="line"><span class="comment">//float4 _DirectionalLightDirection;</span></span><br><span class="line"><span class="type">int</span> _DirectionalLightCount;</span><br><span class="line">float4 _DirectionalLightColors[MAX_DIRECTIONAL_LIGHT_COUNT];</span><br><span class="line">float4 _DirectionalLightDirections[MAX_DIRECTIONAL_LIGHT_COUNT];</span><br><span class="line">CBUFFER_END</span><br></pre></td></tr></table></figure><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">float3 GetLighting (Surface surface) &#123;</span><br><span class="line">float3 color = <span class="number">0.0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; GetDirectionalLightCount(); i++) &#123;</span><br><span class="line">color += GetLighting(surface, GetDirectionalLight(i));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> color;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2024/08/05/Unity-SRP-03-%E5%9F%BA%E7%A1%80%E5%85%89%E7%85%A7/image-20240807103221717.png" alt="image-20240807103221717"></p><h3 id="ç€è‰²å™¨ç›®æ ‡çº§åˆ«"><a href="#ç€è‰²å™¨ç›®æ ‡çº§åˆ«" class="headerlink" title="ç€è‰²å™¨ç›®æ ‡çº§åˆ«"></a>ç€è‰²å™¨ç›®æ ‡çº§åˆ«</h3><p>å¯¹äºç€è‰²å™¨æ¥è¯´ï¼Œå…·æœ‰å¯å˜é•¿åº¦çš„å¾ªç¯æ›¾ç»æ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œä½†ç°ä»£ GPU å¯ä»¥æ¯«æ— é—®é¢˜åœ°å¤„ç†å®ƒä»¬ï¼Œå°¤å…¶æ˜¯å½“ç»˜åˆ¶è°ƒç”¨çš„æ‰€æœ‰ç‰‡æ®µéƒ½ä»¥ç›¸åŒçš„æ–¹å¼è¿­ä»£ç›¸åŒçš„æ•°æ®æ—¶ã€‚</p><p>ä½†æ˜¯ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒOpenGL ES 2.0 å’Œ WebGL 1.0 å›¾å½¢ API æ— æ³•å¤„ç†æ­¤ç±»å¾ªç¯ã€‚è™½ç„¶å¯ä»¥ç”¨å…¶ä»–æ–¹æ³•å®Œæˆè¿™é¡¹å·¥ä½œï¼Œä½†æ˜¯ä¼šä½¿å¾—ä»£ç å˜å¾—æ›´åŠ å¤æ‚ï¼Œå› æ­¤é€šè¿‡æŒ‡ä»¤å°†ç€è‰²å™¨é€šé“çš„ç›®æ ‡çº§åˆ«æé«˜åˆ° 3.5ã€‚</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HLSLPROGRAM</span><br><span class="line"><span class="meta">#pragma target 3.5</span></span><br><span class="line">â€¦</span><br><span class="line">ENDHLSL</span><br></pre></td></tr></table></figure><h2 id="BRDF"><a href="#BRDF" class="headerlink" title="BRDF"></a>BRDF</h2><p>æˆ‘ä»¬ç›®å‰æ­£åœ¨ä½¿ç”¨ä¸€ä¸ªéå¸¸ç®€å•çš„ç…§æ˜æ¨¡å‹ï¼Œä»…é€‚ç”¨äºå®Œå…¨æ¼«å°„çš„è¡¨é¢ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åº”ç”¨åŒå‘åå°„åˆ†å¸ƒå‡½æ•°ï¼ˆç®€ç§°BRDFï¼‰æ¥å®ç°æ›´å¤šæ ·åŒ–å’Œæ›´é€¼çœŸçš„ç…§æ˜ã€‚</p><p>åŸç†å°±ä¸è¿‡å¤šä»‹ç»äº†ï¼Œå¯ä»¥çœ‹Games101ã€‚</p><h3 id="è¡¨é¢ç‰¹æ€§"><a href="#è¡¨é¢ç‰¹æ€§" class="headerlink" title="è¡¨é¢ç‰¹æ€§"></a>è¡¨é¢ç‰¹æ€§</h3><p>è¿™é‡Œä½¿ç”¨é‡‘å±å·¥ä½œæµï¼Œéœ€è¦å‘ç€è‰²å™¨æ·»åŠ ä¸¤ä¸ªè¡¨é¢å±æ€§ã€‚</p><p>ç¬¬ä¸€ä¸ªå±æ€§æ˜¯è¡¨é¢æ˜¯é‡‘å±çš„è¿˜æ˜¯éé‡‘å±çš„ï¼Œå…¶ä¸­ 1 è¡¨ç¤ºå®ƒæ˜¯å®Œå…¨é‡‘å±çš„ã€‚é»˜è®¤å€¼ä¸ºå®Œå…¨ç”µä»‹è´¨ã€‚</p><p>ç¬¬äºŒä¸ªå±æ€§æ§åˆ¶è¡¨é¢çš„å…‰æ»‘ç¨‹åº¦ï¼Œå…¶ä¸­ 0 è¡¨ç¤ºå®Œå…¨ç²—ç³™ï¼Œ1 è¡¨ç¤ºå®Œå…¨å…‰æ»‘ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ 0.5 ä½œä¸ºé»˜è®¤å€¼ã€‚</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">_Metallic (&quot;Metallic&quot;, Range(<span class="number">0</span>, <span class="number">1</span>)) = <span class="number">0</span></span><br><span class="line">_Smoothness (&quot;Smoothness&quot;, Range(<span class="number">0</span>, <span class="number">1</span>)) = <span class="number">0.5</span></span><br></pre></td></tr></table></figure><p>å°†å±æ€§æ·»åŠ åˆ°ç¼“å†²åŒº</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">UNITY_INSTANCING_BUFFER_START(UnityPerMaterial)</span><br><span class="line">...</span><br><span class="line">UNITY_DEFINE_INSTANCED_PROP(<span class="type">float</span>, _Metallic)</span><br><span class="line">UNITY_DEFINE_INSTANCED_PROP(<span class="type">float</span>, _Smoothness)</span><br><span class="line">UNITY_INSTANCING_BUFFER_END(UnityPerMaterial)</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å°†é‡‘å±åº¦å’Œå¹³æ»‘åº¦æ·»åŠ åˆ°Surfaceä¸­</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">struct Surface &#123;</span><br><span class="line">...</span><br><span class="line"><span class="type">float</span> metallic;</span><br><span class="line"><span class="type">float</span> smoothness;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨ç‰‡å…ƒç€è‰²å™¨ä¸­ï¼Œè®¾ç½®è¡¨é¢å±æ€§</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">surface.metallic = UNITY_ACCESS_INSTANCED_PROP(UnityPerMaterial, _Metallic);</span><br><span class="line">surface.smoothness =</span><br><span class="line">UNITY_ACCESS_INSTANCED_PROP(UnityPerMaterial, _Smoothness);</span><br></pre></td></tr></table></figure><p>åœ¨<strong>PerObjectMaterialProperties</strong>ä¸­æ·»åŠ å¯¹å…¶çš„æ”¯æŒ</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="built_in">int</span></span><br><span class="line">baseColorId = Shader.PropertyToID(<span class="string">&quot;_BaseColor&quot;</span>),</span><br><span class="line">cutoffId = Shader.PropertyToID(<span class="string">&quot;_Cutoff&quot;</span>),</span><br><span class="line">metallicId = Shader.PropertyToID(<span class="string">&quot;_Metallic&quot;</span>),</span><br><span class="line">smoothnessId = Shader.PropertyToID(<span class="string">&quot;_Smoothness&quot;</span>);</span><br><span class="line"></span><br><span class="line">â€¦</span><br><span class="line"></span><br><span class="line">[<span class="meta">SerializeField, Range(0f, 1f)</span>]</span><br><span class="line"><span class="built_in">float</span> alphaCutoff = <span class="number">0.5f</span>, metallic = <span class="number">0f</span>, smoothness = <span class="number">0.5f</span>;</span><br><span class="line"></span><br><span class="line">â€¦</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OnValidate</span> ()</span> &#123;</span><br><span class="line">â€¦</span><br><span class="line">block.SetFloat(metallicId, metallic);</span><br><span class="line">block.SetFloat(smoothnessId, smoothness);</span><br><span class="line">GetComponent&lt;Renderer&gt;().SetPropertyBlock(block);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="BRDFå±æ€§"><a href="#BRDFå±æ€§" class="headerlink" title="BRDFå±æ€§"></a>BRDFå±æ€§</h3><p>æˆ‘ä»¬å•ç‹¬åˆ›å»ºä¸€ä¸ªBRDF.hlslæ–‡ä»¶ï¼Œæ¥è¡¨ç¤ºå¤šå°‘å…‰ä»è¡¨é¢åå°„ï¼ˆæ¼«åå°„+é•œé¢åå°„ï¼‰ï¼Œä»¥åŠè¡¨é¢çš„ç²—ç³™åº¦ã€‚</p><h3 id="åå°„ç‡"><a href="#åå°„ç‡" class="headerlink" title="åå°„ç‡"></a>åå°„ç‡</h3><p>è¡¨é¢çš„åå°„ç¨‹åº¦å„ä¸ç›¸åŒï¼Œä½†ä¸€èˆ¬æ¥è¯´ï¼Œ<u>é‡‘å±é€šè¿‡é•œé¢åå°„åå°„æ‰€æœ‰å…‰ï¼Œå¹¶ä¸”æ¼«åå°„ä¸ºé›¶</u>ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†å£°æ˜<u>åå°„ç‡ç­‰äºé‡‘å±è¡¨é¢å±æ€§</u>ã€‚è¢«åå°„çš„å…‰ä¸ä¼šè¢«æ¼«å°„ï¼Œå› æ­¤æˆ‘ä»¬åº”è¯¥å°†æ¼«å°„é¢œè‰²ç¼©æ”¾ 1 å‡å» ä¸­çš„åå°„ç‡ã€‚</p><p>æ ¹æ®èƒ½é‡å®ˆæ’ï¼Œå‡ºå°„å…‰ä¸èƒ½è¶…è¿‡å…¥å°„å…‰ï¼Œ<u>é•œé¢åå°„é¢œè‰²åº”ç­‰äºè¡¨é¢é¢œè‰²å‡å»æ¼«åå°„é¢œè‰²ã€‚</u></p><h3 id="ç²—ç³™åº¦"><a href="#ç²—ç³™åº¦" class="headerlink" title="ç²—ç³™åº¦"></a>ç²—ç³™åº¦</h3><p>ç²—ç³™åº¦ä¸å…‰æ»‘åº¦ç›¸åï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç®€å•åœ°å–ä¸€å‡å»å…‰æ»‘åº¦ã€‚æœ‰ä¸€ä¸ªå‡½æ•°PerceptualSmoothnessToPerceptualRoughnesså¯ä»¥æ‰§è¡Œæ­¤æ“ä½œï¼Œæˆ‘ä»¬å¼•å…¥CommonMaterial.hlsl</p><h3 id="è·å–æ–¹å‘"><a href="#è·å–æ–¹å‘" class="headerlink" title="è·å–æ–¹å‘"></a>è·å–æ–¹å‘</h3><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">surface.viewDirection = <span class="built_in">normalize</span>(_WorldSpaceCameraPos - input.positionWS);</span><br></pre></td></tr></table></figure><h3 id="é•œé¢åå°„å¼ºåº¦"><a href="#é•œé¢åå°„å¼ºåº¦" class="headerlink" title="é•œé¢åå°„å¼ºåº¦"></a>é•œé¢åå°„å¼ºåº¦</h3><p>é•œé¢åå°„å¼ºåº¦å…¬å¼è®¡ç®—å¦‚ä¸‹<br>$$<br>\frac{r^2}{d^2 \max \left(0.1,(L \cdot H)^2\right) n}<br>$$<br>å…¶ä¸­$d&#x3D;(NÂ·H)^2(r^2-1)+1.0001$ï¼ŒLæ˜¯å…‰çº¿æ–¹å‘ï¼ŒHæ˜¯L+Vå½’ä¸€åŒ–å‘é‡ï¼Œn&#x3D;4r+2æ˜¯å¸¸æ•°é¡¹ã€‚</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#include &quot;Packages/com.unity.render-pipelines.core/ShaderLibrary/CommonMaterial.hlsl&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#ifndef CUSTOM_BRDF_INCLUDED</span></span><br><span class="line"><span class="meta">#define CUSTOM_BRDF_INCLUDED</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#define MIN_REFLECTIVITY 0.04</span></span><br><span class="line"></span><br><span class="line">struct BRDF &#123;</span><br><span class="line">float3 diffuse;</span><br><span class="line">float3 specular;</span><br><span class="line"><span class="type">float</span> roughness;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å°†èŒƒå›´ä»[0,1]å˜æ¢åˆ°[0,0.96]</span></span><br><span class="line"><span class="type">float</span> OneMinusReflectivity (<span class="type">float</span> metallic) &#123;</span><br><span class="line"><span class="type">float</span> range = <span class="number">1.0</span> - MIN_REFLECTIVITY;</span><br><span class="line"><span class="keyword">return</span> range - metallic * range;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BRDF GetBRDF (Surface surface) &#123;</span><br><span class="line">BRDF brdf;</span><br><span class="line"><span class="type">float</span> oneMinusReflectivity = OneMinusReflectivity(surface.metallic);</span><br><span class="line">    <span class="comment">//æ¼«åå°„å¼ºåº¦æ˜¯1-åå°„ç‡</span></span><br><span class="line">brdf.diffuse = surface.color * oneMinusReflectivity;</span><br><span class="line">    <span class="comment">//é‡‘å±ä¼šå½±å“é•œé¢åå°„çš„é¢œè‰²ï¼Œè€Œéé‡‘å±åˆ™ä¸ä¼šã€‚ä»‹ç”µè¡¨é¢çš„é•œé¢åå°„é¢œè‰²åº”è¯¥æ˜¯ç™½è‰²ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨é‡‘å±å±æ€§åœ¨æœ€å°åå°„ç‡0.04å’Œè¡¨é¢é¢œè‰²ä¹‹é—´æ’å€¼æ¥å®ç°</span></span><br><span class="line">brdf.specular = lerp(MIN_REFLECTIVITY, surface.color, surface.metallic);</span><br><span class="line">    <span class="comment">//å…‰æ»‘åº¦è½¬ç²—ç³™åº¦</span></span><br><span class="line"><span class="type">float</span> perceptualRoughness = PerceptualSmoothnessToPerceptualRoughness(surface.smoothness);</span><br><span class="line">brdf.roughness = PerceptualRoughnessToRoughness(perceptualRoughness);</span><br><span class="line"><span class="keyword">return</span> brdf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¡ç®—é•œé¢åå°„å¼ºåº¦</span></span><br><span class="line"><span class="type">float</span> SpecularStrength (Surface surface, BRDF brdf, Light light) &#123;</span><br><span class="line">float3 h = SafeNormalize(light.direction + surface.viewDirection);</span><br><span class="line"><span class="type">float</span> nh2 = Square(saturate(<span class="built_in">dot</span>(surface.normal, h)));</span><br><span class="line"><span class="type">float</span> lh2 = Square(saturate(<span class="built_in">dot</span>(light.direction, h)));</span><br><span class="line"><span class="type">float</span> r2 = Square(brdf.roughness);</span><br><span class="line"><span class="type">float</span> d2 = Square(nh2 * (r2 - <span class="number">1.0</span>) + <span class="number">1.00001</span>);</span><br><span class="line"><span class="type">float</span> normalization = brdf.roughness * <span class="number">4.0</span> + <span class="number">2.0</span>;</span><br><span class="line"><span class="keyword">return</span> r2 / (d2 * <span class="built_in">max</span>(<span class="number">0.1</span>, lh2) * normalization);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿”å›è¡¨é¢çš„æ€»å…‰ç…§å¼ºåº¦ï¼ˆæ¼«åå°„+é•œé¢åå°„ï¼‰</span></span><br><span class="line">float3 DirectBRDF (Surface surface, BRDF brdf, Light light) &#123;</span><br><span class="line"><span class="keyword">return</span> SpecularStrength(surface, brdf, light) * brdf.specular + brdf.diffuse;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#endif</span></span><br></pre></td></tr></table></figure><p><img src="/2024/08/05/Unity-SRP-03-%E5%9F%BA%E7%A1%80%E5%85%89%E7%85%A7/image-20240807151646421.png" alt="image-20240807151646421"></p><h2 id="é€æ˜åº¦"><a href="#é€æ˜åº¦" class="headerlink" title="é€æ˜åº¦"></a>é€æ˜åº¦</h2><p>ä¸ºäº†å®ç°ç±»ä¼¼ç»ç’ƒçš„æ•ˆæœï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘é€æ˜åº¦</p><p>ä¸ºäº†å¼•å…¥é€æ˜åº¦ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®æ··åˆæ¨¡å¼</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Properties &#123;</span><br><span class="line">_Cutoff (&quot;Alpha Cutoff&quot;, Range(<span class="number">0.0</span>, <span class="number">1.0</span>)) = <span class="number">0.5</span></span><br><span class="line">[Toggle(_CLIPPING)] _Clipping (&quot;Alpha Clipping&quot;, Float) = <span class="number">0</span></span><br><span class="line">[Enum(UnityEngine.Rendering.BlendMode)] _SrcBlend (&quot;Src Blend&quot;, Float) = <span class="number">1</span></span><br><span class="line">[Enum(UnityEngine.Rendering.BlendMode)] _DstBlend (&quot;Dst Blend&quot;, Float) = <span class="number">0</span></span><br><span class="line">[Enum(Off, <span class="number">0</span>, On, <span class="number">1</span>)] _ZWrite (&quot;Z Write&quot;, Float) = <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SubShader &#123;</span><br><span class="line"></span><br><span class="line">Pass &#123;</span><br><span class="line">Blend [_SrcBlend] [_DstBlend]</span><br><span class="line">ZWrite [_ZWrite]</span><br><span class="line"></span><br><span class="line">HLSLPROGRAM</span><br><span class="line"><span class="meta">#pragma shader_feature _CLIPPING</span></span><br><span class="line">            ...</span><br><span class="line">ENDHLSL</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°†æ¼«åå°„å…‰æ·¡åŒ–ï¼Œå¹¶ä¿æŒé•œé¢åå°„å¼ºåº¦</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brdf.diffuse *= surface.alpha;</span><br></pre></td></tr></table></figure><img src="/2024/08/05/Unity-SRP-03-%E5%9F%BA%E7%A1%80%E5%85%89%E7%85%A7/image-20240807154553966.png" alt="image-20240807154553966" style="zoom:67%;"><p>æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªå®æ¥æ§åˆ¶æ˜¯å¦å°† alpha ä¸æ¼«åå°„è¿›è¡Œé¢„ä¹˜</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">BRDF GetBRDF (<span class="keyword">inout</span> Surface surface, <span class="type">bool</span> applyAlphaToDiffuse = <span class="literal">false</span>) &#123;</span><br><span class="line">â€¦</span><br><span class="line"><span class="keyword">if</span> (applyAlphaToDiffuse) &#123;</span><br><span class="line">brdf.diffuse *= surface.alpha;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">â€¦</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[Toggle(_PREMULTIPLY_ALPHA)] _PremulAlpha (&quot;Premultiply Alpha&quot;, Float) = <span class="number">0</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#pragma shader_feature _PREMULTIPLY_ALPHA</span></span><br><span class="line">   ...</span><br><span class="line"><span class="meta">#if defined(_PREMULTIPLY_ALPHA)</span></span><br><span class="line">BRDF brdf = GetBRDF(surface, <span class="literal">true</span>);</span><br><span class="line"><span class="meta">#else</span></span><br><span class="line">BRDF brdf = GetBRDF(surface);</span><br><span class="line"><span class="meta">#endif</span></span><br></pre></td></tr></table></figure><h3 id="ç€è‰²å™¨GUI"><a href="#ç€è‰²å™¨GUI" class="headerlink" title="ç€è‰²å™¨GUI"></a>ç€è‰²å™¨GUI</h3><p>è‡ªå®šä¹‰ç€è‰²å™¨GUIï¼Œåœ¨ç€è‰²å™¨åº•éƒ¨æ·»åŠ ä¸€ä¸ªè¯­å¥</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Shader &quot;Custom RP/Lit&quot; &#123;</span><br><span class="line">â€¦</span><br><span class="line"></span><br><span class="line">CustomEditor &quot;CustomShaderGUI&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ªCustomShaderGUIç±»ï¼Œç»§æ‰¿ShaderGUIï¼Œé‡å†™OnGUIæ–¹æ³•ã€‚</p><p>å¹¶ä¸”åˆ›å»ºä¸‰ä¸ªå±æ€§ï¼Œç¬¬ä¸€ä¸ªæ˜¯æè´¨ç¼–è¾‘å™¨ï¼Œå®ƒæ˜¯è´Ÿè´£æ˜¾ç¤ºå’Œç¼–è¾‘æè´¨çš„åº•å±‚ç¼–è¾‘å™¨å¯¹è±¡ã€‚ç¬¬äºŒä¸ªæ˜¯<u>å¯¹æ­£åœ¨ç¼–è¾‘çš„ææ–™çš„å¼•ç”¨</u>ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç¼–è¾‘å™¨çš„å±æ€§æ¥æ£€ç´¢ã€‚å®ƒè¢«å®šä¹‰ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œå› ä¸ºå®ƒæ˜¯é€šç”¨ç±»çš„ä¸€ä¸ªå±æ€§ã€‚ç¬¬ä¸‰æ˜¯å¯ä»¥ç¼–è¾‘çš„å±æ€§æ•°ç»„ã€‚</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEditor;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.Rendering;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomShaderGUI</span> : <span class="title">ShaderGUI</span></span><br><span class="line">&#123;</span><br><span class="line">    MaterialEditor editor;</span><br><span class="line">    Object[] materials;</span><br><span class="line">    MaterialProperty[] properties;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">bool</span> showPresets;   </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnGUI</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">        MaterialEditor materialEditor, MaterialProperty[] properties</span></span></span><br><span class="line"><span class="params"><span class="function">    </span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnGUI(materialEditor, properties);</span><br><span class="line">        editor = materialEditor;</span><br><span class="line">        materials = materialEditor.targets;</span><br><span class="line">        <span class="keyword">this</span>.properties = properties;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¾ç½®å±æ€§ï¼Œéœ€è¦åœ¨å±æ€§æ•°ç»„ä¸­æ‰¾åˆ°å®ƒï¼Œå…³é”®å­—åŒç†ã€‚</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="built_in">bool</span> <span class="title">SetProperty</span>(<span class="params"><span class="built_in">string</span> name, <span class="built_in">float</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    MaterialProperty property = FindProperty(name, properties, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (property != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        property.floatValue = <span class="keyword">value</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetKeyword</span>(<span class="params"><span class="built_in">string</span> keyword, <span class="built_in">bool</span> enabled</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (enabled)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (Material m <span class="keyword">in</span> materials)</span><br><span class="line">        &#123;</span><br><span class="line">            m.EnableKeyword(keyword);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (Material m <span class="keyword">in</span> materials)</span><br><span class="line">        &#123;</span><br><span class="line">            m.DisableKeyword(keyword);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetProperty</span>(<span class="params"><span class="built_in">string</span> name, <span class="built_in">string</span> keyword, <span class="built_in">bool</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (SetProperty(name, <span class="keyword">value</span> ? <span class="number">1f</span> : <span class="number">0f</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        SetKeyword(keyword, <span class="keyword">value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å°†æ§åˆ¶çš„å±æ€§è®¾ç½®setterå±æ€§ã€‚</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">bool</span> Clipping</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">set</span> =&gt; SetProperty(<span class="string">&quot;_Clipping&quot;</span>, <span class="string">&quot;_CLIPPING&quot;</span>, <span class="keyword">value</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">bool</span> PremultiplyAlpha</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">set</span> =&gt; SetProperty(<span class="string">&quot;_PremulAlpha&quot;</span>, <span class="string">&quot;_PREMULTIPLY_ALPHA&quot;</span>, <span class="keyword">value</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BlendMode SrcBlend</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">set</span> =&gt; SetProperty(<span class="string">&quot;_SrcBlend&quot;</span>, (<span class="built_in">float</span>)<span class="keyword">value</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BlendMode DstBlend</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">set</span> =&gt; SetProperty(<span class="string">&quot;_DstBlend&quot;</span>, (<span class="built_in">float</span>)<span class="keyword">value</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">bool</span> ZWrite</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">set</span> =&gt; SetProperty(<span class="string">&quot;_ZWrite&quot;</span>, <span class="keyword">value</span> ? <span class="number">1f</span> : <span class="number">0f</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é¢„è®¾æŒ‰é’®"><a href="#é¢„è®¾æŒ‰é’®" class="headerlink" title="é¢„è®¾æŒ‰é’®"></a>é¢„è®¾æŒ‰é’®</h3><p>é€šè¿‡GUI Layout.Buttonåˆ›å»ºä¸€ä¸ªæŒ‰é’®ï¼Œå¹¶ä¸ºå…¶å‘½åã€‚å¦‚æœè¯¥æ–¹æ³•è¿”å›ï¼Œè¡¨ç¤ºå·²ç»è¢«æŒ‰ä¸‹ã€‚åŒæ—¶æˆ‘ä»¬å‘ç¼–è¾‘å™¨æ³¨å†Œä¸€ä¸ªæ’¤æ¶ˆæ­¥éª¤ï¼Œè°ƒç”¨editor.RegisterPropertyChangeUndoæ¥å®ç°</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="built_in">bool</span> <span class="title">PresetButton</span>(<span class="params"><span class="built_in">string</span> name</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (GUILayout.Button(name))</span><br><span class="line">    &#123;</span><br><span class="line">        editor.RegisterPropertyChangeUndo(name);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OpaquePreset</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (PresetButton(<span class="string">&quot;Opaque&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        Clipping = <span class="literal">false</span>;</span><br><span class="line">        PremultiplyAlpha = <span class="literal">false</span>;</span><br><span class="line">        SrcBlend = BlendMode.One;</span><br><span class="line">        DstBlend = BlendMode.Zero;</span><br><span class="line">        ZWrite = <span class="literal">true</span>;</span><br><span class="line">        RenderQueue = RenderQueue.Geometry;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ClipPreset</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (PresetButton(<span class="string">&quot;Clip&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        Clipping = <span class="literal">true</span>;</span><br><span class="line">        PremultiplyAlpha = <span class="literal">false</span>;</span><br><span class="line">        SrcBlend = BlendMode.One;</span><br><span class="line">        DstBlend = BlendMode.Zero;</span><br><span class="line">        ZWrite = <span class="literal">true</span>;</span><br><span class="line">        RenderQueue = RenderQueue.AlphaTest;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FadePreset</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (PresetButton(<span class="string">&quot;Fade&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        Clipping = <span class="literal">false</span>;</span><br><span class="line">        PremultiplyAlpha = <span class="literal">false</span>;</span><br><span class="line">        SrcBlend = BlendMode.SrcAlpha;</span><br><span class="line">        DstBlend = BlendMode.OneMinusSrcAlpha;</span><br><span class="line">        ZWrite = <span class="literal">false</span>;</span><br><span class="line">        RenderQueue = RenderQueue.Transparent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TransparentPreset</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (HasPremultiplyAlpha &amp;&amp; PresetButton(<span class="string">&quot;Transparent&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        Clipping = <span class="literal">false</span>;</span><br><span class="line">        PremultiplyAlpha = <span class="literal">true</span>;</span><br><span class="line">        SrcBlend = BlendMode.One;</span><br><span class="line">        DstBlend = BlendMode.OneMinusSrcAlpha;</span><br><span class="line">        ZWrite = <span class="literal">false</span>;</span><br><span class="line">        RenderQueue = RenderQueue.Transparent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨OnGUIæ–¹æ³•ä¸­è°ƒç”¨é¢„è®¾æ–¹æ³•ï¼Œä½¿å…¶æ˜¾ç¤ºåœ¨ç¼–è¾‘å™¨ä¸­</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnGUI</span> (<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">MaterialEditor materialEditor, MaterialProperty[] properties</span></span></span><br><span class="line"><span class="params"><span class="function"></span>)</span> &#123;</span><br><span class="line">â€¦</span><br><span class="line"></span><br><span class="line">OpaquePreset();</span><br><span class="line">ClipPreset();</span><br><span class="line">FadePreset();</span><br><span class="line">TransparentPreset();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2024/08/05/Unity-SRP-03-%E5%9F%BA%E7%A1%80%E5%85%89%E7%85%A7/image-20240807205958865.png" alt="image-20240807205958865" style="zoom:67%;"><h3 id="å¥å£®æ€§"><a href="#å¥å£®æ€§" class="headerlink" title="å¥å£®æ€§"></a>å¥å£®æ€§</h3><p>è€ƒè™‘åˆ°éƒ¨åˆ†æè´¨æ²¡æœ‰å¦‚ä¸Šå±æ€§ï¼Œä¼šæŠ¥é”™ï¼Œåœ¨SetPropertyæ—¶æˆ‘ä»¬éœ€è¦é€šè¿‡æŸ¥æ‰¾å±æ€§æ¥è§„é¿è¯¥é—®é¢˜ï¼Œå› ä¸ºæ¯”è¾ƒç®€å•ï¼Œè¯¦æƒ…è§å‚è€ƒæ–‡ç« ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p><hr><p><strong>å‚è€ƒæ–‡ç« </strong></p><p><a href="https://catlikecoding.com/unity/tutorials/custom-srp/directional-lights/">å¹³è¡Œå…‰ (catlikecoding.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> Unity SRP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸¸æˆæ¸²æŸ“ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åˆæ‰¹åŠGPUå®ä¾‹åŒ–</title>
      <link href="/2024/07/28/%E5%90%88%E6%89%B9%E5%8F%8AGPU%E5%AE%9E%E4%BE%8B%E5%8C%96/"/>
      <url>/2024/07/28/%E5%90%88%E6%89%B9%E5%8F%8AGPU%E5%AE%9E%E4%BE%8B%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h1 id="åˆæ‰¹åŠGPUå®ä¾‹åŒ–"><a href="#åˆæ‰¹åŠGPUå®ä¾‹åŒ–" class="headerlink" title="åˆæ‰¹åŠGPUå®ä¾‹åŒ–"></a>åˆæ‰¹åŠGPUå®ä¾‹åŒ–</h1><table><tr><td bgcolor="MintCream">æœ¬æ–‡é‡ç‚¹ï¼š<br>    <ul>        <li>é™æ€æ‰¹å¤„ç†</li>        <li>åŠ¨æ€æ‰¹å¤„ç†</li>        <li>SRP Batcher</li>        <li>GPU Instancing</li>    </ul> </td></tr></table><h2 id="æ‰¹é‡æ¸²æŸ“"><a href="#æ‰¹é‡æ¸²æŸ“" class="headerlink" title="æ‰¹é‡æ¸²æŸ“"></a>æ‰¹é‡æ¸²æŸ“</h2><p>ä¸€èˆ¬è¢«å«åšâ€åˆæ‰¹â€œã€‚</p><p>æ‰¹é‡æ¸²æŸ“æ˜¯é€šè¿‡å‡å°‘CPUå‘GPU <strong>å‘é€æ¸²æŸ“å‘½ä»¤ï¼ˆDrawCallï¼‰çš„æ¬¡æ•°ï¼Œä»¥åŠå‡å°‘GPUåˆ‡æ¢æ¸²æŸ“çŠ¶æ€çš„æ¬¡æ•°</strong>ï¼Œå°½é‡è®©GPUä¸€æ¬¡å¤šåšä¸€äº›äº‹æƒ…ï¼Œæ¥æå‡é€»è¾‘çº¿å’Œæ¸²æŸ“çº¿çš„æ•´ä½“æ•ˆç‡ã€‚</p><h3 id="Draw-Callæ€§èƒ½æ¶ˆè€—åŸå› "><a href="#Draw-Callæ€§èƒ½æ¶ˆè€—åŸå› " class="headerlink" title="Draw Callæ€§èƒ½æ¶ˆè€—åŸå› "></a>Draw Callæ€§èƒ½æ¶ˆè€—åŸå› </h3><p>åº”ç”¨ä¸­æ¯æ¬¡æ¸²æŸ“ï¼ŒAPIè°ƒç”¨éƒ½ä¼šç»è¿‡â€Application -&gt; Runtime -&gt; Driver -&gt; GPU â€œ çš„è¿‡ç¨‹ã€‚**Runtime (è¿è¡Œæ—¶ç¯å¢ƒ)**è´Ÿè´£è§£é‡Šå’Œæ‰§è¡Œåº”ç”¨å±‚è°ƒç”¨çš„å›¾å½¢æŒ‡ä»¤ï¼ŒRuntime ä¼šå°†è¿™äº›é«˜å±‚æ¬¡çš„ç»˜åˆ¶è°ƒç”¨è½¬åŒ–ä¸ºåº•å±‚çš„å›¾å½¢æŒ‡ä»¤ï¼Œå¹¶è¿›è¡Œå¿…è¦çš„ç®¡ç†å·¥ä½œï¼Œæ¯”å¦‚çŠ¶æ€è®¾ç½®ã€èµ„æºç®¡ç†ç­‰ã€‚</p><p>å…¶ä¸­Draw Callæ€§èƒ½æ¶ˆè€—åŸå› æ˜¯ï¼Œå‘½ä»¤ä»Runtimeåˆ°Driverçš„è¿‡ç¨‹ä¸­ï¼Œæ“ä½œç³»ç»Ÿè¦å‘ç”Ÿ<u>ç”¨æˆ·æ¨¡å¼åˆ°å†…æ ¸æ¨¡å¼çš„åˆ‡æ¢</u>ï¼Œè€Œæ¨¡å¼åˆ‡æ¢å¯¹CPUæ¥è¯´æ˜¯æ„è§éå¸¸è€—æ—¶çš„å·¥ä½œã€‚</p><p>Runtimeä¸­çš„<u>Command Bufferå¯ä»¥å°†ä¸€äº›æ²¡æœ‰å¿…è¦é©¬ä¸Šå‘é€ç»™Driverçš„å‘½ä»¤ç¼“å†²èµ·æ¥</u>ï¼Œåœ¨é€‚å½“çš„æ—¶æœº<u>ä¸€èµ·å‘é€ç»™Driver</u>ï¼Œè¿›è€Œåœ¨æ˜¾å¡æ‰§è¡Œã€‚ä»¥è¿™æ ·çš„æ–¹å¼æ¥å¯»æ±‚æœ€å°‘çš„CPUæ¨¡å¼åˆ‡æ¢ï¼Œæå‡æ•ˆç‡ã€‚</p><h3 id="åˆæ‰¹æŠ€æœ¯åˆåˆ†ä¸ºç¦»çº¿åˆæ‰¹å’Œå®æ—¶åˆæ‰¹"><a href="#åˆæ‰¹æŠ€æœ¯åˆåˆ†ä¸ºç¦»çº¿åˆæ‰¹å’Œå®æ—¶åˆæ‰¹" class="headerlink" title="åˆæ‰¹æŠ€æœ¯åˆåˆ†ä¸ºç¦»çº¿åˆæ‰¹å’Œå®æ—¶åˆæ‰¹"></a>åˆæ‰¹æŠ€æœ¯åˆåˆ†ä¸ºç¦»çº¿åˆæ‰¹å’Œå®æ—¶åˆæ‰¹</h3><p>ç¦»çº¿åˆæ‰¹å°±æ˜¯åœ¨æ¸¸æˆè¿è¡Œå‰ï¼ŒæŠŠç›¸å…³èµ„æºåˆæ‰¹å¤„ç†ï¼Œå‡è½»å¼•æ“å®æ—¶æ¸²æŸ“çš„è´Ÿæ‹…ã€‚</p><p>ä¸‹é¢è¦è®²çš„å°±æ˜¯å®æ—¶åˆæ‰¹ã€‚</p><h2 id="é™æ€æ‰¹å¤„ç†"><a href="#é™æ€æ‰¹å¤„ç†" class="headerlink" title="é™æ€æ‰¹å¤„ç†"></a>é™æ€æ‰¹å¤„ç†</h2><p>è¡¨æ˜ä¸ºStaticçš„é™æ€ç‰©ä½“ï¼Œåœ¨ä½¿ç”¨ç›¸åŒæè´¨çƒçš„å‰æä¸‹ï¼Œåœ¨Buildé¡¹ç›®æ‰“åŒ…æ—¶ï¼ŒUnityä¼šè‡ªåŠ¨åœ°æå–è¿™äº›å…±äº«æè´¨çš„é™æ€æ¨¡å‹çš„Vertex bufferå’ŒIndex bufferã€‚æ ¹æ®å…¶æ‘†æ”¾åœ¨åœºæ™¯ä¸­çš„ä½ç½®ç­‰æœ€ç»ˆçŠ¶æ€ä¿¡æ¯ï¼Œå°†è¿™äº›æ¨¡å‹çš„é¡¶ç‚¹æ•°æ®å˜æ¢åˆ°ä¸–ç•Œç©ºé—´ä¸‹ï¼Œå­˜å‚¨åœ¨æ–°æ„å»ºçš„å¤§Vertex bufferå’ŒIndex bufferä¸­ã€‚å¹¶ä¸”è®°å½•æ¯ä¸€ä¸ªå­æ¨¡å‹çš„Index bufferæ•°æ®åœ¨æ„å»ºçš„å¤§Index bufferä¸­çš„èµ·å§‹åŠç»“æŸä½ç½®ã€‚</p><p><img src="/2024/07/28/%E5%90%88%E6%89%B9%E5%8F%8AGPU%E5%AE%9E%E4%BE%8B%E5%8C%96/image-20240728141519184.png" alt="image-20240728141519184"></p><p>åœ¨åç»­çš„ç»˜åˆ¶è¿‡ç¨‹ä¸­ï¼Œä¸€æ¬¡æ€§æäº¤æ•´ä¸ªåˆå¹¶æ¨¡å‹çš„é¡¶ç‚¹æ•°æ®ï¼Œæ ¹æ®å¼•æ“çš„åœºæ™¯ç®¡ç†ç³»ç»Ÿåˆ¤æ–­å„ä¸ªå­æ¨¡å‹çš„å¯è§æ€§ã€‚ç„¶åè®¾ç½®ä¸€æ¬¡æ¸²æŸ“çŠ¶æ€ï¼Œè°ƒç”¨å¤šæ¬¡Draw callåˆ†åˆ«ç»˜åˆ¶æ¯ä¸€ä¸ªå­æ¨¡å‹ã€‚</p><p>Static batchingå¹¶<strong>ä¸å‡å°‘Draw callçš„æ•°é‡</strong></p><h4 id="å‰æ"><a href="#å‰æ" class="headerlink" title="å‰æ"></a>å‰æ</h4><ol><li>å…±äº«ç›¸åŒæè´¨ã€è¿è¡Œæ—¶ä¸èƒ½æ”¹å˜Transform</li></ol><h4 id="ä¼˜ç‚¹"><a href="#ä¼˜ç‚¹" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h4><ol><li><p>ç”¨ç©ºé—´æ¢æ—¶é—´ï¼Œæå‡äº†æ¸²æŸ“æ•ˆç‡ã€‚</p><p>ç”±äºæˆ‘ä»¬é¢„å…ˆæŠŠæ‰€æœ‰çš„å­æ¨¡å‹çš„é¡¶ç‚¹å˜æ¢åˆ°äº†ä¸–ç•Œç©ºé—´ä¸‹ï¼Œæ‰€ä»¥åœ¨<u>è¿è¡Œæ—¶cpuä¸éœ€è¦å†æ¬¡æ‰§è¡Œé¡¶ç‚¹å˜æ¢æ“ä½œ</u>ï¼ŒèŠ‚çº¦äº†å°‘é‡çš„è®¡ç®—èµ„æºï¼›å¹¶ä¸”è¿™äº›å­æ¨¡å‹<u>å…±äº«æè´¨ï¼Œæ‰€ä»¥åœ¨å¤šæ¬¡Draw callè°ƒç”¨ä¹‹é—´å¹¶æ²¡æœ‰æ¸²æŸ“çŠ¶æ€</u>çš„åˆ‡æ¢ï¼ˆä¸éœ€è¦é‡æ–°ç»‘å®šé¡¶ç‚¹æ•°æ®ã€ç´¢å¼•æ•°æ®ã€æŒ‡å®šå½“å‰ä½¿ç”¨çš„ç€è‰²å™¨ç­‰ï¼‰</p></li></ol><h4 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h4><ol><li><p>æ‰“åŒ…ä¹‹åä½“ç§¯å¢å¤§ï¼Œ<u>åº”ç”¨è¿è¡Œæ—¶æ‰€å ç”¨çš„å†…å­˜ä½“ç§¯ä¹Ÿä¼šå¢å¤§</u>ï¼Œéœ€è¦é¢å¤–å†…å­˜å­˜å‚¨åˆå¹¶çš„å‡ ä½•ä½“ã€‚</p><p>ã€åœ¨å¾ˆå¤šä¸åŒçš„GameObjectå¼•ç”¨åŒä¸€æ¨¡å‹çš„æƒ…å†µä¸‹ï¼Œä¸å¼€å¯Static batchingï¼ŒGameObjectå…±äº«çš„æ¨¡å‹ä¼šåœ¨åº”ç”¨ç¨‹åºåŒ…å†…æˆ–è€…å†…å­˜ä¸­<u>åªå­˜åœ¨ä¸€ä»½</u>ï¼Œç»˜åˆ¶çš„æ—¶å€™æäº¤æ¨¡å‹é¡¶ç‚¹ä¿¡æ¯ï¼Œç„¶åè®¾ç½®æ¯ä¸€ä¸ªGameObjecçš„æè´¨ä¿¡æ¯ï¼Œåˆ†åˆ«è°ƒç”¨æ¸²æŸ“APIç»˜åˆ¶ï¼›å¼€å¯Static batchingï¼Œåœ¨Unityæ‰§è¡ŒBuildçš„æ—¶å€™ï¼Œåœºæ™¯ä¸­<u>æ‰€æœ‰å¼•ç”¨ç›¸åŒæ¨¡å‹çš„GameObjectéƒ½å¿…é¡»å°†æ¨¡å‹é¡¶ç‚¹ä¿¡æ¯å¤åˆ¶</u>ï¼Œå¹¶ç»è¿‡è®¡ç®—å˜åŒ–åˆ°æœ€ç»ˆåœ¨ä¸–ç•Œç©ºé—´ä¸­ï¼Œ<u>å­˜å‚¨åœ¨æœ€ç»ˆç”Ÿæˆçš„Vertex bufferä¸­</u>ã€‚è¿™å°±å¯¼è‡´äº†æ‰“åŒ…çš„ä½“ç§¯åŠè¿è¡Œæ—¶å†…å­˜çš„å ç”¨å¢å¤§ã€‚ã€‘</p></li><li><p>é™æ€åˆæ‰¹åœ¨å¤§å¤šæ•°å¹³å°ä¸Šçš„é™åˆ¶æ˜¯64ké¡¶ç‚¹å’Œ64kç´¢å¼•</p></li></ol><p><img src="/2024/07/28/%E5%90%88%E6%89%B9%E5%8F%8AGPU%E5%AE%9E%E4%BE%8B%E5%8C%96/static.png" alt="img"></p><h3 id="åŠ¨æ€æ‰¹å¤„ç†"><a href="#åŠ¨æ€æ‰¹å¤„ç†" class="headerlink" title="åŠ¨æ€æ‰¹å¤„ç†"></a>åŠ¨æ€æ‰¹å¤„ç†</h3><p>åœ¨ä½¿ç”¨<strong>ç›¸åŒæè´¨çƒ</strong>çš„æƒ…å†µä¸‹ï¼ŒUnityä¼šåœ¨è¿è¡Œæ—¶å¯¹äº<strong>æ­£åœ¨è§†é‡ä¸­</strong>çš„ç¬¦åˆæ¡ä»¶çš„<u>åŠ¨æ€å¯¹è±¡</u>åœ¨ä¸€ä¸ªDraw callå†…ç»˜åˆ¶ï¼Œæ‰€ä»¥<strong>ä¼šé™ä½Draw Calls</strong>çš„æ•°é‡ã€‚</p><p>Dynamic batchingçš„åŸç†ä¹Ÿå¾ˆç®€å•ï¼Œåœ¨è¿›è¡Œåœºæ™¯ç»˜åˆ¶ä¹‹å‰å°†<u>æ‰€æœ‰çš„å…±äº«åŒä¸€æè´¨çš„æ¨¡å‹çš„é¡¶ç‚¹ä¿¡æ¯å˜æ¢åˆ°ä¸–ç•Œç©ºé—´</u>ä¸­ï¼Œç„¶åé€šè¿‡ä¸€æ¬¡Draw callç»˜åˆ¶å¤šä¸ªæ¨¡å‹ï¼Œè¾¾åˆ°åˆæ‰¹çš„ç›®çš„ã€‚æ¨¡å‹é¡¶ç‚¹å˜æ¢çš„æ“ä½œæ˜¯ç”±CPUå®Œæˆçš„ï¼Œæ‰€ä»¥è¿™ä¼šå¸¦æ¥ä¸€äº›CPUçš„æ€§èƒ½æ¶ˆè€—ã€‚å¹¶ä¸”è®¡ç®—çš„æ¨¡å‹é¡¶ç‚¹æ•°é‡ä¸å®œå¤ªå¤šï¼Œå¦åˆ™CPUä¸²è¡Œè®¡ç®—è€—è´¹çš„æ—¶é—´å¤ªé•¿ä¼šé€ æˆåœºæ™¯æ¸²æŸ“å¡é¡¿ï¼Œæ‰€ä»¥Dynamic batchingåªèƒ½<u>å¤„ç†ä¸€äº›å°æ¨¡å‹</u>ã€‚</p><h4 id="é™åˆ¶"><a href="#é™åˆ¶" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h4><ol><li>900ä¸ªé¡¶ç‚¹ä»¥ä¸‹çš„æ¨¡å‹ã€‚</li><li>å¦‚æœæˆ‘ä»¬ä½¿ç”¨äº†é¡¶ç‚¹åæ ‡ï¼Œæ³•çº¿ï¼ŒUVï¼Œé‚£ä¹ˆå°±åªèƒ½æœ€å¤š300ä¸ªé¡¶ç‚¹ã€‚</li><li>å¦‚æœä¸¤ä¸ªæ¨¡å‹<strong>ç¼©æ”¾å¤§å°ä¸åŒï¼Œä¸èƒ½è¢«åˆæ‰¹çš„</strong>ï¼Œå³æ¨¡å‹ä¹‹é—´çš„ç¼©æ”¾å¿…é¡»ä¸€è‡´ã€‚</li><li><strong>ä½¿ç”¨å¤šä¸ªpassçš„Shaderä¸ä¼šè¢«åˆæ‰¹</strong></li><li>æè´¨çƒå®ä¾‹å¿…é¡»ç›¸åŒï¼Œ<strong>æ¯ä¸ªç‰©ä½“æè´¨çƒå±æ€§å¿…é¡»ä¸€è‡´</strong></li></ol><p><img src="/2024/07/28/%E5%90%88%E6%89%B9%E5%8F%8AGPU%E5%AE%9E%E4%BE%8B%E5%8C%96/dy.png" alt="image-20240728152336622"></p><h3 id="GPU-Instancing"><a href="#GPU-Instancing" class="headerlink" title="GPU Instancing"></a>GPU Instancing</h3><p>å¯¹ä½¿ç”¨<strong>ç›¸åŒæè´¨ã€ç›¸åŒç½‘æ ¼</strong>çš„ç‰©ä½“ï¼Œå¯¹è§†é‡ä¸­ç¬¦åˆè¦æ±‚çš„æ‰€æœ‰å¯¹è±¡ä½¿ç”¨Constant Bufferï¼ˆCBufferï¼‰å°†ä¿¡æ¯ä¿å­˜åœ¨æ˜¾å­˜çš„â€å¸¸é‡ç¼“å†²åŒºâ€œä¸­ï¼Œç„¶åä»ä¸­æŠ½å–ä¸€ä¸ªå¯¹è±¡ä½œä¸ºå®ä¾‹é€å…¥æ¸²æŸ“æµç¨‹ã€‚</p><p>å½“åœ¨æ‰§è¡ŒDrawCallæ“ä½œåï¼Œä»æ˜¾å­˜ä¸­å–å‡ºå®ä¾‹çš„éƒ¨åˆ†å…±äº«ä¿¡æ¯ä¸ä»GPUå¸¸é‡ç¼“å†²å™¨ä¸­å–å‡ºå¯¹åº”å¯¹è±¡ï¼ˆé€šè¿‡æ•°ç»„ç´¢å¼•å¿«é€Ÿè·å–ï¼‰çš„ç›¸å…³ä¿¡æ¯ä¸€å¹¶ä¼ é€’åˆ°ä¸‹ä¸€æ¸²æŸ“é˜¶æ®µ</p><h4 id="é™åˆ¶-1"><a href="#é™åˆ¶-1" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h4><p>ç¢äºç¼“å­˜åŒºçš„å¤§å°é™åˆ¶ï¼Œæ¯ä¸€ä¸ªConstant Bufferçš„å¤§å°è¦ä¸¥æ ¼é™åˆ¶ï¼ˆä¸å¾—å¤§äº64kï¼‰</p><h4 id="ä¼˜ç‚¹-1"><a href="#ä¼˜ç‚¹-1" class="headerlink" title="ä¼˜ç‚¹"></a><strong>ä¼˜ç‚¹</strong></h4><p>åˆæ‰¹çš„ç‰©ä½“ï¼Œç›¸å¯¹åŠ¨æ€æ‰¹å¤„ç†ï¼Œå…è®¸ä½¿ç”¨ç»Ÿä¸€æè´¨ä¸”å¯¹åº”çš„æè´¨å±æ€§ï¼ˆæè´¨å±æ€§ç»“æ„éœ€è¦ä¿æŒä¸€è‡´ï¼‰</p><p><img src="/2024/07/28/%E5%90%88%E6%89%B9%E5%8F%8AGPU%E5%AE%9E%E4%BE%8B%E5%8C%96/image-20240728153406766.png" alt="image-20240728153406766"></p><h3 id="SRP-Batcher"><a href="#SRP-Batcher" class="headerlink" title="SRP Batcher"></a>SRP Batcher</h3><p>åœ¨ä½¿ç”¨LWRPæˆ–è€…HWRPæ—¶ï¼Œå¼€å¯SRP Batcherçš„æƒ…å†µä¸‹ï¼Œåªè¦ç‰©ä½“çš„<strong>Shaderä¸­å˜ä½“</strong>ä¸€è‡´ï¼Œå°±å¯ä»¥å¯ç”¨SRP BatcheråŠ é€Ÿã€‚</p><p>ä¸GPU InstancingåŸç†ç›¸ä¼¼ï¼Œä¸åŒçš„æ˜¯**<u>å› ä¸ºä¸ç”¨é‡æ–°åˆ›å»ºConstant Buffer[æ¯æ¬¡åªéœ€è¦åœ¨Bufferä¸Šè¿›è¡Œæ›´æ–°å’Œæ·»åŠ ]ï¼Œæ‰€ä»¥æœ¬è´¨ä¸ŠSRP Batcherä¸ä¼šé™ä½Draw Callsçš„æ•°é‡ï¼Œå®ƒåªä¼šé™ä½Draw Callsä¹‹é—´çš„GPUè®¾ç½®æˆæœ¬</u>**</p><h4 id="é™åˆ¶-2"><a href="#é™åˆ¶-2" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h4><p>Shaderå˜ä½“ä¸åŒæ— æ³•åˆå¹¶ï¼Œæ¯”å¦‚åŒä¸€ä¸ªShaderåˆ›å»ºçš„æè´¨ï¼Œä½†æ˜¯æè´¨é€‰é¡¹ä¸åŒ</p><p><img src="/2024/07/28/%E5%90%88%E6%89%B9%E5%8F%8AGPU%E5%AE%9E%E4%BE%8B%E5%8C%96/image-20240727223106405.png" alt="image-srp2"></p><p><img src="/2024/07/28/%E5%90%88%E6%89%B9%E5%8F%8AGPU%E5%AE%9E%E4%BE%8B%E5%8C%96/srp.png" alt="image-srp"></p><hr><p><strong>å‚è€ƒæ–‡ç« </strong></p><p><a href="https://blog.csdn.net/chqj_163/article/details/117191293">ã€Unityæ¸¸æˆå¼€å‘ã€‘é™æ€ã€åŠ¨æ€åˆæ‰¹ä¸GPU Instancing-CSDNåšå®¢</a></p><p><a href="https://zhuanlan.zhihu.com/p/98642798">å…³äºé™æ€æ‰¹å¤„ç†&#x2F;åŠ¨æ€æ‰¹å¤„ç†&#x2F;GPU Instancing &#x2F;SRP Batcherçš„è¯¦ç»†å‰–æ - çŸ¥ä¹ (zhihu.com)</a></p><hr><p><strong>å¾…å­¦ä¹ </strong></p><p><a href="https://zhuanlan.zhihu.com/p/34499251">U3Dä¼˜åŒ–æ‰¹å¤„ç†-GPU Instancingäº†è§£ä¸€ä¸‹ - çŸ¥ä¹ (zhihu.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> æ¸²æŸ“åŸºç¡€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ‰¹å¤„ç† </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Unity SRP 02-ç»˜åˆ¶è°ƒç”¨</title>
      <link href="/2024/07/27/Unity-SRP-02-%E7%BB%98%E5%88%B6%E8%B0%83%E7%94%A8/"/>
      <url>/2024/07/27/Unity-SRP-02-%E7%BB%98%E5%88%B6%E8%B0%83%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<hr><h1 id="Unity-SRP-02-ç€è‰²å™¨å’Œæ‰¹å¤„ç†"><a href="#Unity-SRP-02-ç€è‰²å™¨å’Œæ‰¹å¤„ç†" class="headerlink" title="Unity SRP 02-ç€è‰²å™¨å’Œæ‰¹å¤„ç†"></a>Unity SRP 02-ç€è‰²å™¨å’Œæ‰¹å¤„ç†</h1><table><tr><td bgcolor="MintCream">æœ¬æ–‡é‡ç‚¹ï¼š<br>    <ul>        <li>HLSLç€è‰²å™¨</li>        <li>å¸¸é‡ç¼“å†²åŒº</li>        <li>æ”¯æŒåŠ¨æ€æ‰¹å¤„ç†å’ŒGPU Instancing</li>    </ul> </td></tr></table><h2 id="ç€è‰²å™¨"><a href="#ç€è‰²å™¨" class="headerlink" title="ç€è‰²å™¨"></a>ç€è‰²å™¨</h2><p>åˆ›å»ºä¸€ä¸ªæ–°Unlit Shaderã€‚</p><p>ã€ä¹‹å‰çœ‹å®Œäº†ã€ŠUnity Shaderå…¥é—¨ç²¾è¦ã€‹ï¼ŒCGè¯­è¨€ç›¸å¯¹æŒæ¡æŒæ¡ç†Ÿç»ƒä¸€ç‚¹ï¼Œè¿™é‡Œè·Ÿç€æ•™ç¨‹ç”¨HLSLç¼–å†™ç€è‰²å™¨ã€‘</p><p><em><strong>Unlit.shader</strong></em></p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Shader&quot;Custom RP/Unlit&quot; &#123;</span><br><span class="line"></span><br><span class="line">Properties &#123;&#125;</span><br><span class="line"></span><br><span class="line">SubShader &#123;</span><br><span class="line"></span><br><span class="line">Pass &#123;</span><br><span class="line">HLSLPROGRAM</span><br><span class="line"><span class="meta">#pragma vertex UnlitPassVertex</span></span><br><span class="line"><span class="meta">#pragma fragment UnlitPassFragment</span></span><br><span class="line"><span class="meta">#include &quot;UnlitPass.hlsl&quot;</span></span><br><span class="line">ENDHLSL</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em><strong>UnlitPass.hlsl</strong></em></p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//é˜²æ­¢é‡å¤å®šä¹‰</span></span><br><span class="line"><span class="meta">#ifndef CUSTOM_UNLIT_PASS_INCLUDED</span></span><br><span class="line"><span class="meta">#define CUSTOM_UNLIT_PASS_INCLUDED</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#include &quot;../ShaderLibrary/Common.hlsl&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//åœ¨è¿™é‡Œå®šä¹‰é¡¶ç‚¹ã€ç‰‡å…ƒç€è‰²å™¨</span></span><br><span class="line">float4 UnlitPassVertex(float3 positionOS : POSITION) : SV_POSITION &#123;</span><br><span class="line">float3 positionWS = TransformObjectToWorld(positionOS.xyz);</span><br><span class="line"><span class="keyword">return</span> TransformWorldToHClip(positionWS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">float4 UnlitPassFragment() : SV_TARGET &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0.0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#endif</span></span><br></pre></td></tr></table></figure><p><em><strong>Common.hlsl</strong></em></p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#ifndef CUSTOM_COMMON_INCLUDED</span></span><br><span class="line"><span class="meta">#define CUSTOM_COMMON_INCLUDED</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#include &quot;UnityInput.hlsl&quot;</span></span><br><span class="line"></span><br><span class="line">float3 TransformObjectToWorld(float3 positionOS) &#123;</span><br><span class="line"><span class="keyword">return</span> mul(unity_ObjectToWorld, float4(positionOS, <span class="number">1.0</span>)).xyz;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">float4 TransformWorldToHClip(float3 positionWS) &#123;</span><br><span class="line"><span class="keyword">return</span> mul(unity_MatrixVP, float4(positionWS, <span class="number">1.0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#endif</span></span><br></pre></td></tr></table></figure><p><em><strong>UnityInput.hlsl</strong></em></p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#ifndef CUSTOM_UNITY_INPUT_INCLUDED</span></span><br><span class="line"><span class="meta">#define CUSTOM_UNITY_INPUT_INCLUDED</span></span><br><span class="line"></span><br><span class="line">float4x4 unity_ObjectToWorld;</span><br><span class="line">float4x4 unity_MatrixVP;</span><br><span class="line"></span><br><span class="line"><span class="meta">#endif</span></span><br></pre></td></tr></table></figure><img src="/2024/07/27/Unity-SRP-02-%E7%BB%98%E5%88%B6%E8%B0%83%E7%94%A8/image-20240727175808765.png" alt="image-20240727175808765" style="zoom:67%;"><h3 id="æ ¸å¿ƒåº“"><a href="#æ ¸å¿ƒåº“" class="headerlink" title="æ ¸å¿ƒåº“"></a>æ ¸å¿ƒåº“</h3><p>æ ¸å¿ƒåº“ä¸­å®šä¹‰äº†æ›´å¤šæœ‰ç”¨çš„ä¸œè¥¿ï¼ŒåŒ…æ‹¬å„ç§å˜æ¢çŸ©é˜µã€å…‰æºä¿¡æ¯ç­‰ã€‚</p><p>åœ¨Common.hlslä¸­æˆ‘ä»¬å®šä¹‰å¸¸ç”¨çš„æ–¹æ³•ï¼Œè¿™é‡ŒåŒ…æ‹¬ç©ºé—´è½¬æ¢ã€‚</p><p><em><strong>Common.hlsl</strong></em></p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#ifndef CUSTOM_COMMON_INCLUDED</span></span><br><span class="line"><span class="meta">#define CUSTOM_COMMON_INCLUDED</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Common.hlslåŒ…å«äº†åŸºæœ¬æ•°æ®ç±»å‹çš„å®šä¹‰ã€å¸¸ç”¨å‡½æ•°ç­‰</span></span><br><span class="line"><span class="meta">#include &quot;Packages/com.unity.render-pipelines.core/ShaderLibrary/Common.hlsl&quot;</span></span><br><span class="line"><span class="meta">#include &quot;UnityInput.hlsl&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//æˆ‘ä»¬éœ€è¦å®šä¹‰è¿™äº›çŸ©é˜µï¼Œæ‰èƒ½ç¼–è¯‘</span></span><br><span class="line"><span class="meta">#define UNITY_MATRIX_M unity_ObjectToWorld</span></span><br><span class="line"><span class="meta">#define UNITY_MATRIX_I_M unity_WorldToObject</span></span><br><span class="line"><span class="meta">#define UNITY_MATRIX_V unity_MatrixV</span></span><br><span class="line"><span class="meta">#define UNITY_MATRIX_I_V unity_MatrixInvV</span></span><br><span class="line"><span class="meta">#define UNITY_MATRIX_VP unity_MatrixVP</span></span><br><span class="line"><span class="meta">#define UNITY_PREV_MATRIX_M unity_prev_MatrixM</span></span><br><span class="line"><span class="meta">#define UNITY_PREV_MATRIX_I_M unity_prev_MatrixIM</span></span><br><span class="line"><span class="meta">#define UNITY_MATRIX_P glstate_matrix_projection</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#include &quot;Packages\com.unity.render-pipelines.core\ShaderLibrary\SpaceTransforms.hlsl&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#endif</span></span><br></pre></td></tr></table></figure><img src="/2024/07/27/Unity-SRP-02-%E7%BB%98%E5%88%B6%E8%B0%83%E7%94%A8/image-20240727211225198.png" alt="image-20240727211225198" style="zoom:67%;"><p><em><strong>UnlitPass.hlsl</strong></em></p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#ifndef CUSTOM_UNLIT_PASS_INCLUDED</span></span><br><span class="line"><span class="meta">#define CUSTOM_UNLIT_PASS_INCLUDED</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#include &quot;../ShaderLibrary/Common.hlsl&quot;</span></span><br><span class="line"></span><br><span class="line">float4 UnlitPassVertex (float3 positionOS : POSITION) : SV_POSITION &#123;</span><br><span class="line">float3 positionWS = TransformObjectToWorld(positionOS.xyz);</span><br><span class="line"><span class="keyword">return</span> TransformWorldToHClip(positionWS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">float4 UnlitPassFragment () : SV_TARGET &#123;</span><br><span class="line">    <span class="comment">//é¢œè‰²è¾“å‡ºé»„è‰²</span></span><br><span class="line"><span class="keyword">return</span> float4(<span class="number">1.0</span>, <span class="number">1.0</span>, <span class="number">0.0</span>, <span class="number">1.0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#endif</span></span><br></pre></td></tr></table></figure><p><em><strong>UnityInput.hlsl</strong></em></p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#ifndef CUSTOM_UNITY_INPUT_INCLUDED</span></span><br><span class="line"><span class="meta">#define CUSTOM_UNITY_INPUT_INCLUDED</span></span><br><span class="line"></span><br><span class="line">float4x4 unity_ObjectToWorld;</span><br><span class="line">float4x4 unity_WorldToObject;</span><br><span class="line">real4 unity_WorldTransformParams;</span><br><span class="line"></span><br><span class="line">float4x4 unity_MatrixVP;</span><br><span class="line">float4x4 unity_MatrixV;</span><br><span class="line">float4x4 unity_MatrixInvV;</span><br><span class="line">float4x4 unity_prev_MatrixM;</span><br><span class="line">float4x4 unity_prev_MatrixIM;</span><br><span class="line">float4x4 glstate_matrix_projection;</span><br><span class="line"><span class="meta">#endif</span></span><br></pre></td></tr></table></figure><img src="/2024/07/27/Unity-SRP-02-%E7%BB%98%E5%88%B6%E8%B0%83%E7%94%A8/image-20240727212220987.png" alt="image-20240727212220987" style="zoom:80%;"><h2 id="æ‰¹å¤„ç†"><a href="#æ‰¹å¤„ç†" class="headerlink" title="æ‰¹å¤„ç†"></a>æ‰¹å¤„ç†</h2><h3 id="Draw-Call"><a href="#Draw-Call" class="headerlink" title="Draw Call"></a>Draw Call</h3><p>æ¯æ¬¡Draw Calléƒ½éœ€è¦CPUå’ŒGPUé€šä¿¡ã€‚å¦‚æœå¿…é¡»å°†å¤§é‡æ•°æ®å‘é€åˆ° GPUï¼Œé‚£ä¹ˆå®ƒæœ€ç»ˆå¯èƒ½ä¼šå› ç­‰å¾…è€Œæµªè´¹æ—¶é—´ã€‚å½“ CPU å¿™äºå‘é€æ•°æ®æ—¶ï¼Œå®ƒæ— æ³•æ‰§è¡Œå…¶ä»–æ“ä½œã€‚è¿™ä¸¤ä¸ªé—®é¢˜éƒ½ä¼šé™ä½å¸§é€Ÿç‡ã€‚</p><p>å¦‚æœæ¯ä¸ªå¯¹è±¡éƒ½æœ‰è‡ªå·±çš„ç»˜åˆ¶è°ƒç”¨ï¼Œè¿™æ— ç–‘ä¼šé€ æˆå·¨å¤§å¼€é”€ã€‚</p><p>è¿™é‡Œå¤åˆ¶åˆšåˆšæˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„æè´¨ï¼Œåˆ¶ä½œä¸€ä¸ªåŒ…å«16ä¸ªçƒä½“çš„åœºæ™¯ï¼ŒGameçª—å£çš„State Panelç»Ÿè®¡ä¿¡æ¯å¦‚ä¸‹ã€‚å®ƒæ˜¾ç¤ºäº†18ä¸ªæ‰¹æ¬¡ï¼Œå…¶ä¸­1æ¬¡ç”¨äºå¤©ç©ºç›’ï¼Œ1æ¬¡ç”¨äºæ¸…é™¤æ¸²æŸ“ç›®æ ‡ã€‚</p><img src="/2024/07/27/Unity-SRP-02-%E7%BB%98%E5%88%B6%E8%B0%83%E7%94%A8/image-20240727214343134.png" alt="image-20240727214343134" style="zoom:80%;"><h3 id="SRPæ‰¹å¤„ç†"><a href="#SRPæ‰¹å¤„ç†" class="headerlink" title="SRPæ‰¹å¤„ç†"></a>SRPæ‰¹å¤„ç†</h3><p>æ‰¹å¤„ç†æ˜¯åˆå¹¶ç»˜åˆ¶è°ƒç”¨çš„è¿‡ç¨‹ï¼Œå¯å‡å°‘ CPU å’Œ GPU ä¹‹é—´é€šä¿¡æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚æ‰§è¡Œæ­¤æ“ä½œçš„æœ€ç®€å•æ–¹æ³•æ˜¯å¯ç”¨ SRP æ‰¹å¤„ç†å™¨ã€‚ä½†æ˜¯ï¼Œè¿™ä»…é€‚ç”¨äºå…¼å®¹çš„ç€è‰²å™¨ï¼Œè€Œæˆ‘ä»¬åˆšåˆšè‡ªå®šä¹‰çš„ç€è‰²å™¨åˆ™ä¸å¯ä»¥ã€‚</p><p>SRP æ‰¹å¤„ç†ä¸ä¼šå‡å°‘ç»˜åˆ¶è°ƒç”¨çš„æ•°é‡ï¼Œè€Œæ˜¯ä½¿å®ƒä»¬æ›´ç²¾ç®€ã€‚å®ƒåœ¨ GPU ä¸Š<u>ç¼“å­˜æè´¨å±æ€§</u>ï¼Œå› æ­¤ä¸å¿…åœ¨æ¯æ¬¡ç»˜åˆ¶è°ƒç”¨æ—¶éƒ½å‘é€å®ƒä»¬ã€‚è¿™æ—¢å‡å°‘äº†å¿…é¡»é€šä¿¡çš„æ•°æ®é‡ï¼Œä¹Ÿå‡å°‘äº† CPU æ¯æ¬¡ç»˜åˆ¶è°ƒç”¨å¿…é¡»æ‰§è¡Œçš„å·¥ä½œã€‚</p><p>ä½†æ˜¯ï¼Œä»…å½“ç€è‰²å™¨<u>éµå¾ªç»Ÿä¸€æ•°æ®çš„ä¸¥æ ¼ç»“æ„æ—¶</u>ï¼Œè¿™æ‰æœ‰æ•ˆã€‚</p><p><img src="/2024/07/27/Unity-SRP-02-%E7%BB%98%E5%88%B6%E8%B0%83%E7%94%A8/image-20240727223909700.png" alt="image-20240727223909700"></p><p>åœ¨æ­¤å¤„ï¼ŒCPU ä»…å¤„ç†ä¸Šå›¾ä¸­æ ‡è®°ä¸º <em>Per Object large buffer</em> çš„ Unity å¼•æ“å±æ€§ã€‚æ‰€æœ‰æè´¨åœ¨ GPU å†…å­˜ä¸­éƒ½æœ‰æŒä¹…çš„ CBUFFERï¼Œå¯ä¾›éšæ—¶ä½¿ç”¨ã€‚è¿™æ ·ä¼šåŠ å¿«æ¸²æŸ“é€Ÿåº¦ï¼ŒåŸå› æ˜¯ï¼š ç°åœ¨ï¼Œæ‰€æœ‰æè´¨å†…å®¹éƒ½æŒä¹…ä¿ç•™åœ¨ GPU å†…å­˜ä¸­ã€‚ ä¸“ç”¨ä»£ç é’ˆå¯¹æ‰€æœ‰æ¯å¯¹è±¡å±æ€§ï¼Œç®¡ç†ç€ä¸€ä¸ªå¤§å‹çš„æ¯å¯¹è±¡ GPU CBUFFERã€‚</p><p><img src="/2024/07/27/Unity-SRP-02-%E7%BB%98%E5%88%B6%E8%B0%83%E7%94%A8/image-20240727223106405.png" alt="image-20240727223106405"></p><p>è¿™å¼ å›¾å±•ç¤ºäº†åœ¨Unityæ¸²æŸ“è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨æ ‡å‡†æ‰¹å¤„ç†ï¼ˆStandard Batchï¼‰å’ŒSRPæ‰¹å¤„ç†ï¼ˆSRP Batchï¼‰æ—¶ï¼Œè¿›è¡Œç»˜åˆ¶è°ƒç”¨ï¼ˆDraw Callï¼‰æ—¶çš„ä¸åŒæ­¥éª¤ã€‚</p><h4 id="æ ‡å‡†æ‰¹å¤„ç†ï¼ˆStandard-Batchï¼‰"><a href="#æ ‡å‡†æ‰¹å¤„ç†ï¼ˆStandard-Batchï¼‰" class="headerlink" title="æ ‡å‡†æ‰¹å¤„ç†ï¼ˆStandard Batchï¼‰"></a>æ ‡å‡†æ‰¹å¤„ç†ï¼ˆStandard Batchï¼‰</h4><ol><li><strong>SetShaderPassï¼ˆlarge complete GPU setupï¼‰</strong>ï¼šå¼€å§‹ä¸€ä¸ªå¤§çš„å®Œæ•´çš„GPUè®¾ç½®ã€‚</li><li><strong>Gather all built-in data in system memory and fill Object CBUFFER</strong>ï¼šåœ¨ç³»ç»Ÿå†…å­˜ä¸­æ”¶é›†æ‰€æœ‰å†…ç½®æ•°æ®å¹¶å¡«å……åˆ°å¯¹è±¡å¸¸é‡ç¼“å†²åŒºï¼ˆObject CBUFFERï¼‰ä¸­ã€‚</li><li><strong>Upload Object CBUFFER to GPU</strong>ï¼šå°†å¯¹è±¡å¸¸é‡ç¼“å†²åŒºä¸Šä¼ åˆ°GPUã€‚</li><li><strong>Gather all material data in system memory and fill Material CBUFFER</strong>ï¼šåœ¨ç³»ç»Ÿå†…å­˜ä¸­æ”¶é›†æ‰€æœ‰æè´¨æ•°æ®å¹¶å¡«å……åˆ°æè´¨å¸¸é‡ç¼“å†²åŒºï¼ˆMaterial CBUFFERï¼‰ä¸­ã€‚</li><li><strong>Upload Material CBUFFER to GPU</strong>ï¼šå°†æè´¨å¸¸é‡ç¼“å†²åŒºä¸Šä¼ åˆ°GPUã€‚</li><li><strong>Bind Material CBUFFER</strong>ï¼šç»‘å®šæè´¨å¸¸é‡ç¼“å†²åŒºã€‚</li><li><strong>Bind Object CBUFFER</strong>ï¼šç»‘å®šå¯¹è±¡å¸¸é‡ç¼“å†²åŒºã€‚</li><li><strong>Draw Call</strong>ï¼šæ‰§è¡Œç»˜åˆ¶è°ƒç”¨ã€‚</li><li>**Material break?**ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æè´¨åˆ‡æ¢ï¼ˆMaterial breakï¼‰ã€‚å¦‚æœæœ‰ï¼Œåˆ™è¿”å›åˆ°ç¬¬äºŒæ­¥é‡æ–°å¼€å§‹ã€‚å¦‚æœæ²¡æœ‰ï¼Œåˆ™å®Œæˆè¿™ä¸ªæ‰¹æ¬¡çš„ç»˜åˆ¶è°ƒç”¨ã€‚</li></ol><h4 id="SRPæ‰¹å¤„ç†ï¼ˆSRP-Batchï¼‰"><a href="#SRPæ‰¹å¤„ç†ï¼ˆSRP-Batchï¼‰" class="headerlink" title="SRPæ‰¹å¤„ç†ï¼ˆSRP Batchï¼‰"></a>SRPæ‰¹å¤„ç†ï¼ˆSRP Batchï¼‰</h4><ol><li><strong>SetShaderPassï¼ˆlarge complete GPU setupï¼‰</strong>ï¼šå¼€å§‹ä¸€ä¸ªå¤§çš„å®Œæ•´çš„GPUè®¾ç½®ã€‚</li><li><strong>Bind persistent Material CBUFFER</strong>ï¼šç»‘å®šæŒä¹…åŒ–çš„æè´¨å¸¸é‡ç¼“å†²åŒºã€‚</li><li><strong>Bind with offset Object data from a large CBUFFER</strong>ï¼šä»ä¸€ä¸ªå¤§çš„å¸¸é‡ç¼“å†²åŒºä¸­ç»‘å®šå¸¦æœ‰åç§»é‡çš„å¯¹è±¡æ•°æ®ã€‚</li><li><strong>Draw Call</strong>ï¼šæ‰§è¡Œç»˜åˆ¶è°ƒç”¨ã€‚</li><li>**Shader Variant break?**ï¼šæ£€æŸ¥æ˜¯å¦æœ‰Shaderå˜ç§åˆ‡æ¢ï¼ˆShader Variant breakï¼‰ã€‚å¦‚æœæœ‰ï¼Œåˆ™è¿”å›åˆ°ç¬¬ä¸€æ­¥é‡æ–°å¼€å§‹ã€‚å¦‚æœæ²¡æœ‰ï¼Œåˆ™å®Œæˆè¿™ä¸ªæ‰¹æ¬¡çš„ç»˜åˆ¶è°ƒç”¨ã€‚</li></ol><h4 id="ä¸»è¦åŒºåˆ«"><a href="#ä¸»è¦åŒºåˆ«" class="headerlink" title="ä¸»è¦åŒºåˆ«"></a>ä¸»è¦åŒºåˆ«</h4><ul><li><strong>æ•°æ®æ”¶é›†å’Œä¸Šä¼ </strong>ï¼šæ ‡å‡†æ‰¹å¤„ç†ä¸­ï¼Œæè´¨å’Œå¯¹è±¡æ•°æ®åˆ†åˆ«åœ¨ç³»ç»Ÿå†…å­˜ä¸­æ”¶é›†å¹¶åˆ†åˆ«ä¸Šä¼ åˆ°GPUã€‚è€Œåœ¨SRPæ‰¹å¤„ç†ä¸­ï¼Œæè´¨å¸¸é‡ç¼“å†²åŒºæ˜¯æŒä¹…åŒ–çš„ï¼Œ<u>å‡å°‘äº†é‡å¤ç»‘å®šçš„å¼€é”€</u>ã€‚</li><li><strong>ç»‘å®šæ“ä½œ</strong>ï¼šæ ‡å‡†æ‰¹å¤„ç†æ¯æ¬¡ç»˜åˆ¶è°ƒç”¨å‰éƒ½éœ€è¦ç»‘å®šæè´¨å’Œå¯¹è±¡å¸¸é‡ç¼“å†²åŒºï¼Œè€ŒSRPæ‰¹å¤„ç†åˆ™<u>é€šè¿‡åç§»é‡ç»‘å®šå¤§ç¼“å†²åŒºä¸­çš„æ•°æ®</u>ï¼Œ<u>å‡å°‘äº†ç»‘å®šæ“ä½œ</u>ã€‚</li><li><strong>åˆ†æ”¯æ¡ä»¶</strong>ï¼š<u>æ ‡å‡†æ‰¹å¤„ç†åœ¨æ¯æ¬¡æè´¨åˆ‡æ¢æ—¶éœ€è¦é‡æ–°å¼€å§‹æ‰€æœ‰æ­¥éª¤ï¼Œè€ŒSRPæ‰¹å¤„ç†åœ¨Shaderå˜ç§åˆ‡æ¢æ—¶æ‰éœ€è¦é‡æ–°å¼€å§‹</u>ã€‚</li></ul><p>å›åˆ°åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„ç€è‰²å™¨åœ¨Inspectoré¢æ¿å¯ä»¥å‘ç°å…¶ä¸æ”¯æŒSRP Batcherï¼Œå› ä¸ºæ²¡æœ‰å­˜æ”¾åˆ°å¯¹åº”çš„å¸¸é‡ç¼“å†²åŒºã€‚</p><p><img src="/2024/07/27/Unity-SRP-02-%E7%BB%98%E5%88%B6%E8%B0%83%E7%94%A8/image-20240727224118208.png" alt="image-20240727224118208"></p><p>æˆ‘ä»¬ä¿®æ”¹Shaderï¼Œå¯¹å°†å˜é‡æ”¾å…¥å¸¸é‡ç¼“å†²åŒºï¼Œå¹¶ä¸”VPçŸ©é˜µè¿˜å¯ç”¨äºåŒä¸€å¸§ä¸­åŒä¸€å°æ‘„åƒæœºç»˜åˆ¶çš„æ‰€æœ‰å†…å®¹ã€‚Unityçš„ç€è‰²å™¨åˆ©ç”¨äº†è¿™ä¸€ç‚¹ï¼Œå¹¶å°†çŸ©é˜µæ”¾åœ¨ä¸åŒçš„å¸¸é‡ç¼“å†²åŒºä¸­ã€‚VPçŸ©é˜µæ”¾å…¥æ¯å¸§ï¼ˆper-frameï¼‰ç¼“å†²åŒºï¼Œè€ŒMçŸ©é˜µæ”¾å…¥æ¯æ¬¡ç»˜åˆ¶ï¼ˆper-drawï¼‰ç¼“å†²åŒºã€‚</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CBUFFER_START(UnityPerMaterial)</span><br><span class="line">float4 _BaseColor;</span><br><span class="line">CBUFFER_END</span><br><span class="line"></span><br><span class="line">CBUFFER_START(UnityPerDraw)</span><br><span class="line">float4x4 unity_ObjectToWorld;</span><br><span class="line">float4x4 unity_WorldToObject;</span><br><span class="line">float4 unity_LODFade;</span><br><span class="line">real4 unity_WorldTransformParams;</span><br><span class="line">CBUFFER_END</span><br></pre></td></tr></table></figure><p>å¯ç”¨ SRP æ‰¹å¤„ç†å™¨</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CustomRenderPipeline</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    GraphicsSettings.useScriptableRenderPipelineBatching = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Draw Callæ˜¾ç¤ºï¼Œéƒ½åœ¨ä¸€ä¸ªSRPæ‰¹æ¬¡ã€‚</p><p><img src="/2024/07/27/Unity-SRP-02-%E7%BB%98%E5%88%B6%E8%B0%83%E7%94%A8/image-20240727234135147.png" alt="image-20240727234135147"></p><h3 id="å¤šç§é¢œè‰²"><a href="#å¤šç§é¢œè‰²" class="headerlink" title="å¤šç§é¢œè‰²"></a>å¤šç§é¢œè‰²</h3><p>åœ¨<u>æ¯ç§æè´¨çš„å†…å­˜å¸ƒå±€å¿…é¡»ç›¸åŒçš„å‰æ</u>ä¸‹ï¼Œå³ä½¿æˆ‘ä»¬ä½¿ç”¨å¤šç§æè´¨ï¼Œæˆ‘ä»¬ä¹Ÿä¼šå¾—åˆ°ä¸€ä¸ªæ‰¹æ¬¡ã€‚å› ä¸ºå®ƒä»¬çš„æ‰€æœ‰æ•°æ®éƒ½ç¼“å­˜åœ¨ GPU ä¸Šï¼Œå¹¶ä¸”æ¯ä¸ªç»˜åˆ¶è°ƒç”¨åªéœ€è¦åŒ…å«åˆ°æ­£ç¡®å†…å­˜ä½ç½®çš„åç§»é‡ã€‚</p><p>ä½†å¦‚æœæˆ‘ä»¬æƒ³ç»™æ¯ä¸ªçƒä½“èµ‹äºˆè‡ªå·±çš„é¢œè‰²ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¿…é¡»åˆ›å»ºæ›´å¤šçš„ææ–™ã€‚å¦‚æœæˆ‘ä»¬å¯ä»¥è®¾ç½®æ¯ä¸ªå¯¹è±¡çš„é¢œè‰²ï¼Œé‚£å°±æ›´æ–¹ä¾¿äº†ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™æ˜¯ä¸å¯èƒ½çš„ï¼Œä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ›å»ºè‡ªå®šä¹‰ç»„ä»¶ç±»å‹æ¥æ”¯æŒå®ƒã€‚</p><p>è¿™ä¸ªæƒ³æ³•æ˜¯ï¼Œ<u>æ¸¸æˆå¯¹è±¡å¯ä»¥é™„åŠ ä¸€ä¸ªç»„ä»¶ï¼Œè¯¥ç»„ä»¶æœ‰ä¸€ä¸ªé…ç½®é€‰é¡¹ï¼Œè¯¥é€‰é¡¹å°†ç”¨äºä¸ºå…¶è®¾ç½®æè´¨å±æ€§ã€‚å®ƒéœ€è¦çŸ¥é“ç€è‰²å™¨å±æ€§çš„æ ‡è¯†ç¬¦ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ƒæ£€ç´¢å¹¶å­˜å‚¨åœ¨é™æ€å˜é‡ä¸­</u>ã€‚</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line">[<span class="meta">DisallowMultipleComponent</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PerObjectMaterialProperties</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//åœ¨ä½¿ç”¨ Shader å±æ€§æ—¶ï¼Œç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²åç§°å¯èƒ½ä¼šæœ‰ä¸€å®šçš„æ€§èƒ½å¼€é”€ï¼Œå› ä¸ºæ¯æ¬¡ä½¿ç”¨æ—¶éƒ½éœ€è¦è¿›è¡Œå­—ç¬¦ä¸²æŸ¥æ‰¾ã€‚é€šè¿‡ PropertyToID æ–¹æ³•å°†å±æ€§åè½¬æ¢ä¸ºæ•´æ•° IDï¼Œå¯ä»¥å‡å°‘è¿™ç§å¼€é”€ï¼Œæé«˜æ€§èƒ½ã€‚</span></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">int</span> baseColorId = Shader.PropertyToID(<span class="string">&quot;_BaseColor&quot;</span>);</span><br><span class="line"></span><br><span class="line">    [<span class="meta">SerializeField</span>]</span><br><span class="line">    Color baseColor = Color.white;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> MaterialPropertyBlock block;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        OnValidate();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnValidate</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (block == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            block = <span class="keyword">new</span> MaterialPropertyBlock();</span><br><span class="line">        &#125;</span><br><span class="line">        block.SetColor(baseColorId, baseColor);</span><br><span class="line">        GetComponent&lt;Renderer&gt;().SetPropertyBlock(block);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ç»™æ¯ä¸ªçƒä½“åˆ†åˆ«é™„ä¸ŠPerObjectMaterialPropertiesç»„ä»¶ï¼Œå¹¶åˆ†åˆ«è®¾ç½®é¢œè‰²ï¼Œå¯ä»¥å‘ç°SRP Batcheræ— æ³•å¤„ç†æ¯ä¸ªå¯¹è±¡çš„æè´¨å±æ€§ï¼Œç°åœ¨é€€å›åˆ°æ¯ä¸ªçƒä½“è°ƒç”¨ä¸€ä¸ªDraw Callã€‚</p><p><img src="/2024/07/27/Unity-SRP-02-%E7%BB%98%E5%88%B6%E8%B0%83%E7%94%A8/image-20240728001622655.png" alt="image-20240728001622655"></p><h3 id="GPU-Instancing"><a href="#GPU-Instancing" class="headerlink" title="GPU Instancing"></a>GPU Instancing</h3><p>è¿˜æœ‰å¦ä¸€ç§æ–¹æ³•å¯ä»¥åˆå¹¶ç»˜åˆ¶è°ƒç”¨ï¼Œè¯¥æ–¹æ³•é€‚ç”¨äºæ¯ä¸ªå¯¹è±¡çš„æè´¨å±æ€§ã€‚å®ƒè¢«ç§°ä¸º GPU å®ä¾‹åŒ–ï¼Œå…¶å·¥ä½œåŸç†æ˜¯ä¸€æ¬¡å¯¹å…·æœ‰ç›¸åŒç½‘æ ¼çš„å¤šä¸ªå¯¹è±¡å‘å‡ºä¸€æ¬¡ç»˜åˆ¶è°ƒç”¨ã€‚CPU æ”¶é›†æ‰€æœ‰æ¯ä¸ªå¯¹è±¡çš„è½¬æ¢å’Œææ–™å±æ€§ï¼Œå¹¶å°†å®ƒä»¬æ”¾å…¥æ•°ç»„ä¸­ï¼Œç„¶åå‘é€åˆ° GPUã€‚ç„¶åï¼ŒGPU éå†æ‰€æœ‰æ¡ç›®ï¼Œå¹¶æŒ‰ç…§å®ƒä»¬æä¾›çš„é¡ºåºå‘ˆç°å®ƒä»¬ã€‚</p><p>ç”±äº GPU å®ä¾‹éœ€è¦é€šè¿‡æ•°ç»„æä¾›æ•°æ®ï¼Œå› æ­¤æˆ‘ä»¬çš„ç€è‰²å™¨ç›®å‰ä¸æ”¯æŒå®ƒã€‚å®Œæˆæ­¤ä»»åŠ¡çš„ç¬¬ä¸€æ­¥æ˜¯åœ¨é¡¶ç‚¹ä¸Šæ–¹æ·»åŠ æŒ‡ä»¤ï¼Œå¹¶åœ¨ç€è‰²å™¨çš„å—ä¸­åˆ†å‰²ç¼–è¯‘æŒ‡ç¤ºã€‚</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma multi_compile_instancing</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæŒ‡ä»¤ä½¿å¾—ç”Ÿæˆä¸¤ç§ç€è‰²å™¨å˜ä½“ï¼Œä¸€ç§æ”¯æŒGPU Instancingï¼Œä¸€ç§ä¸æ”¯æŒã€‚</p><p><img src="/2024/07/27/Unity-SRP-02-%E7%BB%98%E5%88%B6%E8%B0%83%E7%94%A8/image-20240728113735670.png" alt="image-20240728113735670"></p><p>ç„¶åæˆ‘ä»¬éœ€è¦é‡æ–°å®šä¹‰æˆ‘ä»¬è¾“å…¥è¾“å‡ºçš„ç»“æ„ï¼Œä¸ºäº†è®¿é—®å®ä¾‹åŒ–æ•°æ®æ•°ç»„ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“å½“å‰æ¸²æŸ“å¯¹è±¡ç´¢å¼•ã€‚</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ·»åŠ åº“æ–‡ä»¶</span></span><br><span class="line"><span class="meta">#include &quot;Packages/com.unity.render-pipelines.core/ShaderLibrary/UnityInstancing.hlsl&quot;</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//CBUFFER_START(UnityPerMaterial)</span></span><br><span class="line"><span class="comment">//float4 _BaseColor;</span></span><br><span class="line"><span class="comment">//CBUFFER_END</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//å˜æ›´å¸¸é‡ç¼“å†²åŒºå®šä¹‰æ–¹å¼</span></span><br><span class="line">UNITY_INSTANCING_BUFFER_START(UnityPerMaterial)</span><br><span class="line">UNITY_DEFINE_INSTANCED_PROP(float4, _BaseColor)</span><br><span class="line">UNITY_INSTANCING_BUFFER_END(UnityPerMaterial)</span><br><span class="line"></span><br><span class="line"><span class="comment">//å°†è¾“å…¥å®šä¹‰ä¸ºç»“æ„ä½“</span></span><br><span class="line">struct Attributes &#123;</span><br><span class="line">float3 positionOS : POSITION;</span><br><span class="line">    <span class="comment">//å­˜å…¥ç´¢å¼•</span></span><br><span class="line">UNITY_VERTEX_INPUT_INSTANCE_ID</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct Varyings &#123;</span><br><span class="line">float4 positionCS : SV_POSITION;</span><br><span class="line">UNITY_VERTEX_INPUT_INSTANCE_ID</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Varyings UnlitPassVertex (Attributes input) &#123;</span><br><span class="line">Varyings output;</span><br><span class="line">    <span class="comment">//ä»è¾“å…¥ä¸­æå–ç´¢å¼•ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨å…¶ä»–å®ä¾‹åŒ–å®æ‰€ä¾èµ–çš„å…¨å±€é™æ€å˜é‡</span></span><br><span class="line">UNITY_SETUP_INSTANCE_ID(input);</span><br><span class="line">UNITY_TRANSFER_INSTANCE_ID(input, output);</span><br><span class="line">float3 positionWS = TransformObjectToWorld(input.positionOS);</span><br><span class="line">output.positionCS = TransformWorldToHClip(positionWS);</span><br><span class="line"><span class="keyword">return</span> output;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">float4 UnlitPassFragment (Varyings input) : SV_TARGET &#123;</span><br><span class="line">UNITY_SETUP_INSTANCE_ID(input);</span><br><span class="line"><span class="keyword">return</span> UNITY_ACCESS_INSTANCED_PROP(UnityPerMaterial, _BaseColor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°GPUå®ä¾‹åŒ–é€‚ç”¨äºå…±äº«ç³»ç»Ÿæè´¨å¯¹è±¡ï¼Œå…è®¸ä»–ä»¬åœ¨å•ä¸ªæ‰¹æ¬¡ä¸­ç»˜åˆ¶ã€‚è¿™é‡Œä½¿ç”¨äº†ä¸‰ä¸ªæè´¨ï¼Œå› æ­¤æœ‰ä¸‰ä¸ªæ‰¹æ¬¡ã€‚</p><p><img src="/2024/07/27/Unity-SRP-02-%E7%BB%98%E5%88%B6%E8%B0%83%E7%94%A8/image-20240728113337156.png" alt="image-20240728113337156"></p><h3 id="åŠ¨æ€æ‰¹å¤„ç†"><a href="#åŠ¨æ€æ‰¹å¤„ç†" class="headerlink" title="åŠ¨æ€æ‰¹å¤„ç†"></a>åŠ¨æ€æ‰¹å¤„ç†</h3><p>åŠ¨æ€æ‰¹å¤„ç†ï¼Œå°†å…±äº«ç›¸åŒææ–™çš„å¤šä¸ªå°ç½‘æ ¼ç»„åˆæˆä¸€ä¸ªæ›´å¤§çš„ç½‘æ ¼ï¼Œç„¶åè¢«ç»˜åˆ¶å‡ºæ¥ã€‚å½“ä½¿ç”¨æ¯ä¸ªå¯¹è±¡çš„ææ–™å±æ€§æ—¶ï¼Œè¿™ä¹Ÿä¸èµ·ä½œç”¨ã€‚</p><p>åŒæ—¶åŠ¨æ€æ‰¹å¯¹å¯¹è±¡çš„é¡¶ç‚¹æ•°æœ‰é™åˆ¶ï¼Œè¿‡å¤§çš„å¯¹è±¡æ— æ³•è¿›è¡ŒåŠ¨æ€æ‰¹å¤„ç†ã€‚</p><p>å¼€å§‹åŠ¨æ€æ‰¹å¤„ç†ï¼Œæˆ‘ä»¬éœ€è¦åœ¨DrawingSettingä¸­è®¾ç½®ã€‚åŒæ—¶ç”±äºSRP Batcherä¼˜å…ˆçº§é«˜äºåŠ¨æ€æ‰¹å¤„ç†ï¼Œè¿™é‡Œå…³é—­SRP Batcherã€‚</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> drawingSettings = <span class="keyword">new</span> DrawingSettings(unlitShaderTagId, sortingSettings)</span><br><span class="line">&#123;</span><br><span class="line">    enableDynamicBatching = <span class="literal">true</span>,</span><br><span class="line">    enableInstancing = <span class="literal">false</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CustomRenderPipeline</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    GraphicsSettings.useScriptableRenderPipelineBatching = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬æ¥è¯´ï¼ŒGPUå®ä¾‹åŒ–æ¯”åŠ¨æ€æ‰¹å¤„ç†å·¥ä½œå¾—æ›´å¥½ã€‚</p><p>è¯¥æ–¹æ³•ä¹Ÿæœ‰ä¸€äº›æ³¨æ„äº‹é¡¹ï¼Œä¾‹å¦‚ï¼Œå½“æ¶‰åŠä¸åŒçš„å°ºåº¦æ—¶ï¼Œ<u>è¾ƒå¤§ç½‘æ ¼çš„æ³•å‘é‡ä¸èƒ½ä¿è¯æ˜¯å•ä½é•¿åº¦çš„</u>ã€‚æ­¤å¤–ï¼Œ<u>ç»˜åˆ¶é¡ºåºæ”¹å˜</u>ï¼Œå› ä¸ºå®ƒç°åœ¨æ˜¯ä¸€ä¸ªç½‘æ ¼è€Œä¸æ˜¯å¤šä¸ªã€‚</p><p><img src="/2024/07/27/Unity-SRP-02-%E7%BB%98%E5%88%B6%E8%B0%83%E7%94%A8/image-20240728122413492.png" alt="image-20240728122413492"></p><hr><p><strong>ä¸‹é¢è¿™ç¯‡æ–‡ç« å†è¯´æ˜å„ç§åˆæ‰¹æŠ€æœ¯çš„ç‰¹ç‚¹å’ŒåŒºåˆ«ï¼š</strong></p><a href="/2024/07/28/%E5%90%88%E6%89%B9%E5%8F%8AGPU%E5%AE%9E%E4%BE%8B%E5%8C%96/" title="åˆæ‰¹åŠGPUå®ä¾‹åŒ–">åˆæ‰¹åŠGPUå®ä¾‹åŒ–</a><hr><p><strong>å‚è€ƒæ–‡ç« </strong></p><p><a href="https://catlikecoding.com/unity/tutorials/custom-srp/draw-calls/">ç»˜åˆ¶è°ƒç”¨ (catlikecoding.com)</a></p><p><a href="https://zhuanlan.zhihu.com/p/166334724">Unityå¯ç¼–ç¨‹æ¸²æŸ“ç®¡çº¿ï¼ˆSRPï¼‰ç³»åˆ—ï¼ˆäºŒï¼‰â€”â€”è‡ªå®šä¹‰ç€è‰²å™¨ï¼ˆHLSLå’Œæ ¸å¿ƒåº“ï¼‰ - çŸ¥ä¹ (zhihu.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> Unity SRP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸¸æˆæ¸²æŸ“ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Unity SRP 01-è‡ªå®šä¹‰ç®¡çº¿</title>
      <link href="/2024/07/25/Unity-SRP-01-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AE%A1%E7%BA%BF/"/>
      <url>/2024/07/25/Unity-SRP-01-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AE%A1%E7%BA%BF/</url>
      
        <content type="html"><![CDATA[<hr><h1 id="Unity-SRP-01-è‡ªå®šä¹‰ç®¡çº¿"><a href="#Unity-SRP-01-è‡ªå®šä¹‰ç®¡çº¿" class="headerlink" title="Unity SRP 01-è‡ªå®šä¹‰ç®¡çº¿"></a>Unity SRP 01-è‡ªå®šä¹‰ç®¡çº¿</h1><h2 id="æ¸²æŸ“ç®¡çº¿"><a href="#æ¸²æŸ“ç®¡çº¿" class="headerlink" title="æ¸²æŸ“ç®¡çº¿"></a>æ¸²æŸ“ç®¡çº¿</h2><p>ä¸ºäº†æ¸²æŸ“ä»»ä½•ä¸œè¥¿ï¼Œå¿…é¡»ç¡®å®šå¿…é¡»ç»˜åˆ¶å“ªäº›å½¢çŠ¶ï¼Œåœ¨ä½•å¤„ã€ä½•æ—¶ä»¥åŠä½¿ç”¨ä»€ä¹ˆè®¾ç½®ã€‚è¿™å¯èƒ½ä¼šå˜å¾—éå¸¸å¤æ‚ï¼Œå…·ä½“å–å†³äºæ¶‰åŠå¤šå°‘æ•ˆæœã€‚ç¯å…‰ã€é˜´å½±ã€é€æ˜åº¦ã€å›¾åƒæ•ˆæœã€ä½“ç§¯æ•ˆæœç­‰éƒ½å¿…é¡»æŒ‰ç…§æ­£ç¡®çš„é¡ºåºè¿›è¡Œå¤„ç†ï¼Œæ‰èƒ½å¾—åˆ°æœ€ç»ˆå›¾åƒã€‚è¿™å°±æ˜¯æ¸²æŸ“ç®¡çº¿çš„ä½œç”¨ã€‚</p><p>è¿‡å»ï¼ŒUnity ä»…æ”¯æŒå‡ ç§å†…ç½®çš„æ¸²æŸ“æ–¹å¼ï¼ˆBuild-in RPï¼‰ã€‚Unity2018æ·»åŠ äº†ä¸¤ä¸ªä½¿ç”¨è¿™ç§æ–°æ–¹æ³•åˆ¶ä½œçš„å®éªŒæ€§ RPï¼š<u>Lightweight RP and the High Definition RP</u>ã€‚åœ¨ Unity 2019 ä¸­ï¼Œè½»é‡çº§ RP ä¸å†æ˜¯å®éªŒæ€§çš„ï¼Œè€Œæ˜¯åœ¨ Unity 2019.3 ä¸­æ›´åä¸º<u>URP</u>ã€‚</p><h3 id="é¡¹ç›®è®¾ç½®"><a href="#é¡¹ç›®è®¾ç½®" class="headerlink" title="é¡¹ç›®è®¾ç½®"></a>é¡¹ç›®è®¾ç½®</h3><p>åœ¨Unity 2022.3.12f1ä¸­åˆ›å»ºæ–°çš„3Dé¡¹ç›®ï¼Œå¹¶ä¸”åœ¨åœºæ™¯ä¸­æ”¾ç½®è‹¥å¹²çƒä½“ï¼Œå¹¶åˆ†åˆ«èµ‹äºˆä¸åŒæè´¨ï¼š</p><ol><li>Unlit&#x2F;Color é»„è‰²</li><li>Unlit&#x2F;Transparent ç™½è‰²</li><li>Standardï¼ˆRenderMode:Opaqueï¼‰ çº¢è‰²</li><li>Standardï¼ˆRenderMode:Transparentï¼‰ è“è‰²</li></ol><img src="/2024/07/25/Unity-SRP-01-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AE%A1%E7%BA%BF/image-20240726172826097.png" alt="image-20240726172826097" title="æµ‹è¯•åœºæ™¯"><h3 id="ç®¡é“èµ„äº§"><a href="#ç®¡é“èµ„äº§" class="headerlink" title="ç®¡é“èµ„äº§"></a>ç®¡é“èµ„äº§</h3><p>ç®¡é“èµ„äº§æ˜¯ä¸º Unity æä¾›ä¸€ç§æ–¹æ³•æ¥è·å–è´Ÿè´£æ¸²æŸ“çš„ç®¡é“å¯¹è±¡å®ä¾‹ã€‚èµ„äº§æœ¬èº«åªæ˜¯ä¸€ä¸ªå¥æŸ„å’Œå­˜å‚¨è®¾ç½®çš„åœ°æ–¹ã€‚</p><p>è¿™é‡Œåˆ›å»ºä¸€ä¸ªC#è„šæœ¬ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ç±»CustomRenderPipelineAssetï¼Œç»§æ‰¿RenderPipelineAssetã€‚</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.Rendering;</span><br><span class="line"></span><br><span class="line"><span class="comment">//CreateAssetMenuå¯ä»¥è®©è¿™ä¸ªç±»æˆä¸ºä¸€ç§ç±»å‹çš„èµ„äº§ï¼Œä»ç¼–è¾‘å™¨èœå•æ å¿«æ·åˆ›å»º</span></span><br><span class="line">[<span class="meta">CreateAssetMenu(menuName = <span class="string">&quot;Rendering/Custom Render Pipeline&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomRenderPipelineAsset</span> : <span class="title">RenderPipelineAsset</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> RenderPipeline <span class="title">CreatePipeline</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//æ”¾å›è‡ªå®šä¹‰çš„æ¸²æŸ“ç®¡çº¿å®ä¾‹</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CustomRenderPipeline();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨æ–°å»ºèœå•é¡¹ä¸­æ–°å»ºä¸€ä¸ªRenderPipelineAssetï¼Œå¹¶åœ¨é¡¹ç›®è®¾ç½®ä¸­é€‰æ‹©å®ƒ</p><p><img src="/2024/07/25/Unity-SRP-01-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AE%A1%E7%BA%BF/image-20240726174100845.png" alt="image-20240726174100845" title="æ–°å»ºæ¸²æŸ“ç®¡çº¿èµ„äº§å¹¶è®¾å®š"></p><h3 id="æ¸²æŸ“ç®¡çº¿å®ä¾‹"><a href="#æ¸²æŸ“ç®¡çº¿å®ä¾‹" class="headerlink" title="æ¸²æŸ“ç®¡çº¿å®ä¾‹"></a>æ¸²æŸ“ç®¡çº¿å®ä¾‹</h3><p>åˆ›å»ºä¸€ä¸ªç±»CustomRenderPipelineï¼Œå¹¶ç»§æ‰¿RenderPipelineã€‚</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.Rendering;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomRenderPipeline</span> : <span class="title">RenderPipeline</span> &#123;</span><br><span class="line">    <span class="comment">//RenderPipelineå®šä¹‰äº†ä¸€ä¸ªå—ä¿æŠ¤çš„æŠ½è±¡æ–¹æ³•ï¼Œæˆ‘ä»¬å¿…é¡»é‡å†™è¯¥æ–¹æ³•æ‰èƒ½åˆ›å»ºå…·ä½“çš„ç®¡é“ã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Render</span> (<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">ScriptableRenderContext context, Camera[] cameras</span></span></span><br><span class="line"><span class="params"><span class="function"></span>)</span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ­¤æ–¹æ³•æ˜¯ä¸ºè‡ªå®šä¹‰ SRP å®šä¹‰çš„å…¥å£ç‚¹ï¼Œä½†ç”±äºç›¸æœºé˜µåˆ—å‚æ•°éœ€è¦æ¯å¸§åˆ†é…å†…å­˜ï¼Œå› æ­¤å¼•å…¥äº†ä¸€ä¸ªæ›¿ä»£æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Render</span> (<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">ScriptableRenderContext context, List&lt;Camera&gt; cameras</span></span></span><br><span class="line"><span class="params"><span class="function"></span>)</span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ¸²æŸ“"><a href="#æ¸²æŸ“" class="headerlink" title="æ¸²æŸ“"></a>æ¸²æŸ“</h2><p>Unity åœ¨ RP å®ä¾‹ä¸Šè°ƒç”¨çš„æ¯ä¸€å¸§ã€‚å®ƒä¼ é€’ä¸€ä¸ªä¸Šä¸‹æ–‡ç»“æ„ï¼Œè¯¥ç»“æ„æä¾›ä¸å¼•æ“çš„è¿æ¥ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒè¿›è¡Œæ¸²æŸ“ã€‚å®ƒè¿˜ä¼ é€’ä¸€ç»„æ‘„åƒæœºï¼Œå› ä¸ºåœºæ™¯ä¸­å¯èƒ½æœ‰å¤šä¸ªæ´»åŠ¨æ‘„åƒæœºã€‚RP è´Ÿè´£æŒ‰ç…§æä¾›çš„é¡ºåºæ¸²æŸ“æ‰€æœ‰è¿™äº›æ‘„åƒæœºã€‚</p><h3 id="ç›¸æœºæ¸²æŸ“å™¨"><a href="#ç›¸æœºæ¸²æŸ“å™¨" class="headerlink" title="ç›¸æœºæ¸²æŸ“å™¨"></a>ç›¸æœºæ¸²æŸ“å™¨</h3><p>æ¯ä¸ªæ‘„åƒæœºéƒ½æ˜¯ç‹¬ç«‹æ¸²æŸ“çš„ã€‚å› æ­¤ï¼Œæˆ‘ä»¬ä¸ä¼šæ¸²æŸ“æ‰€æœ‰æ‘„åƒæœºï¼Œè€Œæ˜¯å°†è¯¥è´£ä»»è½¬å‘ç»™ä¸“é—¨ç”¨äºæ¸²æŸ“ä¸€ä¸ªæ‘„åƒæœºçš„æ–°ç±»ã€‚</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.Rendering;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CameraRenderer</span> &#123;</span><br><span class="line"></span><br><span class="line">ScriptableRenderContext context;</span><br><span class="line"></span><br><span class="line">Camera camera;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Render</span> (<span class="params">ScriptableRenderContext context, Camera camera</span>)</span> &#123;</span><br><span class="line"><span class="keyword">this</span>.context = context;</span><br><span class="line"><span class="keyword">this</span>.camera = camera;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¹¶ä¸”åœ¨CustomRenderPipelineä¸­åˆ›å»ºä¸€ä¸ªCameraRendererå®ä¾‹ï¼Œä½¿ç”¨å®ƒåœ¨ä¸€ä¸ªå¾ªç¯ä¸­æ¸²æŸ“æ‰€æœ‰æ‘„åƒæœºã€‚</p><p><em><strong>CustomRenderPipeline</strong></em></p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CameraRenderer renderer = <span class="keyword">new</span> CameraRenderer();</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Render</span> (<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">ScriptableRenderContext context, List&lt;Camera&gt; cameras</span></span></span><br><span class="line"><span class="params"><span class="function"></span>)</span> &#123;</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; cameras.Count; i++) &#123;</span><br><span class="line">renderer.Render(context, cameras[i]);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç»˜åˆ¶å¤©ç©ºç›’"><a href="#ç»˜åˆ¶å¤©ç©ºç›’" class="headerlink" title="ç»˜åˆ¶å¤©ç©ºç›’"></a>ç»˜åˆ¶å¤©ç©ºç›’</h3><p>æˆ‘ä»¬é¦–å…ˆè®©CameraRendereræ¸²æŸ“ç»˜åˆ¶å¤©ç©ºç›’ï¼Œè¿™å¯ä»¥é€šè¿‡åœ¨ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨ç›¸æœºä½œä¸ºå‚æ•°æ¥å®Œæˆã€‚</p><p><em><strong>CameraRenderer</strong></em></p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Render</span> (<span class="params">ScriptableRenderContext context, Camera camera</span>)</span> &#123;</span><br><span class="line"><span class="keyword">this</span>.context = context;</span><br><span class="line"><span class="keyword">this</span>.camera = camera;</span><br><span class="line"></span><br><span class="line">DrawVisibleGeometry();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DrawVisibleGeometry</span> ()</span> &#123;</span><br><span class="line">context.DrawSkybox(camera);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ—¶å¤©ç©ºç›’å­å¹¶æ²¡æœ‰å‡ºç°ï¼Œå› ä¸ºæˆ‘ä»¬<em><strong>å‘ä¸Šä¸‹æ–‡å‘å‡ºçš„å‘½ä»¤æ˜¯ç¼“å†²çš„</strong></em>ï¼Œæˆ‘ä»¬å¿…é¡»é€šè¿‡è°ƒç”¨ä¸Šä¸‹æ–‡æ¥<em><strong>æäº¤å‘½ä»¤ç¼“å†²åŒºæ¸²æŸ“å‘½ä»¤</strong></em>çš„å·¥ä½œä»¥ä¾›æ‰§è¡Œã€‚</p><p><em><strong>CameraRenderer</strong></em></p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Render</span> (<span class="params">ScriptableRenderContext context, Camera camera</span>)</span> &#123;</span><br><span class="line"><span class="keyword">this</span>.context = context;</span><br><span class="line"><span class="keyword">this</span>.camera = camera;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç»™contentå‘å‡ºæ¸²æŸ“å¤©ç©ºç›’å­å‘½ä»¤</span></span><br><span class="line">DrawVisibleGeometry();</span><br><span class="line">    <span class="comment">//æäº¤å‘½ä»¤ç¼“å†²åŒºæ‰€æœ‰å‘½ä»¤</span></span><br><span class="line">Submit();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Submit</span> ()</span> &#123;</span><br><span class="line">context.Submit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤©ç©ºç›’å­å°±ä¼šå‡ºç°åœ¨åœºæ™¯ä¸­ï¼Œåœ¨å¸§è°ƒè¯•å™¨ä¸­è¿˜èƒ½çœ‹åˆ°å®ƒçš„å®é™…ç»˜åˆ¶è°ƒç”¨ã€‚</p><p><img src="/2024/07/25/Unity-SRP-01-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AE%A1%E7%BA%BF/image-20240726180309775.png" alt="image-20240726180309775" title="ç»˜åˆ¶å¤©ç©ºç›’å­"></p><p><img src="/2024/07/25/Unity-SRP-01-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AE%A1%E7%BA%BF/image-20240726180330757.png" alt="image-20240726180330757" title="å¸§è°ƒè¯•å™¨ç»“æœ"></p><p>è¿™é‡Œè™½ç„¶æäº¤äº†å¤©ç©ºç›’å­çš„æ¸²æŸ“æŒ‡ä»¤ï¼Œä½†æ˜¯æœ€ç»ˆæ˜¯å¦ç»˜åˆ¶å–å†³äºåœºæ™¯ä¸­ç›¸æœºçš„Clear Flags</p><hr><h4 id="Clear-Flags"><a href="#Clear-Flags" class="headerlink" title="Clear Flags"></a>Clear Flags</h4><p>ç›¸æœºçš„ <code>Clear Flags</code> å±æ€§åœ¨ Unity ä¸­ç”¨äºæ§åˆ¶æ¯ä¸€å¸§å¼€å§‹æ—¶å¦‚ä½•æ¸…é™¤ä¹‹å‰çš„æ¸²æŸ“å†…å®¹ã€‚</p><p><img src="/2024/07/25/Unity-SRP-01-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AE%A1%E7%BA%BF/image-20240726182613555.png" alt="image-20240726182613555"></p><p>è¿™é‡Œæˆ‘ä»¬åœ¨Build-inç®¡çº¿ä¸‹æµ‹è¯•ã€‚</p><h5 id="Solid"><a href="#Solid" class="headerlink" title="Solid"></a>Solid</h5><p><img src="/2024/07/25/Unity-SRP-01-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AE%A1%E7%BA%BF/image-20240726182833395.png" alt="image-20240726182833395"></p><p>ç”¨æŒ‡å®šé¢œè‰²å¡«å……çš„æ–¹å¼æ¸…é™¤é¢œè‰²ç¼“å†²åŒºã€‚</p><h5 id="Depth-Only"><a href="#Depth-Only" class="headerlink" title="Depth Only"></a>Depth Only</h5><p>å½“ç›¸æœºçš„ <code>Clear Flags</code> å±æ€§è®¾ç½®ä¸º <code>Depth Only</code> æ—¶ï¼Œç›¸æœºä¼šåœ¨æ¯ä¸€å¸§å¼€å§‹æ—¶åªæ¸…é™¤æ·±åº¦ç¼“å†²åŒºï¼Œè€Œä¸ä¼šæ¸…é™¤é¢œè‰²ç¼“å†²åŒºã€‚è¿™æ„å‘³ç€å±å¹•ä¸Šçš„é¢œè‰²å†…å®¹ä¼šè¢«ä¿ç•™ï¼Œä½†æ·±åº¦ä¿¡æ¯ä¼šè¢«é‡ç½®ã€‚<code>Depth Only</code> æ¸…é™¤æ¨¡å¼é€šå¸¸ç”¨äºå¤šä¸ªç›¸æœºçš„å åŠ æ¸²æŸ“ï¼Œç¡®ä¿æ·±åº¦ä¿¡æ¯ä¸æ··ä¹±ã€‚</p><p>å¸¸ç”¨åœºæ™¯åŒ…æ‹¬ï¼š</p><pre><code>1. å¤šç›¸æœºæ¸²æŸ“ï¼Œå åŠ æ¸²æŸ“å†…å®¹1. åå¤„ç†æ•ˆæœ</code></pre><p><img src="/2024/07/25/Unity-SRP-01-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AE%A1%E7%BA%BF/image-20240726184158104.png" alt="image-20240726184158104"></p><p><img src="/2024/07/25/Unity-SRP-01-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AE%A1%E7%BA%BF/image-20240726184210525.png" alt="image-20240726184210525"></p><p>è¿™é‡Œä¸¤ä¸ªç›¸æœºæ¸²æŸ“ç»“æœå åŠ äº†ã€‚</p><h5 id="Donâ€™t-Clear"><a href="#Donâ€™t-Clear" class="headerlink" title="Donâ€™t Clear"></a>Donâ€™t Clear</h5><p>ä¸æ¸…é™¤ç¼“å†²åŒºã€‚</p><p><img src="/2024/07/25/Unity-SRP-01-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AE%A1%E7%BA%BF/image-20240726184358837.png" alt="image-20240726184358837"></p><p>è¿™é‡Œæ‹–åŠ¨ç™½çƒä½ç½®ï¼Œåœ¨å±å¹•ä¸Šä¼šä¿ç•™ä¸Šä¸€å¸§åƒç´ å€¼ã€‚</p><hr><p>ä¸ºäº†æ­£ç¡®æ¸²æŸ“å¤©ç©ºç›’å’Œæ•´ä¸ªåœºæ™¯ï¼Œæˆ‘ä»¬å¿…é¡»è®¾ç½®è§†å›¾æŠ•å½±çŸ©é˜µã€‚æ­¤å˜æ¢çŸ©é˜µå°†æ‘„åƒæœºçš„ä½ç½®å’Œæ–¹å‘ï¼ˆè§†å›¾çŸ©é˜µï¼‰ä¸æ‘„åƒæœºçš„é€è§†æˆ–æ­£äº¤æŠ•å½±ï¼ˆæŠ•å½±çŸ©é˜µï¼‰ç›¸ç»“åˆã€‚</p><p><em><strong>CameraRenderer</strong></em></p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Render</span> (<span class="params">ScriptableRenderContext context, Camera camera</span>)</span> &#123;</span><br><span class="line"><span class="keyword">this</span>.context = context;</span><br><span class="line"><span class="keyword">this</span>.camera = camera;</span><br><span class="line"></span><br><span class="line">Setup();</span><br><span class="line">DrawVisibleGeometry();</span><br><span class="line">Submit();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Setup</span> ()</span> &#123;</span><br><span class="line">context.SetupCameraProperties(camera);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å‘½ä»¤ç¼“å†²åŒº"><a href="#å‘½ä»¤ç¼“å†²åŒº" class="headerlink" title="å‘½ä»¤ç¼“å†²åŒº"></a>å‘½ä»¤ç¼“å†²åŒº</h3><p>æŸäº›ä»»åŠ¡ï¼ˆå¦‚ç»˜åˆ¶å¤©ç©ºç›’ï¼‰å¯ä»¥é€šè¿‡ä¸“ç”¨æ–¹æ³•å‘å‡ºï¼Œä½†å…¶ä»–å‘½ä»¤å¿…é¡»é€šè¿‡å•ç‹¬çš„å‘½ä»¤ç¼“å†²åŒºé—´æ¥å‘å‡ºã€‚æˆ‘ä»¬éœ€è¦è¿™æ ·ä¸€ä¸ªç¼“å†²åŒºæ¥ç»˜åˆ¶åœºæ™¯ä¸­çš„å…¶ä»–å‡ ä½•ä½“ï¼Œå› æ­¤æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç¼“å†²åŒºï¼Œå¹¶ç”¨åç§°æ¥æ ‡è¯†å®ƒã€‚</p><p><em><strong>CameraRenderer</strong></em></p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="built_in">string</span> bufferName = <span class="string">&quot;Render Camera&quot;</span>;</span><br><span class="line"></span><br><span class="line">CommandBuffer buffer = <span class="keyword">new</span> CommandBuffer &#123;</span><br><span class="line">name = bufferName</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‘½ä»¤ç¼“å†²åŒºæ¥æ³¨å…¥åˆ†æå™¨æ ·æœ¬ï¼Œè¿™äº›æ ·æœ¬å°†åŒæ—¶æ˜¾ç¤ºåœ¨åˆ†æå™¨å’Œå¸§è°ƒè¯•å™¨ä¸­ã€‚è¿™æ˜¯é€šè¿‡åœ¨é€‚å½“çš„æ—¶é—´ç‚¹è°ƒç”¨æ¥å®Œæˆçš„ã€‚</p><p>è¦æ‰§è¡Œç¼“å†²åŒºï¼Œè¯·åœ¨ä¸Šä¸‹æ–‡ä¸Šè°ƒç”¨ç¼“å†²åŒºä½œä¸ºå‚æ•°ã€‚ç”±äºæ‰§è¡Œå’Œæ¸…ç®—å§‹ç»ˆæ˜¯ä¸€èµ·å®Œæˆçš„ï¼Œå› æ­¤æ·»åŠ ä¸€ä¸ªåŒæ—¶æ‰§è¡Œè¿™ä¸¤é¡¹æ“ä½œçš„æ–¹æ³•éå¸¸æ–¹ä¾¿ã€‚</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Setup</span> ()</span> &#123;</span><br><span class="line">       <span class="comment">//æ ‡è®°æ€§èƒ½é‡‡æ ·å¼€å§‹</span></span><br><span class="line">buffer.BeginSample(bufferName);</span><br><span class="line">   ExecuteBuffer();</span><br><span class="line">context.SetupCameraProperties(camera);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Submit</span> ()</span> &#123;</span><br><span class="line">       <span class="comment">//æ ‡è®°æ€§èƒ½é‡‡æ ·çš„ç»“æŸ</span></span><br><span class="line">buffer.EndSample(bufferName);</span><br><span class="line">       ExecuteBuffer();</span><br><span class="line">context.Submit();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ExecuteBuffer</span> ()</span> &#123;</span><br><span class="line">context.ExecuteCommandBuffer(buffer);</span><br><span class="line">buffer.Clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2024/07/25/Unity-SRP-01-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AE%A1%E7%BA%BF/image-20240726200112602.png" alt="image-20240726200112602"></p><h3 id="æ¸…é™¤æ¸²æŸ“ç›®æ ‡"><a href="#æ¸…é™¤æ¸²æŸ“ç›®æ ‡" class="headerlink" title="æ¸…é™¤æ¸²æŸ“ç›®æ ‡"></a>æ¸…é™¤æ¸²æŸ“ç›®æ ‡</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Setup</span> ()</span> &#123;</span><br><span class="line">    buffer.ClearRenderTarget(<span class="literal">true</span>, <span class="literal">true</span>, Color.clear);</span><br><span class="line">buffer.BeginSample(bufferName);</span><br><span class="line"></span><br><span class="line">ExecuteBuffer();</span><br><span class="line">context.SetupCameraProperties(camera);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç»˜åˆ¶å‡ ä½•å›¾å½¢"><a href="#ç»˜åˆ¶å‡ ä½•å›¾å½¢" class="headerlink" title="ç»˜åˆ¶å‡ ä½•å›¾å½¢"></a>ç»˜åˆ¶å‡ ä½•å›¾å½¢</h3><p>æˆ‘ä»¬ç›®å‰çœ‹åˆ°çš„æ˜¯å¤©ç©ºç›’ï¼Œä½†çœ‹ä¸åˆ°æˆ‘ä»¬åœ¨åœºæ™¯ä¸­æ”¾ç½®çš„ä»»ä½•ç‰©ä½“ã€‚æˆ‘ä»¬ä¸æ˜¯ç»˜åˆ¶æ¯ä¸ªå¯¹è±¡ï¼Œè€Œæ˜¯åªæ¸²æŸ“é‚£äº›å¯¹ç›¸æœºå¯è§çš„å¯¹è±¡ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æå‡ºè§†é”¥ä½“ä¹‹å¤–çš„å¯¹è±¡ã€‚</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">CullingResults cullingResults;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Render</span> (<span class="params">ScriptableRenderContext context, Camera camera</span>)</span> &#123;</span><br><span class="line"><span class="keyword">this</span>.context = context;</span><br><span class="line"><span class="keyword">this</span>.camera = camera;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//å¦‚æœå‰”é™¤å¤±è´¥å°±ä¸­æ­¢</span></span><br><span class="line"><span class="keyword">if</span> (!Cull()) &#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Setup();</span><br><span class="line">DrawVisibleGeometry();</span><br><span class="line">Submit();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="built_in">bool</span> <span class="title">Cull</span> ()</span> &#123;</span><br><span class="line">       <span class="comment">//ScriptableCullingParameters æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼ŒåŒ…å«äº†å‰”é™¤æ“ä½œæ‰€éœ€çš„å„ç§å‚æ•°ã€‚</span></span><br><span class="line"><span class="keyword">if</span> (camera.TryGetCullingParameters(<span class="keyword">out</span> ScriptableCullingParameters p)) &#123;</span><br><span class="line">           <span class="comment">//æ‰§è¡Œå‰”é™¤æ“ä½œ</span></span><br><span class="line">           cullingResults = context.Cull(<span class="keyword">ref</span> p);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€æ—¦æˆ‘ä»¬çŸ¥é“äº†ä»€ä¹ˆæ˜¯å¯è§çš„ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»§ç»­æ¸²æŸ“è¿™äº›ä¸œè¥¿ã€‚è¿™æ˜¯é€šè¿‡è°ƒç”¨ä¸Šä¸‹æ–‡æ¥å®Œæˆçš„ï¼Œå°†<u>å‰”é™¤ç»“æœ</u>ä½œä¸ºå‚æ•°ï¼Œå‘Šè¯‰å®ƒä½¿ç”¨å“ªä¸ªæ¸²æŸ“å™¨ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¿…é¡»æä¾›<u>ç»˜å›¾è®¾ç½®å’Œè¿‡æ»¤è®¾ç½®</u>ã€‚</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DrawVisibleGeometry</span> ()</span> &#123;</span><br><span class="line"><span class="keyword">var</span> drawingSettings = <span class="keyword">new</span> DrawingSettings();</span><br><span class="line"><span class="keyword">var</span> filteringSettings = <span class="keyword">new</span> FilteringSettings();</span><br><span class="line"></span><br><span class="line">context.DrawRenderers(</span><br><span class="line">cullingResults, <span class="keyword">ref</span> drawingSettings, <span class="keyword">ref</span> filteringSettings</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">context.DrawSkybox(camera);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿˜æ²¡æœ‰çœ‹åˆ°ä»»ä½•å†…å®¹ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜å¿…é¡»æŒ‡ç¤ºå…è®¸å“ªç§ç±»å‹çš„ç€è‰²å™¨é€šé“ã€‚å› æ­¤æˆ‘ä»¬å¿…é¡»è·å–é€šé“çš„ç€è‰²å™¨æ ‡ç­¾IDã€‚</p><p>æˆ‘ä»¬è¿˜å¯ä»¥åœ¨è‡ªå®šä¹‰ç€è‰²å™¨ä¸­å®šä¹‰è‡ªå·±çš„<code>LightMode</code>æ ‡ç­¾ã€‚</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Pass &#123;</span><br><span class="line">    Name &quot;MyCustomPass&quot;</span><br><span class="line">    Tags &#123; &quot;LightMode&quot; = &quot;MyCustomPass&quot; &#125;</span><br><span class="line">    <span class="comment">// ç€è‰²å™¨ä»£ç </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">    </span><br><span class="line">private static <span class="keyword">readonly</span> ShaderTagId myCustomPassTag = new ShaderTagId(&quot;MyCustomPass&quot;);</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åœ¨è¿™é‡Œæ”¯æŒUnlitç€è‰²å™¨æ¸²æŸ“ã€‚</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SRPDefaultUnlitï¼šç”¨äºè„šæœ¬æ¸²æŸ“ç®¡çº¿çš„é»˜è®¤æ— å…‰ç…§é€šé“</span></span><br><span class="line"><span class="keyword">static</span> ShaderTagId unlitShaderTagId = <span class="keyword">new</span> ShaderTagId(<span class="string">&quot;SRPDefaultUnlit&quot;</span>);</span><br><span class="line"><span class="comment">//-----å…¶ä»–é€šé“-----</span></span><br><span class="line"><span class="comment">//ForwardBaseï¼šç”¨äºå‰å‘æ¸²æŸ“è·¯å¾„ä¸­çš„åŸºç¡€é€šé“</span></span><br><span class="line"><span class="comment">//ForwardAddï¼šç”¨äºå‰å‘æ¸²æŸ“è·¯å¾„ä¸­çš„é™„åŠ å…‰ç…§é€šé“</span></span><br><span class="line"><span class="comment">//ShadowCasterï¼šç”¨äºé˜´å½±ç»˜åˆ¶</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DrawVisibleGeometry</span> ()</span> &#123;</span><br><span class="line">       <span class="comment">//æ§åˆ¶æ¸²æŸ“ç»˜åˆ¶é¡ºåº</span></span><br><span class="line"><span class="keyword">var</span> sortingSettings = <span class="keyword">new</span> SortingSettings(camera);</span><br><span class="line"><span class="keyword">var</span> drawingSettings = <span class="keyword">new</span> DrawingSettings(</span><br><span class="line">unlitShaderTagId, sortingSettings</span><br><span class="line">);</span><br><span class="line">â€¦</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æŒ‡å‡ºå…è®¸çš„æ¸²æŸ“é˜Ÿåˆ—</span></span><br><span class="line"><span class="keyword">var</span> filteringSettings = <span class="keyword">new</span> FilteringSettings(RenderQueueRange.all);</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬èƒ½å‘ç°Unlit&#x2F;Transparentæè´¨çš„ç‰©ä½“æ²¡æœ‰æ˜¾ç¤ºï¼Œå› ä¸ºè¿™äº›é€æ˜æè´¨æ²¡æœ‰å¼€å¯æ·±åº¦å†™å…¥ï¼Œåœ¨RenderSkyBoxæ—¶åƒç´ å€¼è¢«è¦†ç›–äº†</p><img src="/2024/07/25/Unity-SRP-01-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AE%A1%E7%BA%BF/image-20240726205350966.png" alt="image-20240726205350966" style="zoom:50%;"><img src="/2024/07/25/Unity-SRP-01-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AE%A1%E7%BA%BF/image-20240726205433116.png" alt="image-20240726205433116" style="zoom:50%;"><h3 id="åˆ†åˆ«ç»˜åˆ¶é€æ˜å’Œä¸é€æ˜å‡ ä½•å›¾å½¢"><a href="#åˆ†åˆ«ç»˜åˆ¶é€æ˜å’Œä¸é€æ˜å‡ ä½•å›¾å½¢" class="headerlink" title="åˆ†åˆ«ç»˜åˆ¶é€æ˜å’Œä¸é€æ˜å‡ ä½•å›¾å½¢"></a>åˆ†åˆ«ç»˜åˆ¶é€æ˜å’Œä¸é€æ˜å‡ ä½•å›¾å½¢</h3><p>è§£å†³æ–¹æ¡ˆæ˜¯å…ˆç»˜åˆ¶ä¸é€æ˜å¯¹è±¡ï¼Œç„¶åç»˜åˆ¶å¤©ç©ºç›’ï¼Œç„¶åå†ç»˜åˆ¶é€æ˜å¯¹è±¡ã€‚</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DrawVisibleGeometry</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> sortingSettings = <span class="keyword">new</span> SortingSettings(camera)</span><br><span class="line">    &#123;</span><br><span class="line">        criteria = SortingCriteria.CommonOpaque</span><br><span class="line">&#125;;</span><br><span class="line">    <span class="keyword">var</span> drawingSettings = <span class="keyword">new</span> DrawingSettings(unlitShaderTagId, sortingSettings);</span><br><span class="line">    <span class="keyword">var</span> filteringSettings = <span class="keyword">new</span> FilteringSettings(RenderQueueRange.all);</span><br><span class="line"></span><br><span class="line">    context.DrawRenderers(</span><br><span class="line">        cullingResults, <span class="keyword">ref</span> drawingSettings, <span class="keyword">ref</span> filteringSettings</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    context.DrawSkybox(camera);</span><br><span class="line"></span><br><span class="line">    sortingSettings.criteria = SortingCriteria.CommonTransparent;</span><br><span class="line">    drawingSettings.sortingSettings = sortingSettings;</span><br><span class="line">    filteringSettings.renderQueueRange = RenderQueueRange.transparent;</span><br><span class="line"></span><br><span class="line">    context.DrawRenderers(</span><br><span class="line">        cullingResults, <span class="keyword">ref</span> drawingSettings, <span class="keyword">ref</span> filteringSettings</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Frame Debuggerçª—å£ç»˜åˆ¶ç»“æœ</p><p><img src="/2024/07/25/Unity-SRP-01-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AE%A1%E7%BA%BF/image-20240726210055545.png" alt="image-20240726210055545"></p><h2 id="ç¼–è¾‘å™¨æ¸²æŸ“"><a href="#ç¼–è¾‘å™¨æ¸²æŸ“" class="headerlink" title="ç¼–è¾‘å™¨æ¸²æŸ“"></a>ç¼–è¾‘å™¨æ¸²æŸ“</h2><h3 id="ç»˜åˆ¶ä¼ ç»Ÿç€è‰²å™¨"><a href="#ç»˜åˆ¶ä¼ ç»Ÿç€è‰²å™¨" class="headerlink" title="ç»˜åˆ¶ä¼ ç»Ÿç€è‰²å™¨"></a>ç»˜åˆ¶ä¼ ç»Ÿç€è‰²å™¨</h3><p>æˆ‘ä»¬å¦‚ä¸‹è®¾ç½®ï¼Œè¦†ç›–æ‰€æœ‰ Unity çš„é»˜è®¤ç€è‰²å™¨</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">static</span> ShaderTagId[] legacyShaderTagIds = &#123;</span><br><span class="line">    <span class="keyword">new</span> ShaderTagId(<span class="string">&quot;Always&quot;</span>),</span><br><span class="line">    <span class="keyword">new</span> ShaderTagId(<span class="string">&quot;ForwardBase&quot;</span>),</span><br><span class="line">    <span class="keyword">new</span> ShaderTagId(<span class="string">&quot;PrepassBase&quot;</span>),</span><br><span class="line">    <span class="keyword">new</span> ShaderTagId(<span class="string">&quot;Vertex&quot;</span>),</span><br><span class="line">    <span class="keyword">new</span> ShaderTagId(<span class="string">&quot;VertexLMRGBM&quot;</span>),</span><br><span class="line">    <span class="keyword">new</span> ShaderTagId(<span class="string">&quot;VertexLM&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Render</span> (<span class="params">ScriptableRenderContext context, Camera camera</span>)</span> &#123;</span><br><span class="line">â€¦</span><br><span class="line"></span><br><span class="line">Setup();</span><br><span class="line">DrawVisibleGeometry();</span><br><span class="line">DrawUnsupportedShaders();</span><br><span class="line">Submit();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DrawUnsupportedShaders</span> ()</span> &#123;</span><br><span class="line"><span class="keyword">var</span> drawingSettings = <span class="keyword">new</span> DrawingSettings(</span><br><span class="line">legacyShaderTagIds[<span class="number">0</span>], <span class="keyword">new</span> SortingSettings(camera)</span><br><span class="line">);</span><br><span class="line">        <span class="comment">//ç¬¬2ä¸ªå¼€å§‹ä½¿ç”¨SetShaderPassNameä¼ é€’</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">1</span>; i &lt; legacyShaderTagIds.Length; i++) &#123;</span><br><span class="line">drawingSettings.SetShaderPassName(i, legacyShaderTagIds[i]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> filteringSettings = FilteringSettings.defaultValue;</span><br><span class="line">context.DrawRenderers(</span><br><span class="line">cullingResults, <span class="keyword">ref</span> drawingSettings, <span class="keyword">ref</span> filteringSettings</span><br><span class="line">);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2024/07/25/Unity-SRP-01-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AE%A1%E7%BA%BF/image-20240726215013061.png" alt="image-20240726215013061"></p><h3 id="é”™è¯¯ææ–™"><a href="#é”™è¯¯ææ–™" class="headerlink" title="é”™è¯¯ææ–™"></a>é”™è¯¯ææ–™</h3><p>ä¸ºäº†æ¸…æ¥šåœ°æŒ‡ç¤ºå“ªäº›å¯¹è±¡ä½¿ç”¨ä¸å—æ”¯æŒçš„ç€è‰²å™¨ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Unity çš„é”™è¯¯ç€è‰²å™¨ç»˜åˆ¶å®ƒä»¬ã€‚</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DrawUnsupportedShaders</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (errorMaterial == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        errorMaterial =</span><br><span class="line">            <span class="keyword">new</span> Material(Shader.Find(<span class="string">&quot;Hidden/InternalErrorShader&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> drawingSettings = <span class="keyword">new</span> DrawingSettings(</span><br><span class="line">        legacyShaderTagIds[<span class="number">0</span>], <span class="keyword">new</span> SortingSettings(camera)</span><br><span class="line">    )</span><br><span class="line">    &#123;</span><br><span class="line">        overrideMaterial = errorMaterial</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2024/07/25/Unity-SRP-01-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AE%A1%E7%BA%BF/image-20240726215926396.png" alt="image-20240726215926396"></p><h3 id="ç»˜åˆ¶å°å·¥å…·"><a href="#ç»˜åˆ¶å°å·¥å…·" class="headerlink" title="ç»˜åˆ¶å°å·¥å…·"></a>ç»˜åˆ¶å°å·¥å…·</h3><p>Gizmosåº”è¯¥åœ¨å…¶ä»–æ‰€æœ‰å†…å®¹ä¹‹åç»˜åˆ¶</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DrawGizmos</span> ()</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (Handles.ShouldRenderGizmos()) &#123;</span><br><span class="line">context.DrawGizmos(camera, GizmoSubset.PreImageEffects);</span><br><span class="line">context.DrawGizmos(camera, GizmoSubset.PostImageEffects);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Render</span> (<span class="params">ScriptableRenderContext context, Camera camera</span>)</span> &#123;</span><br><span class="line">â€¦</span><br><span class="line"></span><br><span class="line">Setup();</span><br><span class="line">DrawVisibleGeometry();</span><br><span class="line">DrawUnsupportedShaders();</span><br><span class="line">DrawGizmos();</span><br><span class="line">Submit();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/2024/07/25/Unity-SRP-01-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AE%A1%E7%BA%BF/image-20240726221445569.png" alt="image-20240726221445569"></p><h3 id="ç»˜åˆ¶UI"><a href="#ç»˜åˆ¶UI" class="headerlink" title="ç»˜åˆ¶UI"></a>ç»˜åˆ¶UI</h3><p>å¸§è°ƒè¯•å™¨å‘æˆ‘ä»¬å±•ç¤ºäº† UI æ˜¯å•ç‹¬å‘ˆç°çš„ï¼Œè€Œä¸æ˜¯ç”± RP å‘ˆç°çš„ã€‚</p><p><img src="/2024/07/25/Unity-SRP-01-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AE%A1%E7%BA%BF/image-20240726221644570.png" alt="image-20240726221644570"></p><p>æˆ‘ä»¬å°†Canvasç»„ä»¶è®¾ç½®ä»RenderModeï¼ŒScreen Space - Overlayã€æ‰€æœ‰å›¾å±‚æœ€ä¸Šå±‚ã€‘å˜æ¢åˆ°Screen Space - Cameraï¼Œå¹¶å°†å…¶æ›´æ”¹ä¸ºä¸»æ‘„åƒå¤´å¹¶ä½¿ç”¨ä¸»æ‘„åƒå¤´ä½œä¸ºä¸»æ‘„åƒå¤´ï¼Œå°†ä½¿å…¶æˆä¸ºé€æ˜å‡ ä½•ä½“çš„ä¸€éƒ¨åˆ†ã€‚</p><img src="/2024/07/25/Unity-SRP-01-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AE%A1%E7%BA%BF/image-20240726225812383.png" alt="image-20240726225812383" style="zoom:50%;"><p>å¦‚æœæƒ³è¦UIæ˜¾ç¤ºåœ¨åœºæ™¯çª—å£ä¸­ï¼Œå°±éœ€è¦å°†UIæ˜¾ç¤ºæ·»åŠ åˆ°ä¸–ç•Œå‡ ä½•ä½“ä¸­ã€‚</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PrepareForSceneWindow</span> ()</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (camera.cameraType == CameraType.SceneView) &#123;</span><br><span class="line">ScriptableRenderContext.EmitWorldGeometryForSceneView(camera);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å› ä¸ºå¯èƒ½ä¼šå‘åœºæ™¯æ·»åŠ å‡ ä½•å›¾å½¢ï¼Œå› æ­¤å¿…é¡»åœ¨å‰”é™¤ä¹‹å‰å®Œæˆã€‚</span></span><br><span class="line">   PrepareForSceneWindow();</span><br><span class="line"><span class="keyword">if</span> (!Cull()) &#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/2024/07/25/Unity-SRP-01-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%AE%A1%E7%BA%BF/image-20240726230354448.png" alt="image-20240726230354448"></p><hr><p><strong>å‚è€ƒæ–‡ç« </strong></p><p><a href="https://catlikecoding.com/unity/tutorials/custom-srp/custom-render-pipeline/">è‡ªå®šä¹‰æ¸²æŸ“ç®¡çº¿ (catlikecoding.com)</a></p><p><a href="https://zhuanlan.zhihu.com/p/165140042">Unityå¯ç¼–ç¨‹æ¸²æŸ“ç®¡çº¿ï¼ˆSRPï¼‰ç³»åˆ—ï¼ˆä¸€ï¼‰â€”â€”è‡ªå®šä¹‰ç®¡çº¿ï¼ˆæ§åˆ¶æ¸²æŸ“ï¼‰ - çŸ¥ä¹ (zhihu.com)</a></p>]]></content>
      
      
      <categories>
          
          <category> Unity SRP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¸¸æˆæ¸²æŸ“ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æˆ‘ä»¬çš„æ•…äº‹ï¼Œæ‰æ­£è¦å¼€å§‹</title>
      <link href="/2024/07/25/Start/"/>
      <url>/2024/07/25/Start/</url>
      
        <content type="html"><![CDATA[<h1 id="æˆ‘ä»¬çš„æ•…äº‹ï¼Œæ‰æ­£è¦å¼€å§‹"><a href="#æˆ‘ä»¬çš„æ•…äº‹ï¼Œæ‰æ­£è¦å¼€å§‹" class="headerlink" title="æˆ‘ä»¬çš„æ•…äº‹ï¼Œæ‰æ­£è¦å¼€å§‹"></a>æˆ‘ä»¬çš„æ•…äº‹ï¼Œæ‰æ­£è¦å¼€å§‹</h1><hr><p>æ•…äº‹ä»20å¹´å¤å¤©çš„é£å¹èµ·ï¼Œæˆ‘ç”¨å››å¹´çš„æ—¶å…‰èµ°å®Œäº†æ•…äº‹åºç« ï¼Œä¸€è·¯ä¸Šæˆ‘åšäº†å¾ˆå¤šè‡ªå·±æƒ³åšçš„äº‹æƒ…ï¼Œä¸€åˆ‡éƒ½å¬å‡­æœ¬å¿ƒã€‚</p><p>å†…å¿ƒæ¸´æœ›å»æ¢ç´¢æ–°çŸ¥è¯†çš„åŒæ—¶ï¼Œå´åˆè¿·èŒ«ç€ï¼Œé¡¾è™‘ç€æœªæ¥ã€‚</p><p>ç”µå­ç´ã€å”±æ­Œã€æ‘„å½±ã€å¡”ç½—ã€è¿åŠ¨ã€æ—¥è¯­â€¦è¿™å››å¹´ï¼Œå„ç§äº‹æƒ…æˆ‘éƒ½å»å­¦ä¹ ä½“ä¼šï¼Œæˆ‘æƒ³æ›´å¤šçš„æ„Ÿå—ä¸–ç•Œï¼Œä½†æ˜¯æˆ‘ä¸å¯é¿å…çš„å‘ç°ï¼Œç•™ç»™æˆ‘çš„æ—¶é—´å¹¶ä¸æ˜¯é‚£ä¹ˆå……è£•ã€‚</p><p>åœ¨çµçŠ€äº’å¨±æ¸¸æˆå¼•æ“å²—å®ä¹ çš„æ—¥å­ï¼Œæˆ‘æ„ˆå‘è§‰å¾—è‡ªå·±éœ€è¦å°½æ—©å˜å¾—æˆç†Ÿå¯é ï¼Œä¸‰å¹´åæˆ‘å¸Œæœ›æˆä¸ºä¸€åç‹¬å½“ä¸€é¢çš„ç¨‹åºå‘˜ï¼Œæˆ‘å¸Œæœ›è‡ªå·±æ¯•ä¸šåè¿˜æ˜¯èƒ½åœ¨æ¸¸æˆè¡Œä¸šå·¥ä½œï¼Œè¿™ä¹Ÿæ˜¯å’Œâ€”â€”çš„çº¦å®šã€‚</p><p>å¼€è¿™ä¸ªåšå®¢ï¼Œå¸Œæœ›èƒ½ç£ä¿ƒè‡ªå·±å¥½å¥½çœ‹ä¹¦ï¼Œä¸è¦é¢“åºŸï¼Œåœ¨æ¥ä¸‹æ¥çš„ç ”ç©¶ç”Ÿç”Ÿæ¶¯ä¸­ï¼Œä¸ç•™é—æ†¾ï¼ŒæŠŠè‡ªå·±æƒ³åšçš„äº‹æƒ…å…¨éƒ½å®Œæˆã€‚</p><p>å¤§å­¦å››å¹´é‡Œï¼Œä»æ¸¸æˆå®¢æˆ·ç«¯å¼€å‘ã€æ¸¸æˆæ¸²æŸ“ã€æ¸¸æˆå¼•æ“å¼€å‘éƒ½æœ‰æ‰€å­¦ä¹ ï¼Œä¸è¿‡éƒ½æ˜¯ä¸€äº›åŸºç¡€çš„å­¦ä¹ è€Œå·²ï¼Œä¹‹ååšå®¢ä¼šå›´ç»•æ›´è¿›ä¸€æ­¥å­¦ä¹ å±•å¼€~</p><p>é‚£ä¹ˆæ•…äº‹çš„æ­£ç¯‡å°±ä»è¿™é‡Œå¼€å§‹å­~</p><img src="/2024/07/25/Start/image-20240813165007354.png" alt="image-20240813165007354" style="zoom:50%;">]]></content>
      
      
      <categories>
          
          <category> éšç¬” </category>
          
      </categories>
      
      
    </entry>
    
    
  
  
</search>
